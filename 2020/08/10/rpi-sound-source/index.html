<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>将树莓派用作声源 - 子实</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="子实"><meta name="msapplication-TileImage" content="/img/avatar-o.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="子实"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="使用pyzmq将树莓派上麦阵列采集的音频数据以numpy数组的格式发送出去"><meta property="og:type" content="article"><meta property="og:title" content="将树莓派用作声源"><meta property="og:url" content="https://zlotus.github.io/2020/08/10/rpi-sound-source/"><meta property="og:site_name" content="子实"><meta property="og:description" content="使用pyzmq将树莓派上麦阵列采集的音频数据以numpy数组的格式发送出去"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://zlotus.github.io/img/og_image.png"><meta property="article:published_time" content="2020-08-10T01:18:00.000Z"><meta property="article:modified_time" content="2020-07-31T01:18:00.000Z"><meta property="article:author" content="子实"><meta property="article:tag" content="Python"><meta property="article:tag" content="Linux"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><meta property="twitter:creator" content="@Zealot_uS"><meta property="twitter:site" content="Zealot_uS"><link rel="publisher" href="+LotusQin"><meta property="fb:admins" content="qinzishi"><meta property="fb:app_id" content="qinzishi"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zlotus.github.io/2020/08/10/rpi-sound-source/"},"headline":"将树莓派用作声源","image":["https://zlotus.github.io/img/og_image.png"],"datePublished":"2020-08-10T01:18:00.000Z","dateModified":"2020-07-31T01:18:00.000Z","author":{"@type":"Person","name":"子实"},"publisher":{"@type":"Organization","name":"子实","logo":{"@type":"ImageObject","url":"https://zlotus.github.io/img/opm_sq.png"}},"description":"使用pyzmq将树莓派上麦阵列采集的音频数据以numpy数组的格式发送出去"}</script><link rel="icon" href="/img/avatar-o.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><!--!--><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/opm_sq.png" alt="子实" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/2014/07/09/about-me/">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zlotus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-9-tablet is-9-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-08-10T01:18:00.000Z" title="8/10/2020, 9:18:00 AM">2020-08-10</time>发表</span><span class="level-item"><time dateTime="2020-07-31T01:18:00.000Z" title="7/31/2020, 9:18:00 AM">2020-07-31</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a></span><span class="level-item">24 分钟读完 (大约3622个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">将树莓派用作声源</h1><div class="content"><p>前一阵子跟刘老师聊天发现，不能总是灌10分低端水了，得进军20分中端水……就着树莓派上的麦阵列作为传感器信号源，送到mbp上做分析试试水先。</p>
<span id="more"></span>

<h1 id="1-硬件现状"><a href="#1-硬件现状" class="headerlink" title="1 硬件现状"></a>1 硬件现状</h1><h2 id="1-1-源端"><a href="#1-1-源端" class="headerlink" title="1.1 源端"></a>1.1 源端</h2><p>硬件：树莓派3B+一枚，还是老文章里麦阵列用的那枚；麦阵列还是<a target="_blank" rel="noopener" href="http://wiki.seeedstudio.com/ReSpeaker_6-Mic_Circular_Array_kit_for_Raspberry_Pi/">ReSpeaker-6mic阵列</a>。</p>
<p>系统：用buster-2020-05的版本，装麦阵列驱动有问题，报错：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">E: Unable to locate package dkms</span><br><span class="line">E: Package <span class="string">&#x27;libasound2-plugins&#x27;</span> has no installation candidate</span><br></pre></td></tr></table></figure>

<p>先换成旧的stretch……</p>
<p>刷了stretch，更新软件包update &amp; upgrade后貌似也会出问题……干脆：</p>
<ul>
<li>直接用<a target="_blank" rel="noopener" href="http://downloads.raspberrypi.org/raspbian/images/raspbian-2019-04-09/2019-04-08-raspbian-stretch.zip">旧版image(2019-04-09)</a>不升级；</li>
<li>手动安装旧版<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/raspberrypi/pool/main/r/raspberrypi-firmware/raspberrypi-kernel-headers_1.20190401-1_armhf.deb">kernel-headers(2019-04-01)</a>：<code>dpkg -i raspberrypi-kernel-headers_1.20190401-1_armhf.deb</code></li>
<li>将麦阵列驱动<code>git reset --hard</code>回溯到<a target="_blank" rel="noopener" href="https://github.com/respeaker/seeed-voicecard/blob/c7026a40487a6dc751c93d3d566a4e0b5fd93442/">2019年四月份的版本</a>，然后把<code>install.sh</code>里76-77行的升级和内核安装注释掉，再安装就好了。</li>
</ul>
<p>毕竟我记得去年四月的时候还能用……估计是新系统和驱动不匹配的锅……其中有用的操作：</p>
<ul>
<li>升级单个软件包<code>sudo apt-get --only-upgrade install apt</code>，全升级的话kernel和kernel-headers也会跟着升级；</li>
<li>用pyenv安装和管理Python版本：<a target="_blank" rel="noopener" href="https://installvirtual.com/install-python-3-8-1-on-raspberry-pi-raspbian/">Install Python 3.8.1 on Raspberry Pi (Raspbian)</a></li>
<li>树莓派时间同步：<a target="_blank" rel="noopener" href="https://raspberrytips.com/time-sync-raspberry-pi/">How to sync time with a server on Raspberry Pi?</a>（后来发现是mbp的时间总不同步：<code>sudo sntp -sS time.apple.com</code>）</li>
<li>重启shell的命令是<code>exec &quot;$SHELL&quot;</code>，装完zsh等重启shell会方便很多；</li>
</ul>
<h2 id="1-2-接收端"><a href="#1-2-接收端" class="headerlink" title="1.2 接收端"></a>1.2 接收端</h2><p>我那尚能饭否的mbp……</p>
<h1 id="2-使用PulseAudio进行流媒体传输"><a href="#2-使用PulseAudio进行流媒体传输" class="headerlink" title="2 使用PulseAudio进行流媒体传输"></a>2 使用PulseAudio进行流媒体传输</h1><h2 id="2-1-TCP（是不对的）"><a href="#2-1-TCP（是不对的）" class="headerlink" title="2.1 TCP（是不对的）"></a>2.1 TCP（是不对的）</h2><p>按照<a target="_blank" rel="noopener" href="https://wiki.seeedstudio.com/ReSpeaker_6-Mic_Circular_Array_kit_for_Raspberry_Pi/">ReSpeaker 6-Mic Circular Array kit for Raspberry Pi</a>的介绍，打算安装最常见的PulseAudio Server，据说可以方便的做流媒体数据源。</p>
<ul>
<li>修改PulseAudio远程配置，匿名网络访问：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/pulse/default.pa</span></span><br><span class="line">load-module module-native-protocol-tcp auth-ip-acl=127.0.0.1;10.0.6.0/24 auth-anonymous=1</span><br></pre></td></tr></table></figure>

<ul>
<li>开防火墙端口：<code>sudo ufw allow proto tcp to 0.0.0.0/0 port 4713 comment &quot;pulseaudio tcp port&quot;</code></li>
</ul>
<p>后来发现tcp访问pulseaudio的目的貌似是控制而不是传输流媒体数据……进一步才发现原来rtp是传输流媒体数据用的……</p>
<h2 id="2-2-RTP（也没搞定）"><a href="#2-2-RTP（也没搞定）" class="headerlink" title="2.2 RTP（也没搞定）"></a>2.2 RTP（也没搞定）</h2><p>一开始想得简单，以为直接默认配置就能搞定：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">load-module module-null-sink sink_name=rtp</span><br><span class="line">load-module module-rtp-send <span class="built_in">source</span>=rtp.monitor</span><br><span class="line">set-default-sink rtp</span><br></pre></td></tr></table></figure>

<p>此时并没有指定广播目的IP和端口，pulseaudio就默认用了<code>224.0.0.56</code>和一个随机五位端口号。出现的现象是：</p>
<ul>
<li>在树莓派上可以通过<code>tcpdump -n net 224.0.0.0/8 -c10</code>看到发包，类似：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IP 192.168.1.101.44556 &gt; 224.0.0.56.44668: UDP, length 1292</span><br></pre></td></tr></table></figure></li>
<li>我的连在同一个局域网中的mbp里<code>tcpdump</code>一直是空的。</li>
<li>不论rpi还是mbp的ping到<code>224.0.0.56</code>都是不通的。</li>
</ul>
<p>看了<a target="_blank" rel="noopener" href="https://unix.stackexchange.com/a/122645">Multicast UDP not working</a>后使用<code>netstat -gn</code>发现rpi和mbp的组播地址里都没有<code>224.0.0.56</code>，猜测可能是内核把包扔掉了，按照该文章的方法处理：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># macbookpro</span></span><br><span class="line">netstat -gn</span><br><span class="line">IPv4 Multicast Group Memberships</span><br><span class="line">Group                   Link-layer Address      Netif</span><br><span class="line">224.0.0.1               1:0:5e:0:0:1            en0</span><br><span class="line">224.0.0.251             1:0:5e:0:0:fb           en0</span><br><span class="line"></span><br><span class="line"><span class="comment"># raspberrypi</span></span><br><span class="line"> netstat -gn</span><br><span class="line">IPv6/IPv4 Group Memberships</span><br><span class="line">Interface       RefCnt Group</span><br><span class="line">--------------- ------ ---------------------</span><br><span class="line">wlan0           1      224.0.0.251</span><br><span class="line">wlan0           1      224.0.0.1</span><br></pre></td></tr></table></figure>

<p>ping了一下组播组里出现的<code>224.0.0.1</code>和<code>224.0.0.251</code>发现是通的。本来想按照<a target="_blank" rel="noopener" href="https://superuser.com/questions/324824/linux-built-in-or-open-source-program-to-join-multicast-group">Linux built-in or open source program to join multicast group?</a>写的把<code>224.0.0.56</code>加入两个机器的组播组里，结果rpi试了不行（命令执行成功，但是用<code>netstat</code>或<code>ip maddr show</code>检查都没法写新加的组播地址），而mbp根本没有<code>ip</code>这个命令，我又不太懂iptable这种高端货，天色已晚我也懒得查解决方案了……干脆就着现有组播组里的<code>224.0.0.251</code>用吧：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">load-module module-null-sink sink_name=rtp</span><br><span class="line">load-module module-rtp-send <span class="built_in">source</span>=rtp.monitor destination_ip=<span class="string">&quot;224.0.0.251&quot;</span> port=45678</span><br><span class="line">set-default-sink rtp</span><br></pre></td></tr></table></figure>

<p>此时出现新问题，在mbp上tcpdump已经能看到rpi不停的发包，但是用<code>tcpdump -n net 224.0.0.0/8 -c1 -X</code>查看包内容时，发现内容全零，pulseaudio的配置文件怎么改都不行（就rtp相关的几个模块配置参数怎么调都没用），用<code>pulseaudio -v</code>调试模式启动，也看不太懂，遂早早放弃有（后）空（会）在（无）搞（期）……</p>
<h2 id="2-3-小结：战略失败"><a href="#2-3-小结：战略失败" class="headerlink" title="2.3 小结：战略失败"></a>2.3 小结：战略失败</h2><p>当需求很简单时，用别人的软件，有学习如何配置的功夫，还不如自己写个小程序实现功能呢……</p>
<h1 id="3-使用python-sounddevice采集-播放音频流"><a href="#3-使用python-sounddevice采集-播放音频流" class="headerlink" title="3 使用python-sounddevice采集/播放音频流"></a>3 使用python-sounddevice采集/播放音频流</h1><p>整理一下思路，目的其实很明确，就是将麦阵列采集的数据通过网络传出去。搜了下，用python的sounddevice（以下简称sd）貌似就可以采集/写入音频流，至于如何发送，想了想就用以前用过的pyzmq吧（高速低延时高可拓展）。</p>
<p>sd的流有两种封装，Stream需要numpy，而RawStream更底层，使用的是buffer。虽然看源码Stream版本是在Raw版本之上做的封装，但是并没感觉慢多少，试用zmq发包的时候，rpi的那颗弱鸡CPU一直在7-9%浮动，完全hold住，那就用numpy输出吧，操作起来会方便很多。</p>
<p>（这次树莓派上的python版本控制选用了<code>pyenv</code>，装的python3.8.5）</p>
<h2 id="3-1-采集音频数据"><a href="#3-1-采集音频数据" class="headerlink" title="3.1 采集音频数据"></a>3.1 采集音频数据</h2><p>使用<code>sd.query_devices()</code>在rpi上查询音频设备：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  0 bcm2835 ALSA: - (hw:0,0), ALSA (0 <span class="keyword">in</span>, 2 out)</span><br><span class="line">  1 bcm2835 ALSA: IEC958/HDMI (hw:0,1), ALSA (0 <span class="keyword">in</span>, 2 out)</span><br><span class="line">  2 seeed-8mic-voicecard: - (hw:1,0), ALSA (8 <span class="keyword">in</span>, 8 out)</span><br><span class="line">  3 sysdefault, ALSA (0 <span class="keyword">in</span>, 128 out)</span><br><span class="line">  4 ac108, ALSA (128 <span class="keyword">in</span>, 128 out)</span><br><span class="line">  5 dmixer, ALSA (0 <span class="keyword">in</span>, 128 out)</span><br><span class="line">  6 ac101, ALSA (128 <span class="keyword">in</span>, 128 out)</span><br><span class="line">  7 dmix, ALSA (0 <span class="keyword">in</span>, 2 out)</span><br><span class="line">* 8 default, ALSA (32 <span class="keyword">in</span>, 32 out)</span><br><span class="line"></span><br><span class="line">0 &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;bcm2835 ALSA: - (hw:0,0)&#x27;</span>, <span class="string">&#x27;hostapi&#x27;</span>: 0, <span class="string">&#x27;max_input_channels&#x27;</span>: 0, <span class="string">&#x27;max_output_channels&#x27;</span>: 2, <span class="string">&#x27;default_low_input_latency&#x27;</span>: -1.0, <span class="string">&#x27;default_low_output_latency&#x27;</span>: 0.005804988662131519, <span class="string">&#x27;default_high_input_latency&#x27;</span>: -1.0, <span class="string">&#x27;default_high_output_latency&#x27;</span>: 0.034829931972789115, <span class="string">&#x27;default_samplerate&#x27;</span>: 44100.0&#125;</span><br><span class="line">1 &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;bcm2835 ALSA: IEC958/HDMI (hw:0,1)&#x27;</span>, <span class="string">&#x27;hostapi&#x27;</span>: 0, <span class="string">&#x27;max_input_channels&#x27;</span>: 0, <span class="string">&#x27;max_output_channels&#x27;</span>: 2, <span class="string">&#x27;default_low_input_latency&#x27;</span>: -1.0, <span class="string">&#x27;default_low_output_latency&#x27;</span>: 0.005804988662131519, <span class="string">&#x27;default_high_input_latency&#x27;</span>: -1.0, <span class="string">&#x27;default_high_output_latency&#x27;</span>: 0.034829931972789115, <span class="string">&#x27;default_samplerate&#x27;</span>: 44100.0&#125;</span><br><span class="line">2 &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;seeed-8mic-voicecard: - (hw:1,0)&#x27;</span>, <span class="string">&#x27;hostapi&#x27;</span>: 0, <span class="string">&#x27;max_input_channels&#x27;</span>: 8, <span class="string">&#x27;max_output_channels&#x27;</span>: 8, <span class="string">&#x27;default_low_input_latency&#x27;</span>: 0.005804988662131519, <span class="string">&#x27;default_low_output_latency&#x27;</span>: 0.008707482993197279, <span class="string">&#x27;default_high_input_latency&#x27;</span>: 0.034829931972789115, <span class="string">&#x27;default_high_output_latency&#x27;</span>: 0.034829931972789115, <span class="string">&#x27;default_samplerate&#x27;</span>: 44100.0&#125;</span><br><span class="line">3 &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;sysdefault&#x27;</span>, <span class="string">&#x27;hostapi&#x27;</span>: 0, <span class="string">&#x27;max_input_channels&#x27;</span>: 0, <span class="string">&#x27;max_output_channels&#x27;</span>: 128, <span class="string">&#x27;default_low_input_latency&#x27;</span>: -1.0, <span class="string">&#x27;default_low_output_latency&#x27;</span>: 0.005804988662131519, <span class="string">&#x27;default_high_input_latency&#x27;</span>: -1.0, <span class="string">&#x27;default_high_output_latency&#x27;</span>: 0.034829931972789115, <span class="string">&#x27;default_samplerate&#x27;</span>: 44100.0&#125;</span><br><span class="line">4 &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;ac108&#x27;</span>, <span class="string">&#x27;hostapi&#x27;</span>: 0, <span class="string">&#x27;max_input_channels&#x27;</span>: 128, <span class="string">&#x27;max_output_channels&#x27;</span>: 128, <span class="string">&#x27;default_low_input_latency&#x27;</span>: 0.005333333333333333, <span class="string">&#x27;default_low_output_latency&#x27;</span>: 0.008, <span class="string">&#x27;default_high_input_latency&#x27;</span>: 0.032, <span class="string">&#x27;default_high_output_latency&#x27;</span>: 0.032, <span class="string">&#x27;default_samplerate&#x27;</span>: 48000.0&#125;</span><br><span class="line">5 &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dmixer&#x27;</span>, <span class="string">&#x27;hostapi&#x27;</span>: 0, <span class="string">&#x27;max_input_channels&#x27;</span>: 0, <span class="string">&#x27;max_output_channels&#x27;</span>: 128, <span class="string">&#x27;default_low_input_latency&#x27;</span>: -1.0, <span class="string">&#x27;default_low_output_latency&#x27;</span>: 0.125, <span class="string">&#x27;default_high_input_latency&#x27;</span>: -1.0, <span class="string">&#x27;default_high_output_latency&#x27;</span>: 0.125, <span class="string">&#x27;default_samplerate&#x27;</span>: 48000.0&#125;</span><br><span class="line">6 &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;ac101&#x27;</span>, <span class="string">&#x27;hostapi&#x27;</span>: 0, <span class="string">&#x27;max_input_channels&#x27;</span>: 128, <span class="string">&#x27;max_output_channels&#x27;</span>: 128, <span class="string">&#x27;default_low_input_latency&#x27;</span>: 0.005333333333333333, <span class="string">&#x27;default_low_output_latency&#x27;</span>: 0.008, <span class="string">&#x27;default_high_input_latency&#x27;</span>: 0.032, <span class="string">&#x27;default_high_output_latency&#x27;</span>: 0.032, <span class="string">&#x27;default_samplerate&#x27;</span>: 48000.0&#125;</span><br><span class="line">7 &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dmix&#x27;</span>, <span class="string">&#x27;hostapi&#x27;</span>: 0, <span class="string">&#x27;max_input_channels&#x27;</span>: 0, <span class="string">&#x27;max_output_channels&#x27;</span>: 2, <span class="string">&#x27;default_low_input_latency&#x27;</span>: -1.0, <span class="string">&#x27;default_low_output_latency&#x27;</span>: 0.021333333333333333, <span class="string">&#x27;default_high_input_latency&#x27;</span>: -1.0, <span class="string">&#x27;default_high_output_latency&#x27;</span>: 0.021333333333333333, <span class="string">&#x27;default_samplerate&#x27;</span>: 48000.0&#125;</span><br><span class="line">8 &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;default&#x27;</span>, <span class="string">&#x27;hostapi&#x27;</span>: 0, <span class="string">&#x27;max_input_channels&#x27;</span>: 32, <span class="string">&#x27;max_output_channels&#x27;</span>: 32, <span class="string">&#x27;default_low_input_latency&#x27;</span>: 0.008707482993197279, <span class="string">&#x27;default_low_output_latency&#x27;</span>: 0.008707482993197279, <span class="string">&#x27;default_high_input_latency&#x27;</span>: 0.034829931972789115, <span class="string">&#x27;default_high_output_latency&#x27;</span>: 0.034829931972789115, <span class="string">&#x27;default_samplerate&#x27;</span>: 44100.0&#125;</span><br></pre></td></tr></table></figure>

<p>其中的<code>seeed-8mic-voicecard</code>是我们需要的输入设备，8路输入（2×AC108 ADC，每芯片4路输出，而每芯片都有一路是playback，因此实际是2*3=6mic信号）。为了方便rpi本地测试，AC101（1×DAC，2输入2输出，我觉得就是左右声道？）要用作输出设备。sd的流要用id指定输入输出设备（也就是上面的<code>[2, 6]</code>）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iodevs = [<span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"><span class="keyword">for</span> idx, d <span class="keyword">in</span> <span class="built_in">enumerate</span>(sd.query_devices()):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;seeed-8mic-voicecard&#x27;</span> <span class="keyword">in</span> d[<span class="string">&#x27;name&#x27;</span>]:</span><br><span class="line">        iodevs[<span class="number">0</span>] = idx</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&#x27;ac101&#x27;</span> <span class="keyword">in</span> d[<span class="string">&#x27;name&#x27;</span>]:</span><br><span class="line">        iodevs[<span class="number">1</span>] = idx</span><br><span class="line">rs = sd.Stream(samplerate=<span class="number">48000</span>, device=iodevs, channels=[<span class="number">8</span>, <span class="number">2</span>], callback=cb, finished_callback=fcb)</span><br></pre></td></tr></table></figure>

<p>流有两种发送方式：阻塞 和 非阻塞回调，为了方便调试，我用了非阻塞回调的方式（即<code>Stream.start()</code>后立即返回不耽误监控或执行其他命令）。</p>
<p><code>sd.Stream</code>一旦指定了<code>callback</code>参数就会使用非阻塞模式运行，其函数签名：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">callback(indata: ndarray, outdata: ndarray, frames: <span class="built_in">int</span>, time: CData, status: CallbackFlags) -&gt; <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>indata</code>是输入设备传来的数据，我用的48kHz采样率，每次回调传来的都是<code>(512, 8)</code>的numpy数组，基本上10毫秒一组数据；</li>
<li><code>outdata</code>是传给输出设备的数据，我的输入输出配置是<code>[8, 2]</code>，因此不能直接把<code>indata</code>复制给输出，图省事我就前后四个数分别求<code>mean</code>，把8个数强行压成两个数；</li>
<li><code>frames</code>是帧数，我这里每次都是512；</li>
<li><code>time</code>是一个CFFI的C结构体，能用的属性有<code>time.inputBufferAdcTime</code>（输入开始时间）、<code>time.outputBufferDacTime</code>（输出开始的时间）、<code>time.currentTime</code>（本次callback被调用的时间）。</li>
<li><code>status</code>没用过不知道，看起来可以用来在回调里发送指令终止回调或终止流。</li>
</ul>
<p>一旦完成输入数据到输出数据的复制，插在AC101上的音响就有声音了，能感觉到很微小的延迟，完全够用了。</p>
<p>最后就剩在回调里写上pyzmq的发送，如此发送端就完成了。这里有个小问题，就是pyzmq直接发送numpy是不行滴，直接发送的话代码虽然可以运行，但zmq会使用Python的<code>memoryview</code>直接将numpy数组转换为字节发出去。如此一来，在接收端是无法重建数组的，因为丢失了shape和dtype等元数据。按照<a target="_blank" rel="noopener" href="https://pyzmq.readthedocs.io/en/latest/serialization.html">官方解决方案</a>，使用多段发送标识<code>SNDMORE</code>先发送数组属性，在发送数组内容即可在接收端重建数组了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_array</span>(<span class="params">socket, A, flags=<span class="number">0</span>, copy=<span class="literal">True</span>, track=<span class="literal">False</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;send a numpy array with metadata&quot;&quot;&quot;</span></span><br><span class="line">    md = <span class="built_in">dict</span>(</span><br><span class="line">        dtype = <span class="built_in">str</span>(A.dtype),</span><br><span class="line">        shape = A.shape,</span><br><span class="line">    )</span><br><span class="line">    socket.send_json(md, flags|zmq.SNDMORE)</span><br><span class="line">    <span class="keyword">return</span> socket.send(A, flags, copy=copy, track=track)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recv_array</span>(<span class="params">socket, flags=<span class="number">0</span>, copy=<span class="literal">True</span>, track=<span class="literal">False</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;recv a numpy array&quot;&quot;&quot;</span></span><br><span class="line">    md = socket.recv_json(flags=flags)</span><br><span class="line">    msg = socket.recv(flags=flags, copy=copy, track=track)</span><br><span class="line">    buf = <span class="built_in">memoryview</span>(msg)</span><br><span class="line">    A = numpy.frombuffer(buf, dtype=md[<span class="string">&#x27;dtype&#x27;</span>])</span><br><span class="line">    <span class="keyword">return</span> A.reshape(md[<span class="string">&#x27;shape&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>发送端代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sounddevice</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> zmq</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SdSender</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, host=<span class="string">&#x27;*&#x27;</span>, port=<span class="number">9000</span></span>):</span></span><br><span class="line">        self.__frame_idx = <span class="number">0</span></span><br><span class="line">        self.__frame_time = <span class="number">0</span></span><br><span class="line">        self.__device = self.__init_device()</span><br><span class="line"></span><br><span class="line">        context = zmq.Context()</span><br><span class="line">        self.__zmq_socket = context.socket(zmq.PUB)</span><br><span class="line">        self.__zmq_socket.bind(<span class="string">f&quot;tcp://<span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.__verbose = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init_device</span>(<span class="params">self</span>):</span></span><br><span class="line">        iodevs = [<span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">        <span class="keyword">for</span> idx, d <span class="keyword">in</span> <span class="built_in">enumerate</span>(sounddevice.query_devices()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;seeed-8mic-voicecard&#x27;</span> <span class="keyword">in</span> d[<span class="string">&#x27;name&#x27;</span>]:</span><br><span class="line">                iodevs[<span class="number">0</span>] = idx</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;ac101&#x27;</span> <span class="keyword">in</span> d[<span class="string">&#x27;name&#x27;</span>]:</span><br><span class="line">                iodevs[<span class="number">1</span>] = idx</span><br><span class="line">        <span class="keyword">return</span> iodevs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_array</span>(<span class="params">self, A, ct, flags=<span class="number">0</span>, copy=<span class="literal">True</span>, track=<span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;send a numpy array with metadata&quot;&quot;&quot;</span></span><br><span class="line">        self.__frame_idx += <span class="number">1</span></span><br><span class="line">        md = <span class="built_in">dict</span>(</span><br><span class="line">            frame_idx = self.__frame_idx,</span><br><span class="line">            tf = ct,</span><br><span class="line">            dtype = <span class="built_in">str</span>(A.dtype),</span><br><span class="line">            shape = A.shape,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> self.__verbose:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;\r<span class="subst">&#123;md[<span class="string">&quot;self.__frame_idx&quot;</span>]&#125;</span>&#x27;</span>, end=<span class="string">&quot;&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">        self.__zmq_socket.send_json(md, flags|zmq.SNDMORE)</span><br><span class="line">        <span class="keyword">return</span> self.__zmq_socket.send(A, flags, copy=copy, track=track)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cb</span>(<span class="params">self, indata, outdata, frames, time, status</span>):</span></span><br><span class="line">        <span class="comment"># 六声道强行用平均数合成双声道(512, 8) -&gt; (512, 2)，让rpi本机也输出声音方便调试</span></span><br><span class="line">        outdata[:] = np.hstack( (np.mean(indata[:, <span class="number">0</span>:<span class="number">4</span>], axis=<span class="number">1</span>, keepdims=<span class="literal">True</span>),</span><br><span class="line">                                np.mean(indata[:, <span class="number">4</span>:<span class="number">8</span>], axis=<span class="number">1</span>, keepdims=<span class="literal">True</span>)) )</span><br><span class="line">        <span class="comment"># 发送音频原始8路数据</span></span><br><span class="line">        self.send_array(indata, time.currentTime)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fcb</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;finished!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, verbose=<span class="literal">False</span></span>):</span></span><br><span class="line">        self.__verbose = verbose</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> sounddevice.Stream(samplerate=<span class="number">48000</span>, device=self.__device, channels=[<span class="number">8</span>, <span class="number">2</span>],</span><br><span class="line">                                    callback=self.cb, finished_callback=self.fcb) <span class="keyword">as</span> rs:</span><br><span class="line">                <span class="built_in">input</span>()</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt <span class="keyword">as</span> ki:</span><br><span class="line">            self.__zmq_socket.close()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;exit!&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> Exception</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    sd = SdSender()</span><br><span class="line">    sd.run(verbose=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h2 id="3-2-接收音频数据"><a href="#3-2-接收音频数据" class="headerlink" title="3.2 接收音频数据"></a>3.2 接收音频数据</h2><p>使用<code>sd.query_devices()</code>在mbp上查询音频设备，可以看到mbp就1-in-1-out，都是双通道，很朴实（我修改了mbp的midi音频设置，将采样率从默认的44100该为48000，输出44100的话，播放48000的数据明显会…慢…）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; 0 Built-in Microphone, Core Audio (2 <span class="keyword">in</span>, 0 out)</span><br><span class="line">&lt; 1 Built-in Output, Core Audio (0 <span class="keyword">in</span>, 2 out)</span><br><span class="line"></span><br><span class="line">0 &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Built-in Microphone&#x27;</span>, <span class="string">&#x27;hostapi&#x27;</span>: 0, <span class="string">&#x27;max_input_channels&#x27;</span>: 2, <span class="string">&#x27;max_output_channels&#x27;</span>: 0, <span class="string">&#x27;default_low_input_latency&#x27;</span>: 0.0027708333333333335, <span class="string">&#x27;default_low_output_latency&#x27;</span>: 0.01, <span class="string">&#x27;default_high_input_latency&#x27;</span>: 0.012104166666666666, <span class="string">&#x27;default_high_output_latency&#x27;</span>: 0.1, <span class="string">&#x27;default_samplerate&#x27;</span>: 48000.0&#125;</span><br><span class="line">1 &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Built-in Output&#x27;</span>, <span class="string">&#x27;hostapi&#x27;</span>: 0, <span class="string">&#x27;max_input_channels&#x27;</span>: 0, <span class="string">&#x27;max_output_channels&#x27;</span>: 2, <span class="string">&#x27;default_low_input_latency&#x27;</span>: 0.01, <span class="string">&#x27;default_low_output_latency&#x27;</span>: 0.012291666666666666, <span class="string">&#x27;default_high_input_latency&#x27;</span>: 0.1, <span class="string">&#x27;default_high_output_latency&#x27;</span>: 0.021625, <span class="string">&#x27;default_samplerate&#x27;</span>: 48000.0&#125;</span><br></pre></td></tr></table></figure>

<p>接收端代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sounddevice</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> zmq</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SdReceiver</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, host=<span class="string">&#x27;10.0.6.223&#x27;</span>, port=<span class="number">9000</span></span>):</span></span><br><span class="line">        self.__device = self.__init_device()</span><br><span class="line"></span><br><span class="line">        context = zmq.Context()</span><br><span class="line">        self.__zmq_socket = context.socket(zmq.SUB)</span><br><span class="line">        self.__zmq_socket.connect(<span class="string">f&quot;tcp://<span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>&quot;</span>)</span><br><span class="line">        self.__zmq_socket.setsockopt_string(zmq.SUBSCRIBE, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.__verbose = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init_device</span>(<span class="params">self</span>):</span></span><br><span class="line">        iodevs = [<span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">        <span class="keyword">for</span> idx, d <span class="keyword">in</span> <span class="built_in">enumerate</span>(sounddevice.query_devices()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;Built-in Microphone&#x27;</span> <span class="keyword">in</span> d[<span class="string">&#x27;name&#x27;</span>]:</span><br><span class="line">                iodevs[<span class="number">0</span>] = idx</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;Built-in Output&#x27;</span> <span class="keyword">in</span> d[<span class="string">&#x27;name&#x27;</span>]:</span><br><span class="line">                iodevs[<span class="number">1</span>] = idx</span><br><span class="line">        <span class="keyword">return</span> iodevs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">recv_array</span>(<span class="params">self, flags=<span class="number">0</span>, copy=<span class="literal">True</span>, track=<span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;recv a numpy array&quot;&quot;&quot;</span></span><br><span class="line">        md = self.__zmq_socket.recv_json(flags=flags)</span><br><span class="line">        msg = self.__zmq_socket.recv(flags=flags, copy=copy, track=track)</span><br><span class="line">        <span class="keyword">if</span> self.__verbose:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;\r<span class="subst">&#123;md[<span class="string">&quot;frame_idx&quot;</span>]&#125;</span>: <span class="subst">&#123;md[<span class="string">&quot;tf&quot;</span>]&#125;</span>&#x27;</span>, end=<span class="string">&quot;&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">        buf = <span class="built_in">memoryview</span>(msg)</span><br><span class="line">        A = np.frombuffer(buf, dtype=md[<span class="string">&#x27;dtype&#x27;</span>])</span><br><span class="line">        <span class="keyword">return</span> A.reshape(md[<span class="string">&#x27;shape&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cb</span>(<span class="params">self, indata, outdata, frames, time, status</span>):</span></span><br><span class="line">        rpi_8mic_data = self.recv_array()</span><br><span class="line">        outdata[:] = np.hstack( (np.mean(rpi_8mic_data[:, <span class="number">0</span>:<span class="number">4</span>], axis=<span class="number">1</span>, keepdims=<span class="literal">True</span>),</span><br><span class="line">                                np.mean(rpi_8mic_data[:, <span class="number">4</span>:<span class="number">8</span>], axis=<span class="number">1</span>, keepdims=<span class="literal">True</span>)) )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fcb</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;finished!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, verbose=<span class="literal">False</span></span>):</span></span><br><span class="line">        self.__verbose = verbose</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> sounddevice.Stream(samplerate=<span class="number">48000</span>, device=self.__device, channels=[<span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">                                    callback=self.cb, finished_callback=self.fcb) <span class="keyword">as</span> ss:</span><br><span class="line">                <span class="built_in">input</span>()</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt <span class="keyword">as</span> ki:</span><br><span class="line">            self.__zmq_socket.close()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;exit!&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> Exception</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    sd = SdReceiver()</span><br><span class="line">    sd.run(verbose=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h2 id="3-3-小结"><a href="#3-3-小结" class="headerlink" title="3.3 小结"></a>3.3 小结</h2><p>吐槽：明确目标直接写代码，比无头苍蝇似的瞎配PulseAudio简单太多了。</p>
<h1 id="4-总结"><a href="#4-总结" class="headerlink" title="4 总结"></a>4 总结</h1><p>python-sounddevice每次调用callback传出来的是一个512帧的数组，即采样率48000Hz时约0.01067秒的数据，数据类型为float32，每个数字4字节，一个回调输出<code>512*8*4=16384</code>字节，如果按秒算的话就是<code>48000*8*4=1,536,000</code>字节，大概1.465MB/s。以前在单位都是千万十万的交换机，没仔细抠门过带宽问题，在上海基地用的这个民用wifi很明显受不了这种流量……延迟极大……（这时候想想人家mp3，192kHz几分钟的歌才4/5M，真NB）</p>
<p>这种极端环境下，ØMQ这种“假消息队列”的劣势就显现出来了，作为仅实现了“消息”和“队列”功能的超轻量级库，zmq没有持久化，默认缓存就几十兆，我试了下大概能存不到半分钟数据……订阅者消化能力太差就会导致缓存不够旧数据丢失，然而我就是喜欢zmq的这种朴素感🤦‍。反正树莓派上sd卡也不敢做缓存，搞不好写一写就坏了……后面在研究研究zmq的其他连接模式，毕竟宝藏库。</p>
<p>接下来就是利用音频数据进行分析了，明天试试把mfcc调个参魔改一下，看能不能水一篇20分的中端……</p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Python/">Python</a><a class="link-muted mr-2" rel="tag" href="/tags/Linux/">Linux</a></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><div class="social-share"></div><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechatpay.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/08/21/modified-mel-scale/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">修改版梅尔系数普</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/07/31/first-vps-from-russia/"><span class="level-item">我租了个巨便宜的VPS</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><script src="https://utteranc.es/client.js" repo="zlotus/comment" issue-term="pathname" label="some-issue-label" theme="github-light" crossorigin="anonymous" async></script></div></div></div><div class="column column-left is-3-tablet is-3-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/opm_sq.png" alt="子实"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">子实</p><p class="is-size-6 is-block">程序员</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>陕西/西安</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">81</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">23</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/zlotus" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/zlotus"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com/qinzishi"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/Zealot_uS"><i class="fab fa-twitter"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.zhihu.com/people/zlotus" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">知乎</span></span><span class="level-right"><span class="level-item tag">www.zhihu.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Diary/"><span class="level-start"><span class="level-item">Diary</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/"><span class="level-start"><span class="level-item">Programming</span></span><span class="level-end"><span class="level-item tag">67</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Shell/"><span class="level-start"><span class="level-item">Shell</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Coroutines/"><span class="tag">Coroutines</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaScript/"><span class="tag">JavaScript</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Javascript/"><span class="tag">Javascript</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">33</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenCV/"><span class="tag">OpenCV</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Operating-System/"><span class="tag">Operating System</span><span class="tag">21</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Paper/"><span class="tag">Paper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">20</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Raspberry-Pi/"><span class="tag">Raspberry Pi</span><span class="tag">20</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Rust/"><span class="tag">Rust</span><span class="tag">29</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Shell/"><span class="tag">Shell</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TensorFlow/"><span class="tag">TensorFlow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Tokio/"><span class="tag">Tokio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ZMQ/"><span class="tag">ZMQ</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ctpn/"><span class="tag">ctpn</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/llama/"><span class="tag">llama</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macOS/"><span class="tag">macOS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/obsidion/"><span class="tag">obsidion</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%A5%E8%AE%B0/"><span class="tag">日记</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E8%B0%88/"><span class="tag">杂谈</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%AE%97%E6%B3%95/"><span class="tag">算法</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BC%96%E7%A8%8B/"><span class="tag">编程</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%84%9A%E6%9C%AC/"><span class="tag">脚本</span><span class="tag">4</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/opm_sq.png" alt="子实" height="28"></a><p class="is-size-7"><span>&copy; 2024 子实</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>