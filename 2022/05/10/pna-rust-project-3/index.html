<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>PingCap的Rust训练课程3：同步的“客户端-服务端”网络模块 - 子实</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="子实"><meta name="msapplication-TileImage" content="/img/avatar-o.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="子实"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="PingCap的Rust训练课程3：同步的“客户端-服务端”网络模块"><meta property="og:type" content="article"><meta property="og:title" content="PingCap的Rust训练课程3：同步的“客户端-服务端”网络模块"><meta property="og:url" content="https://zlotus.github.io/2022/05/10/pna-rust-project-3/"><meta property="og:site_name" content="子实"><meta property="og:description" content="PingCap的Rust训练课程3：同步的“客户端-服务端”网络模块"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://zlotus.github.io/img/og_image.png"><meta property="article:published_time" content="2022-05-10T12:40:00.000Z"><meta property="article:modified_time" content="2022-05-10T12:40:00.000Z"><meta property="article:author" content="子实"><meta property="article:tag" content="Rust"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><meta property="twitter:creator" content="@Zealot_uS"><meta property="twitter:site" content="Zealot_uS"><link rel="publisher" href="+LotusQin"><meta property="fb:admins" content="qinzishi"><meta property="fb:app_id" content="qinzishi"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zlotus.github.io/2022/05/10/pna-rust-project-3/"},"headline":"PingCap的Rust训练课程3：同步的“客户端-服务端”网络模块","image":["https://zlotus.github.io/img/og_image.png"],"datePublished":"2022-05-10T12:40:00.000Z","dateModified":"2022-05-10T12:40:00.000Z","author":{"@type":"Person","name":"子实"},"publisher":{"@type":"Organization","name":"子实","logo":{"@type":"ImageObject","url":"https://zlotus.github.io/img/opm_sq.png"}},"description":"PingCap的Rust训练课程3：同步的“客户端-服务端”网络模块"}</script><link rel="icon" href="/img/avatar-o.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><!--!--><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/opm_sq.png" alt="子实" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/2014/07/09/about-me/">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zlotus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-9-tablet is-9-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-05-10T12:40:00.000Z" title="5/10/2022, 8:40:00 PM">2022-05-10</time>发表</span><span class="level-item"><time dateTime="2022-05-10T12:40:00.000Z" title="5/10/2022, 8:40:00 PM">2022-05-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a></span><span class="level-item">1 小时读完 (大约8283个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">PingCap的Rust训练课程3：同步的“客户端-服务端”网络模块</h1><div class="content"><article class="message message-immersive is-warning">
<div class="message-body">
<i class="fas fa-exclamation-triangle mr-2"></i>本文内容大多翻译自原文：<a target="_blank" rel="noopener" href="https://github.com/pingcap/talent-plan/tree/master/courses/rust/projects/project-3">PNA Rust Project 3: Synchronous client-server networking</a>。
</div>
</article>

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>任务</strong>：创建一个<em>单线程</em>、持久化的键/值存储的<em>服务器和客户端，使用自定义协议进行同步联网</em>。</p>
<p><strong>目标</strong>：</p>
<ul>
<li>创建一个客户端-服务器应用程序</li>
<li>用<code>std</code>库的网络API编写自定义协议</li>
<li>为服务端引入日志记录功能</li>
<li>用trait实现可插拔的后端</li>
<li>用<code>sled</code>对手写的后端进行基准测试</li>
</ul>
<p><strong>关键词</strong>：<code>std::net</code>、日志、trait、基准测试。</p>
<span id="more"></span>

<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>在这个项目中，你将创建一个简单的键/值存储服务端和客户端，它们将用你自定义的网络协议进行通信。你将使用标准的日志crate生成日志，并正确处理网络边界上的错误。一旦有了一个可运行的客户端-服务端架构，那么你就能够抽象出trait背后的存储引擎，并将你的实现与<a target="_blank" rel="noopener" href="https://github.com/spacejam/sled"><code>sled</code></a>引擎进行性能比较。</p>
<h2 id="项目需求规格"><a href="#项目需求规格" class="headerlink" title="项目需求规格"></a>项目需求规格</h2><p>cargo项目<code>kvs</code>建立了一个名为<code>kvs-client</code>的命令行键值存储客户端，和一个名为<code>kvs-server</code>的键值存储服务端，二者又都调用了一个名为<code>kvs</code>的库。客户端通过一个自定义协议与服务端通信。</p>
<p><code>kvs-server</code>可执行文件支持以下命令行参数：</p>
<ul>
<li><p><code>kvs-server [--addr IP-PORT] [--engine ENGINE-NAME]</code></p>
<p>启动服务端并开始监听进入的连接。<code>--addr</code>接受一个IP地址（可以是v4或v6）以及一个端口号，格式为<code>IP:PORT</code>。如果没有指定<code>--addr</code>，则默认监听<code>127.0.0.1:4000</code>。</p>
<p>如果指定了<code>--engine</code>，那么<code>ENGINE-NAME</code>必须是”kvs”（即使用内置引擎），或者是”sled”（即使用sled引擎）。如果这是首次运行程序（没有以前保存的数据），那么默认值是”kvs”；如果以前有保存的数据，那么默认使用已经在用的引擎。如果以前保存的数据与当前选择的引擎不同，则打印一个错误并以非零的退出码退出。</p>
<p>如果套接字绑定失败，或<code>ENGINE-NAME</code>无效，或<code>IP-PORT</code>不能解析为一个地址，则打印一个错误并以非零的退出码退出。</p>
</li>
<li><p><code>kvs-server -V</code></p>
<p>打印版本信息。</p>
</li>
</ul>
<p><code>kvs-client</code>可执行文件支持以下命令行参数：</p>
<ul>
<li><p><code>kvs-client set &lt;KEY&gt; &lt;VALUE&gt; [--addr IP-PORT]</code></p>
<p>将一个字符串键的值设置为一个字符串。</p>
<p><code>--addr</code>接受一个IP地址（可以是v4或v6）以及一个端口号，格式为<code>IP:PORT</code>。如果没有指定<code>--addr</code>，则在默认<code>127.0.0.1:4000</code>上连接。</p>
<p>如果服务器出错，或者<code>IP-PORT</code>不能解析为一个地址，则打印错误并以非零的退出码退出。</p>
</li>
<li><p><code>kvs-client get &lt;KEY&gt; [--addr IP-PORT]</code></p>
<p>获取一个给定的字符串键的字符串值。</p>
<p><code>--addr</code>接受一个IP地址（可以是v4或v6）以及一个端口号，格式为<code>IP:PORT</code>。如果没有指定<code>--addr</code>，则在默认<code>127.0.0.1:4000</code>上连接。</p>
<p>如果服务器出错，或者<code>IP-PORT</code>不能解析为一个地址，则打印错误并以非零的退出码退出。</p>
</li>
<li><p><code>kvs-client rm &lt;KEY&gt; [--addr IP-PORT]</code></p>
<p>删除一个给定的字符串键。</p>
<p><code>--addr</code>接受一个IP地址（可以是v4或v6）以及一个端口号，格式为<code>IP:PORT</code>。如果没有指定<code>--addr</code>，则在默认<code>127.0.0.1:4000</code>上连接。</p>
<p>如果服务器出错，或者<code>IP-PORT</code>不能解析为一个地址，则打印错误并以非零的退出码退出。 </p>
</li>
<li><p><code>kvs-client -V</code></p>
<p>打印版本信息。</p>
</li>
</ul>
<p>所有错误信息都应打印到stderr。</p>
<p><code>kvs</code>库包含四种类型。</p>
<ul>
<li><code>KvsClient</code> - 为<code>kvs-client</code>实现与<code>kvs-server</code>通信所需的功能。</li>
<li><code>KvsServer</code> - 为<code>kvs-server</code>实现响应<code>kvs-client</code>请求的功能。</li>
<li><code>KvsEngine</code> trait - 定义了<code>KvsServer</code>需要调用的存储接口。</li>
<li><code>KvStore</code> - 手动实现<code>KvsEngine</code> trait</li>
<li><code>SledKvsEngine</code> - 为<code>sled</code>存储引擎实现<code>KvsEngine</code> trait。</li>
</ul>
<p><code>KvsClient</code>和<code>KvsServer</code>的设计由你决定，并将使用你自定义的网络协议来通信。本项目的测试套件并不直接调用这两种类型，而仅是通过CLI测试它们。</p>
<p><code>KvsEngine</code> trait支持以下方法：</p>
<ul>
<li><p><code>KvsEngine::set(&amp;mut self, key: String, value: String) -&gt; Result&lt;()&gt;</code></p>
<p>将一个字符串键的值设置为一个字符串。</p>
<p>如果值没有成功写入，则返回错误。</p>
</li>
<li><p><code>KvsEngine::get(&amp;mut self, key: String) -&gt; Result&lt;Option&lt;String&gt;&gt;</code></p>
<p>获取一个字符串键的字符串值。如果键不存在，返回<code>None</code>。</p>
<p>如果没有成功读取该值，则返回错误。</p>
</li>
<li><p><code>KvsEngine::remove(&amp;mut self, key: String) -&gt; Result&lt;()&gt;</code></p>
<p>删除一个给定的字符串键。</p>
<p>如果键不存在或值未被成功读取，则返回错误。</p>
</li>
</ul>
<p>当为一个键设置值时，<code>KvStore</code>会把<code>set</code>命令写入磁盘的顺序日志。当删除一个键时，<code>KvStore</code>将<code>rm</code>命令写入日志。在启动时，日志中的命令将被重新求值，各键的最新一条设置命令的日志指针（文件偏移量）将会被保存在内存索引中。</p>
<p>当用<code>get</code>命令检索一个键的值时，它会搜索索引，如果找到了，就从日志的相应位置中加载相应命令并求值。</p>
<p>当未压缩的日志条目的大小达到一个给定的阈值时，<code>KvStore</code>将其压缩成一个新的日志，删除多余的条目以释放磁盘空间。</p>
<h2 id="项目设置"><a href="#项目设置" class="headerlink" title="项目设置"></a>项目设置</h2><p>继续你以前的项目，删除你以前的<code>tests</code>目录，把这本项目的<code>tests</code>目录复制到它的位置。这个项目应该包含一个名为<code>kvs</code>的库，以及两个可执行文件，<code>kvs-server</code>和<code>kvs-client</code>。</p>
<p>你需要在<code>Cargo.toml</code>中加入以下<code>dev-dependencies</code>依赖：</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dev-dependencies]</span></span><br><span class="line"><span class="attr">assert_cmd</span> = <span class="string">&quot;0.11&quot;</span></span><br><span class="line"><span class="attr">criterion</span> = <span class="string">&quot;0.3&quot;</span></span><br><span class="line"><span class="attr">predicates</span> = <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line"><span class="attr">rand</span> = <span class="string">&quot;0.6.5&quot;</span></span><br><span class="line"><span class="attr">tempfile</span> = <span class="string">&quot;3.0.7&quot;</span></span><br><span class="line"><span class="attr">walkdir</span> = <span class="string">&quot;2.2.7&quot;</span></span><br></pre></td></tr></table></figure>

<p>与以前的项目一样，添加足够的定义，以构建测试套件。</p>
<hr>
<p>使测试套件编译通过只需要：</p>
<ol>
<li>按上文要求在<code>lib.rs</code>中添加一个新模块<code>mod engines</code>；</li>
<li>创建新模块<code>engines\mod.rs</code>；</li>
<li>在新模块<code>mod.rs</code>中按要求加入<code>KvsEngine</code> trait的定义即可。</li>
<li>在<code>lib.rs</code>中公开引用这个trait即可：<code>pub use engines::KvsEngine;</code></li>
</ol>
<p>目录结构为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── Cargo.toml</span><br><span class="line">├── src</span><br><span class="line">│  ├── bin</span><br><span class="line">│  │  └── kvs.rs</span><br><span class="line">│  ├── engines</span><br><span class="line">│  │  └── mod.rs</span><br><span class="line">│  ├── error.rs</span><br><span class="line">│  ├── kv.rs</span><br><span class="line">│  └── lib.rs</span><br><span class="line">└── tests</span><br><span class="line">   ├── cli.rs</span><br><span class="line">   └── kv_store.rs</span><br></pre></td></tr></table></figure>

<p>目前<code>cli.rs</code>中的11个测试均未通过：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cargo <span class="built_in">test</span> --<span class="built_in">test</span> cli</span><br><span class="line">...</span><br><span class="line">running 11 tests</span><br><span class="line"><span class="built_in">test</span> cli_log_configuration ... FAILED</span><br><span class="line"><span class="built_in">test</span> cli_access_server_kvs_engine ... FAILED</span><br><span class="line"><span class="built_in">test</span> cli_wrong_engine ... FAILED</span><br><span class="line"><span class="built_in">test</span> client_cli_invalid_get ... FAILED</span><br><span class="line"><span class="built_in">test</span> client_cli_invalid_rm ... FAILED</span><br><span class="line"><span class="built_in">test</span> client_cli_invalid_set ... FAILED</span><br><span class="line"><span class="built_in">test</span> cli_access_server_sled_engine ... FAILED</span><br><span class="line"><span class="built_in">test</span> client_cli_invalid_subcommand ... FAILED</span><br><span class="line"><span class="built_in">test</span> client_cli_version ... FAILED</span><br><span class="line"><span class="built_in">test</span> server_cli_version ... FAILED</span><br><span class="line"><span class="built_in">test</span> client_cli_no_args ... FAILED</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>kv_store.rs</code>中的均通过测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cargo <span class="built_in">test</span> --<span class="built_in">test</span> kv_store</span><br><span class="line">running 6 tests</span><br><span class="line"><span class="built_in">test</span> remove_non_existent_key ... ok</span><br><span class="line"><span class="built_in">test</span> remove_key ... ok</span><br><span class="line"><span class="built_in">test</span> get_stored_value ... ok</span><br><span class="line"><span class="built_in">test</span> get_non_existent_value ... ok</span><br><span class="line"><span class="built_in">test</span> overwrite_value ... ok</span><br><span class="line"><span class="built_in">test</span> compaction ... ok</span><br></pre></td></tr></table></figure>

<h2 id="第1部分：解析命令行"><a href="#第1部分：解析命令行" class="headerlink" title="第1部分：解析命令行"></a>第1部分：解析命令行</h2><p>本项目中的命令行解析同之前的项目相比没有多少新功能。<code>kvs-client</code>二进制文件接受与之前项目相同的命令行参数。而<code>kvs-server</code>有一组自己的命令行参数需要处理，就像上文描述的那样。</p>
<p><em>处理<code>kvs-server</code>的命令行参数。</em></p>
<hr>
<p><code>kvs-server</code>的参数比较简单，依然使用<code>clap</code>的<code>derive</code>特性编写，由于Rust已经为<code>&amp;str</code>实现了<code>ToSocketAddrs</code>特性，<code>Args</code>中直接使用<code>SocketAddr</code>类型会自动触发字符串到IP地址的转换：</p>
<figure class="highlight rust"><figcaption><span>kvs-server.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> clap::&#123;Parser&#125;;</span><br><span class="line"><span class="keyword">use</span> kvs::&#123;<span class="built_in">Result</span>&#125;;</span><br><span class="line"><span class="keyword">use</span> std::net::SocketAddr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> DEFAULT_LISTENING_ADDRESS: &amp;<span class="built_in">str</span> = <span class="string">&quot;127.0.0.1:4000&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> DEFAULT_ENGINE: Engine = Engine::kvs;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[allow(non_camel_case_types)]</span></span><br><span class="line"><span class="meta">#[derive(clap::ArgEnum, Clone, Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Engine</span></span> &#123;</span><br><span class="line">   kvs,</span><br><span class="line">   sled,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> FromStr <span class="keyword">for</span> Engine &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Err</span></span> = KvsError;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from_str</span></span>(s: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> s &#123;</span><br><span class="line">            <span class="string">&quot;kvs&quot;</span> =&gt; &#123;</span><br><span class="line">                <span class="literal">Ok</span>(Engine::kvs)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;sled&quot;</span> =&gt; &#123;</span><br><span class="line">                <span class="literal">Ok</span>(Engine::sled)</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; &#123;</span><br><span class="line">                <span class="literal">Err</span>(KvsError::UnexpectedEngineType)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Parser, Debug)]</span></span><br><span class="line"><span class="meta">#[clap(name = <span class="meta-string">&quot;kvs-server&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[clap(author, version, about=<span class="meta-string">&quot;server of key value storage&quot;</span>, long_about=None)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Args</span></span> &#123;</span><br><span class="line">    <span class="comment">/// [IPADDR:PORT] of server.</span></span><br><span class="line">    <span class="meta">#[clap(long, default_value=DEFAULT_LISTENING_ADDRESS)]</span></span><br><span class="line">    addr: SocketAddr,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// backend engine of key value storage.</span></span><br><span class="line">    <span class="meta">#[clap(arg_enum, long, required(false))]</span></span><br><span class="line">    engine: <span class="built_in">Option</span>&lt;Engine&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> args = Args::parse();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125; &#123;:?&#125;&quot;</span>, args.addr, args.engine);</span><br><span class="line">    </span><br><span class="line">    <span class="literal">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>kvs-client</code>需要在子命令后面再添加可选参数（IP地址），所以可以使用<code>clap</code>的builder编写模式增加可读性。当然，也可以继续使用<code>derive</code>特性编写更简略的代码：</p>
<figure class="highlight rust"><figcaption><span>kvs-client.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// builder模式</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> clap::&#123;Command, arg, crate_version&#125;;</span><br><span class="line"><span class="keyword">use</span> kvs::&#123;<span class="built_in">Result</span>&#125;;</span><br><span class="line"><span class="keyword">use</span> std::net::SocketAddr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> DEFAULT_LISTENING_ADDRESS: &amp;<span class="built_in">str</span> = <span class="string">&quot;127.0.0.1:4000&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">cli</span></span>() -&gt; Command&lt;<span class="symbol">&#x27;static</span>&gt; &#123;</span><br><span class="line">    Command::new(<span class="string">&quot;kvs-client&quot;</span>)</span><br><span class="line">        .about(<span class="string">&quot;client of key value storage&quot;</span>)</span><br><span class="line">        .version(crate_version!())</span><br><span class="line">        .subcommand_required(<span class="literal">true</span>)</span><br><span class="line">        .disable_help_subcommand(<span class="literal">true</span>)</span><br><span class="line">        .args_conflicts_with_subcommands(<span class="literal">true</span>)</span><br><span class="line">        .subcommand(</span><br><span class="line">            Command::new(<span class="string">&quot;get&quot;</span>)</span><br><span class="line">                .about(<span class="string">&quot;Get the string value of a given string key&quot;</span>)</span><br><span class="line">                .args(&amp;[</span><br><span class="line">                    arg!(&lt;KEY&gt; <span class="string">&quot;A string key&quot;</span>),</span><br><span class="line">                    arg!(--addr &lt;<span class="string">&quot;IP:PORT&quot;</span>&gt; <span class="string">&quot;Set the server address as IP:PORT&quot;</span>).required(<span class="literal">false</span>).default_value(DEFAULT_LISTENING_ADDRESS)</span><br><span class="line">                ])</span><br><span class="line">        )</span><br><span class="line">        .subcommand(</span><br><span class="line">            Command::new(<span class="string">&quot;set&quot;</span>)</span><br><span class="line">                .about(<span class="string">&quot;Set the value of a string key to a string&quot;</span>)</span><br><span class="line">                .args(&amp;[</span><br><span class="line">                    arg!(&lt;KEY&gt; <span class="string">&quot;A string key&quot;</span>),</span><br><span class="line">                    arg!(&lt;VALUE&gt; <span class="string">&quot;The string value of the key&quot;</span>).required(<span class="literal">true</span>),</span><br><span class="line">                    arg!(--addr &lt;<span class="string">&quot;IP:PORT&quot;</span>&gt; <span class="string">&quot;Set the server address as IP:PORT&quot;</span>).required(<span class="literal">false</span>).default_value(DEFAULT_LISTENING_ADDRESS) </span><br><span class="line">                ])</span><br><span class="line">        )</span><br><span class="line">        .subcommand(</span><br><span class="line">            Command::new(<span class="string">&quot;rm&quot;</span>)</span><br><span class="line">                .about(<span class="string">&quot;Remove a given string key&quot;</span>)</span><br><span class="line">                .args(&amp;[</span><br><span class="line">                    arg!(&lt;KEY&gt; <span class="string">&quot;A string key&quot;</span>),</span><br><span class="line">                    arg!(--addr &lt;<span class="string">&quot;IP:PORT&quot;</span>&gt; <span class="string">&quot;Set the server address as IP:PORT&quot;</span>).required(<span class="literal">false</span>).default_value(DEFAULT_LISTENING_ADDRESS)                </span><br><span class="line">                ])</span><br><span class="line">        )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() -&gt; <span class="built_in">Result</span>&lt;()&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> matches = cli().get_matches();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> matches.subcommand() &#123;</span><br><span class="line">        <span class="literal">Some</span>((<span class="string">&quot;get&quot;</span>, sub_matches)) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;get &#123;&#125; &#123;&#125;&quot;</span>, sub_matches.value_of(<span class="string">&quot;KEY&quot;</span>).unwrap(), sub_matches.value_of(<span class="string">&quot;addr&quot;</span>).unwrap());</span><br><span class="line">            <span class="keyword">let</span> key = sub_matches.value_of(<span class="string">&quot;KEY&quot;</span>).unwrap();</span><br><span class="line">            <span class="keyword">let</span> addr: SocketAddr = sub_matches.value_of(<span class="string">&quot;addr&quot;</span>).unwrap().parse()?;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="literal">Some</span>((<span class="string">&quot;set&quot;</span>, sub_matches)) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;set &#123;&#125; &#123;&#125; &#123;&#125;&quot;</span>, sub_matches.value_of(<span class="string">&quot;KEY&quot;</span>).unwrap(), sub_matches.value_of(<span class="string">&quot;VALUE&quot;</span>).unwrap(), sub_matches.value_of(<span class="string">&quot;addr&quot;</span>).unwrap());</span><br><span class="line">            <span class="keyword">let</span> key = sub_matches.value_of(<span class="string">&quot;KEY&quot;</span>).unwrap();</span><br><span class="line">            <span class="keyword">let</span> value = sub_matches.value_of(<span class="string">&quot;VALUE&quot;</span>).unwrap();</span><br><span class="line">            <span class="keyword">let</span> addr: SocketAddr = sub_matches.value_of(<span class="string">&quot;addr&quot;</span>).unwrap().parse()?;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Some</span>((<span class="string">&quot;rm&quot;</span>, sub_matches)) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;rm &#123;&#125; &#123;&#125;&quot;</span>, sub_matches.value_of(<span class="string">&quot;KEY&quot;</span>).unwrap(), sub_matches.value_of(<span class="string">&quot;addr&quot;</span>).unwrap());</span><br><span class="line">            <span class="keyword">let</span> key = sub_matches.value_of(<span class="string">&quot;KEY&quot;</span>).unwrap();</span><br><span class="line">            <span class="keyword">let</span> addr: SocketAddr = sub_matches.value_of(<span class="string">&quot;addr&quot;</span>).unwrap().parse()?;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        _ =&gt; <span class="built_in">unreachable!</span>(), <span class="comment">// If all subcommands are defined above, anything else is unreachabe!()</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="literal">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// derive模式</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> clap::&#123;Parser, Subcommand&#125;;</span><br><span class="line"><span class="keyword">use</span> kvs::&#123;KvStore, <span class="built_in">Result</span>&#125;;</span><br><span class="line"><span class="keyword">use</span> std::process::exit;</span><br><span class="line"><span class="keyword">use</span> std::env::current_dir;</span><br><span class="line"><span class="keyword">use</span> std::net::SocketAddr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> DEFAULT_LISTENING_ADDRESS: &amp;<span class="built_in">str</span> = <span class="string">&quot;127.0.0.1:4000&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Parser)]</span></span><br><span class="line"><span class="meta">#[clap(name = <span class="meta-string">&quot;kvs&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[clap(author, version, about=<span class="meta-string">&quot;an in-memory key/value store&quot;</span>, long_about=None, args_conflicts_with_subcommands(true))]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Cli</span></span> &#123;</span><br><span class="line">    <span class="meta">#[clap(subcommand)]</span></span><br><span class="line">    command: Commands,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Subcommand)]</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Commands</span></span> &#123;</span><br><span class="line">    <span class="comment">// Set the value of a string key to a string</span></span><br><span class="line">    <span class="meta">#[clap(arg_required_else_help = true)]</span></span><br><span class="line">    set &#123;</span><br><span class="line">        <span class="comment">// A string key</span></span><br><span class="line">        key: <span class="built_in">String</span>,</span><br><span class="line">        <span class="comment">// The string value of the key</span></span><br><span class="line">        value: <span class="built_in">String</span>,</span><br><span class="line">        <span class="meta">#[clap(long, required(false), default_value(DEFAULT_LISTENING_ADDRESS), help=<span class="meta-string">&quot;Set the server address as [IP:PORT]&quot;</span>)]</span></span><br><span class="line">        addr: SocketAddr</span><br><span class="line">    &#125;, </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the string value of a given string key</span></span><br><span class="line">    <span class="meta">#[clap(arg_required_else_help = true)]</span></span><br><span class="line">    get &#123;</span><br><span class="line">        <span class="comment">// A string key</span></span><br><span class="line">        key: <span class="built_in">String</span>,</span><br><span class="line">        <span class="meta">#[clap(long, required(false), default_value(DEFAULT_LISTENING_ADDRESS), help=<span class="meta-string">&quot;Set the server address as [IP:PORT]&quot;</span>)]</span></span><br><span class="line">        addr: SocketAddr</span><br><span class="line">    &#125;, </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove a given key</span></span><br><span class="line">    <span class="meta">#[clap(arg_required_else_help = true)]</span></span><br><span class="line">    rm &#123;</span><br><span class="line">        <span class="comment">// A string key</span></span><br><span class="line">        key: <span class="built_in">String</span>,</span><br><span class="line">        <span class="meta">#[clap(long, required(false), default_value(DEFAULT_LISTENING_ADDRESS), help=<span class="meta-string">&quot;Set the server address as [IP:PORT]&quot;</span>)]</span></span><br><span class="line">        addr: SocketAddr</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> cli= Cli::parse();</span><br><span class="line">    <span class="keyword">match</span> cli.command &#123;</span><br><span class="line">        Commands::get &#123; key, addr &#125; =&gt; &#123;&#125;, </span><br><span class="line">        Commands::set &#123; key, value, addr &#125; =&gt; &#123;&#125;,</span><br><span class="line">        Commands::rm &#123; key, addr &#125; =&gt; &#123;&#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="literal">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第2部分：日志记录"><a href="#第2部分：日志记录" class="headerlink" title="第2部分：日志记录"></a>第2部分：日志记录</h2><p>生产环境下的服务器应用程序应具有功能强大且可配置的日志记录。因此，现在我们应为<code>kvs-server</code>添加日志功能，并在后续功能实现的过程中记录有用的信息。在开发过程中，通常使用<code>debug!</code>和<code>trace!</code>级日志来打印调试信息。</p>
<p>Rust中有两个好用的日志系统：<a target="_blank" rel="noopener" href="https://docs.rs/log/"><code>log</code></a>和<a target="_blank" rel="noopener" href="https://docs.rs/slog/"><code>slog</code></a>。两者均为不同级别的日志输出类似的宏，如<code>error!</code>、<code>info!</code>等。两者都是可扩展的，支持不同的后端，以输出日志到控制台、日志文件或系统日志等。</p>
<p>最主要的区别是，<code>log</code>相当简单，只记录格式化的字符串；<code>slog</code>功能丰富，支持“结构化日志”，其日志条目是以容易解析的格式类型化和序列化的。</p>
<p><code>log</code>可以追溯到Rust最早的时候，它是编译器的一部分，然后是标准库的一部分，最后作为独立的crate发布。它由Rust项目组维护。<code>slog</code>是较新的crate，独立维护。两者均已被广泛使用。</p>
<p>对于这两种系统，都需要选择一个“接收器”crate，用于将日志发送到该接收器以进行显示或存储。</p>
<p>*阅读这两个系统，选择一个对你喜欢的，将它们作为依赖项添加，然后修改<code>kvs-server</code>以在传递命令行参数之前初始化日志。将日志设置为输出到<code>stderr</code>*（将日志发送到其他地方也可以，但日志必须也发送到<code>stderr</code>以通过本项目的测试）。</p>
<p>在启动时日志记录服务器端的版本信息，还要记录配置信息。目前指的是IP地址和端口，以及存储引擎的名称。</p>
<hr>
<p>因为第一次使用日志功能，还是先用简单的<code>log</code>入门，在<code>Cargo.toml</code>里引入<code>log</code>和<code>env_logger</code>（用于配置日志）。然后按要求输出日志即可：</p>
<figure class="highlight rust"><figcaption><span>kvs-server.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    env_logger::builder().filter_level(LevelFilter::<span class="built_in">Debug</span>).init();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> args = Args::parse();</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    run(args)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">run</span></span>(args: Args) -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> engine = args.engine.unwrap_or(DEFAULT_ENGINE);</span><br><span class="line">    info!(<span class="string">&quot;kvs-server &#123;&#125;&quot;</span>, <span class="built_in">env!</span>(<span class="string">&quot;CARGO_PKG_VERSION&quot;</span>));</span><br><span class="line">    info!(<span class="string">&quot;Storage engine: &#123;:?&#125;&quot;</span>, engine);</span><br><span class="line">    info!(<span class="string">&quot;Listening on &#123;&#125;&quot;</span>, args.addr);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<h2 id="第3部分：客户端-服务端网络设置"><a href="#第3部分：客户端-服务端网络设置" class="headerlink" title="第3部分：客户端-服务端网络设置"></a>第3部分：客户端-服务端网络设置</h2><p>接下来，我们将搭建网络模块。对于本项目，您将使用<code>std::net</code>中使用最基础的TCP/IP网络API：<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/net/struct.TcpListener.html"><code>TcpListener</code></a>和<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/net/struct.TcpStream.html"><code>TcpStream</code></a>。</p>
<p>对于本项目，服务器是同步、单线程的。这意味着您将监听一个socket，接受一个连接，然后一次执行/响应一条命令。在未来，我们将在实现异步、多线程和高性能数据库的过程中，多次重新回味这一设定。</p>
<p>考虑一下您的手动测试工作流程。现在有两个可执行文件要处理，您需要一种同时运行它们的方法。您可能和我们一样，同时使用两个终端，一个运行<code>cargo run --bin kvs-server</code> ，服务端将一直运行到你按下CTRL-D；另一个运行<code>cargo run --bin kvs-client</code>。</p>
<p>这是使用日志进行调试的好机会。继续记录有关每个已接受连接的信息。</p>
<p><em>在考虑协议之前，先修改<code>kvs-server</code>来监听和接受连接，在修改<code>kvs-client</code>来发起连接。</em></p>
<hr>
<p>是时候把<code>KvStore</code>变成真正的KV引擎了，把为<code>KvStore</code>实现的<code>get</code>、<code>set</code>、<code>remove</code>拿出来，用于为<code>KvStore</code>实现<code>KvsEngine</code>特性：</p>
<figure class="highlight rust"><figcaption><span>engines/kvs.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">impl</span> KvsEngine <span class="keyword">for</span> KvStore &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">set</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>, value: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> cmd = Command::set(key, value);</span><br><span class="line">        <span class="keyword">let</span> pos = <span class="keyword">self</span>.writer.pos;</span><br><span class="line">        serde_json::to_writer(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.writer, &amp;cmd)?;</span><br><span class="line">        <span class="keyword">self</span>.writer.flush()?;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> Command::Set &#123; key, .. &#125; = cmd &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(old_cmd) = <span class="keyword">self</span></span><br><span class="line">                .index</span><br><span class="line">                .insert(key, (<span class="keyword">self</span>.current_gen, pos..<span class="keyword">self</span>.writer.pos).into())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">self</span>.uncompacted += old_cmd.len;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.uncompacted &gt; COMPACTION_THRESHOLD &#123;</span><br><span class="line">            <span class="keyword">self</span>.compact()?;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">get</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">Option</span>&lt;<span class="built_in">String</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(cmd_pos) = <span class="keyword">self</span>.index.get(&amp;key) &#123;</span><br><span class="line">            <span class="keyword">let</span> reader = <span class="keyword">self</span></span><br><span class="line">                .readers</span><br><span class="line">                .get_mut(&amp;cmd_pos.gen)</span><br><span class="line">                .expect(<span class="string">&quot;Cannot find log reader&quot;</span>);</span><br><span class="line">            reader.seek(SeekFrom::Start(cmd_pos.pos))?;</span><br><span class="line">            <span class="keyword">let</span> cmd_reader = reader.take(cmd_pos.len);</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> Command::Set &#123; value, .. &#125; = serde_json::from_reader(cmd_reader)? &#123;</span><br><span class="line">                <span class="literal">Ok</span>(<span class="literal">Some</span>(value))</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="literal">Err</span>(KvsError::UnexpectedCommandType)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="literal">Ok</span>(<span class="literal">None</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">remove</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.index.contains_key(&amp;key) &#123;</span><br><span class="line">            <span class="keyword">let</span> cmd = Command::remove(key);</span><br><span class="line">            serde_json::to_writer(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.writer, &amp;cmd)?;</span><br><span class="line">            <span class="keyword">self</span>.writer.flush()?;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> Command::Remove &#123; key &#125; = cmd &#123;</span><br><span class="line">                <span class="keyword">let</span> old_cmd = <span class="keyword">self</span>.index.remove(&amp;key).expect(<span class="string">&quot;key not found&quot;</span>);</span><br><span class="line">                <span class="keyword">self</span>.uncompacted += old_cmd.len;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="literal">Ok</span>(())</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="literal">Err</span>(KvsError::KeyNotFound)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在实现客户端-服务端之前，可以先定义用于序列化的枚举类型，作为客户端与服务端之间的通信协议（在后面编写服务端和客户端时，可以方便的将这些支持序列化的类型放在<code>TcpStream</code>上进行读写）：</p>
<figure class="highlight rust"><figcaption><span>common.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> serde::&#123;Serialize, Deserialize&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Serialize, Deserialize)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Request</span></span> &#123;</span><br><span class="line">    Get &#123; key: <span class="built_in">String</span> &#125;,</span><br><span class="line">    Set &#123; key: <span class="built_in">String</span>, value: <span class="built_in">String</span> &#125;,</span><br><span class="line">    Remove &#123; key: <span class="built_in">String</span> &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Serialize, Deserialize)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">GetResponse</span></span> &#123;</span><br><span class="line">    <span class="literal">Ok</span>(<span class="built_in">Option</span>&lt;<span class="built_in">String</span>&gt;),</span><br><span class="line">    <span class="literal">Err</span>(<span class="built_in">String</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Serialize, Deserialize)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">SetResponse</span></span> &#123;</span><br><span class="line">    <span class="literal">Ok</span>(()),</span><br><span class="line">    <span class="literal">Err</span>(<span class="built_in">String</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Serialize, Deserialize)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">RemoveResponse</span></span> &#123;</span><br><span class="line">    <span class="literal">Ok</span>(()),</span><br><span class="line">    <span class="literal">Err</span>(<span class="built_in">String</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在<code>server.rs</code>中实现<code>KvsServer</code>：</p>
<figure class="highlight rust"><figcaption><span>server.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::&#123;net::&#123;ToSocketAddrs, TcpListener, TcpStream&#125;, io::&#123;BufReader, BufWriter, Write&#125;&#125;;</span><br><span class="line"><span class="keyword">use</span> log::&#123;error, debug&#125;;</span><br><span class="line"><span class="keyword">use</span> serde_json::Deserializer;</span><br><span class="line"><span class="keyword">use</span> crate::&#123;KvsEngine, <span class="built_in">Result</span>, common::&#123;Request, GetResponse, SetResponse, RemoveResponse&#125;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// The server of a key value store.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">KvsServer</span></span>&lt;E: KvsEngine&gt; &#123;</span><br><span class="line">    engine: E,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;E: KvsEngine&gt; KvsServer&lt;E&gt;  &#123;</span><br><span class="line">    <span class="comment">/// Create a `KvsServer` with a given storage engine.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(engine: E) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        KvsServer &#123; engine &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// Run the server listening on the given address</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">run</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, addr: <span class="keyword">impl</span> ToSocketAddrs) -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> listener = TcpListener::bind(addr)?;</span><br><span class="line">        <span class="keyword">for</span> stream <span class="keyword">in</span> listener.incoming() &#123;</span><br><span class="line">            <span class="keyword">match</span> stream &#123;</span><br><span class="line">                <span class="literal">Ok</span>(stream) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Err</span>(e) = <span class="keyword">self</span>.serve(stream) &#123;</span><br><span class="line">                        error!(<span class="string">&quot;Error on serving client: &#123;&#125;&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; error!(<span class="string">&quot;Connection failed: &#123;&#125;&quot;</span>, e),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">serve</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, tcp: TcpStream) -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> peer_addr = tcp.peer_addr()?;</span><br><span class="line">        <span class="keyword">let</span> reader = BufReader::new(&amp;tcp);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> writer = BufWriter::new(&amp;tcp);</span><br><span class="line">        <span class="keyword">let</span> req_reader = Deserializer::from_reader(reader).into_iter::&lt;Request&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">macro_rules!</span> send_resp &#123;</span><br><span class="line">            ($resp:expr) =&gt; &#123;&#123;</span><br><span class="line">                <span class="keyword">let</span> resp = $resp;</span><br><span class="line">                serde_json::to_writer(&amp;<span class="keyword">mut</span> writer, &amp;resp)?;</span><br><span class="line">                writer.flush()?;</span><br><span class="line">                debug!(<span class="string">&quot;Response sent to &#123;&#125;: &#123;:?&#125;&quot;</span>, peer_addr, resp);</span><br><span class="line">            &#125;;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> req <span class="keyword">in</span> req_reader &#123;</span><br><span class="line">            <span class="keyword">let</span> req = req?;</span><br><span class="line">            debug!(<span class="string">&quot;Receive request from &#123;&#125; &#123;:?&#125;&quot;</span>, peer_addr, req);</span><br><span class="line">            <span class="keyword">match</span> req &#123;</span><br><span class="line">                Request::Get &#123; key &#125; =&gt; send_resp!(</span><br><span class="line">                    <span class="keyword">match</span> <span class="keyword">self</span>.engine.get(key) &#123;</span><br><span class="line">                        <span class="literal">Ok</span>(value) =&gt; &#123; GetResponse::<span class="literal">Ok</span>(value) &#125;,</span><br><span class="line">                        <span class="literal">Err</span>(e) =&gt; &#123; GetResponse::<span class="literal">Err</span>(<span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, e)) &#125;,</span><br><span class="line">                    &#125;</span><br><span class="line">                ),</span><br><span class="line">                Request::Set &#123; key, value &#125; =&gt; send_resp!(</span><br><span class="line">                    <span class="keyword">match</span> <span class="keyword">self</span>.engine.set(key, value) &#123;</span><br><span class="line">                        <span class="literal">Ok</span>(_) =&gt; SetResponse::<span class="literal">Ok</span>(()),</span><br><span class="line">                        <span class="literal">Err</span>(e) =&gt; SetResponse::<span class="literal">Err</span>(<span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, e)),</span><br><span class="line">                    &#125;</span><br><span class="line">                ),</span><br><span class="line">                Request::Remove &#123; key &#125; =&gt; send_resp!(</span><br><span class="line">                    <span class="keyword">match</span> <span class="keyword">self</span>.engine.remove(key) &#123;</span><br><span class="line">                        <span class="literal">Ok</span>(_) =&gt; RemoveResponse::<span class="literal">Ok</span>(()),</span><br><span class="line">                        <span class="literal">Err</span>(e) =&gt; RemoveResponse::<span class="literal">Err</span>(<span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, e)),</span><br><span class="line">                    &#125;</span><br><span class="line">                ),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>send_resp!</code>宏的作用与下面的代码相同，编写这个宏可以减少重复：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用代码</span></span><br><span class="line">Request::Get &#123; key &#125; =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> resp = <span class="keyword">match</span> <span class="keyword">self</span>.engine.get(key) &#123;</span><br><span class="line">        <span class="literal">Ok</span>(value) =&gt; &#123; GetResponse::<span class="literal">Ok</span>(value) &#125;,</span><br><span class="line">        <span class="literal">Err</span>(e) =&gt; &#123; GetResponse::<span class="literal">Err</span>(<span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, e)) &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    serde_json::to_writer(writer, &amp;resp);</span><br><span class="line">    writer.flush()?;</span><br><span class="line">    debug!(<span class="string">&quot;Response sent to &#123;&#125;: &#123;:?&#125;&quot;</span>, peer_addr, resp);</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// 使用宏</span></span><br><span class="line"><span class="built_in">macro_rules!</span> send_resp &#123;</span><br><span class="line">    ($resp:expr) =&gt; &#123;&#123;</span><br><span class="line">        <span class="keyword">let</span> resp = $resp;</span><br><span class="line">        serde_json::to_writer(&amp;<span class="keyword">mut</span> writer, &amp;resp)?;</span><br><span class="line">        writer.flush()?;</span><br><span class="line">        debug!(<span class="string">&quot;Response sent to &#123;&#125;: &#123;:?&#125;&quot;</span>, peer_addr, resp);</span><br><span class="line">    &#125;;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Request::Get &#123; key &#125; =&gt; send_resp!(</span><br><span class="line">    <span class="keyword">match</span> <span class="keyword">self</span>.engine.get(key) &#123;</span><br><span class="line">        <span class="literal">Ok</span>(value) =&gt; &#123; GetResponse::<span class="literal">Ok</span>(value) &#125;,</span><br><span class="line">        <span class="literal">Err</span>(e) =&gt; &#123; GetResponse::<span class="literal">Err</span>(<span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, e)) &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>kvs-server.rs</code>中使用<code>KvsServer</code>，此时可以将日志等级调整为<code>Debug</code>以方便调试：</p>
<figure class="highlight rust"><figcaption><span>bin/kvs-server.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> clap::Parser;</span><br><span class="line"><span class="keyword">use</span> kvs::&#123;<span class="built_in">Result</span>, KvsError, KvStore, KvsEngine, KvsServer&#125;;</span><br><span class="line"><span class="keyword">use</span> std::env::current_dir;</span><br><span class="line"><span class="keyword">use</span> std::fs;</span><br><span class="line"><span class="keyword">use</span> std::net::SocketAddr;</span><br><span class="line"><span class="keyword">use</span> std::process::exit;</span><br><span class="line"><span class="keyword">use</span> log::LevelFilter;</span><br><span class="line"><span class="keyword">use</span> log::&#123;error, info, warn&#125;;</span><br><span class="line"><span class="keyword">use</span> std::<span class="built_in">str</span>::FromStr;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> DEFAULT_LISTENING_ADDRESS: &amp;<span class="built_in">str</span> = <span class="string">&quot;127.0.0.1:4000&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> DEFAULT_ENGINE: Engine = Engine::kvs;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[allow(non_camel_case_types)]</span></span><br><span class="line"><span class="meta">#[derive(clap::ArgEnum, Copy, Clone, Debug, PartialEq, Eq)]</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Engine</span></span> &#123;</span><br><span class="line">   kvs,</span><br><span class="line">   sled,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> FromStr <span class="keyword">for</span> Engine &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Err</span></span> = KvsError;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from_str</span></span>(s: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> s &#123;</span><br><span class="line">            <span class="string">&quot;kvs&quot;</span> =&gt; &#123;</span><br><span class="line">                <span class="literal">Ok</span>(Engine::kvs)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;sled&quot;</span> =&gt; &#123;</span><br><span class="line">                <span class="literal">Ok</span>(Engine::sled)</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; &#123;</span><br><span class="line">                <span class="literal">Err</span>(KvsError::UnexpectedEngineType)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Parser, Debug)]</span></span><br><span class="line"><span class="meta">#[clap(name = <span class="meta-string">&quot;kvs-server&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[clap(author, version, about=<span class="meta-string">&quot;server of key value storage&quot;</span>, long_about=None)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Args</span></span> &#123;</span><br><span class="line">    <span class="comment">/// [IPADDR:PORT] of server.</span></span><br><span class="line">    <span class="meta">#[clap(long, default_value=DEFAULT_LISTENING_ADDRESS)]</span></span><br><span class="line">    addr: SocketAddr,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// backend engine of key value storage.</span></span><br><span class="line">    <span class="meta">#[clap(arg_enum, long, required(false))]</span></span><br><span class="line">    engine: <span class="built_in">Option</span>&lt;Engine&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() -&gt; <span class="built_in">Result</span>&lt;()&gt;&#123;</span><br><span class="line">    env_logger::builder().filter_level(LevelFilter::<span class="built_in">Debug</span>).init();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> args = Args::parse();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> res = current_engine().and_then(<span class="keyword">move</span> |curr_engine| &#123;</span><br><span class="line">        <span class="keyword">if</span> args.engine.is_none() &#123;</span><br><span class="line">            args.engine = curr_engine;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> curr_engine.is_some() &amp;&amp; args.engine != curr_engine &#123;</span><br><span class="line">            error!(<span class="string">&quot;Wrong engine!&quot;</span>);</span><br><span class="line">            exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        run(args)</span><br><span class="line">    &#125;);    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Err</span>(e) = res &#123;</span><br><span class="line">        error!(<span class="string">&quot;&#123;&#125;&quot;</span>, e);</span><br><span class="line">        exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="literal">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">run</span></span>(args: Args) -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> engine = args.engine.unwrap_or(DEFAULT_ENGINE);</span><br><span class="line">    info!(<span class="string">&quot;kvs-server &#123;&#125;&quot;</span>, <span class="built_in">env!</span>(<span class="string">&quot;CARGO_PKG_VERSION&quot;</span>));</span><br><span class="line">    info!(<span class="string">&quot;Storage engine: &#123;:?&#125;&quot;</span>, engine);</span><br><span class="line">    info!(<span class="string">&quot;Listening on &#123;&#125;&quot;</span>, args.addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// write engine to engine file</span></span><br><span class="line">    fs::write(current_dir()?.join(<span class="string">&quot;engine&quot;</span>), <span class="built_in">format!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, engine))?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> engine &#123;</span><br><span class="line">        Engine::kvs =&gt; run_with_engine(KvStore::open(current_dir()?)?, args.addr),</span><br><span class="line">        Engine::sled =&gt; <span class="literal">Ok</span>(()), <span class="comment">//TODO</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">run_with_engine</span></span>(engine: <span class="keyword">impl</span> KvsEngine, addr: SocketAddr) -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> server = KvsServer::new(engine);</span><br><span class="line">    server.run(addr)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">current_engine</span></span>() -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">Option</span>&lt;Engine&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> engine = current_dir()?.join(<span class="string">&quot;engine&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> !engine.exists() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">Ok</span>(<span class="literal">None</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> fs::read_to_string(engine)?.parse() &#123;</span><br><span class="line">        <span class="literal">Ok</span>(engine) =&gt; <span class="literal">Ok</span>(<span class="literal">Some</span>(engine)),</span><br><span class="line">        <span class="literal">Err</span>(e) =&gt; &#123;</span><br><span class="line">            warn!(<span class="string">&quot;The content of engine file is invalid: &#123;&#125;&quot;</span>, e);</span><br><span class="line">            <span class="literal">Ok</span>(<span class="literal">None</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来在<code>client.rs</code>中实现<code>KvsClient</code>：</p>
<figure class="highlight rust"><figcaption><span>client.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::&#123;io::&#123;BufReader, BufWriter, Write&#125;, net::&#123;TcpStream, ToSocketAddrs&#125;&#125;;</span><br><span class="line"><span class="keyword">use</span> crate::&#123;<span class="built_in">Result</span>, common::&#123;Request, GetResponse, SetResponse, RemoveResponse&#125;, KvsError&#125;;</span><br><span class="line"><span class="keyword">use</span> serde::Deserialize;</span><br><span class="line"><span class="keyword">use</span> serde_json::&#123;Deserializer, de::IoRead&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Key value store client</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">KvsClient</span></span> &#123;</span><br><span class="line">    reader: Deserializer&lt;IoRead&lt;BufReader&lt;TcpStream&gt;&gt;&gt;,</span><br><span class="line">    writer: BufWriter&lt;TcpStream&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> KvsClient &#123;</span><br><span class="line">    <span class="comment">/// Connect to `addr` to access `KvsServer`.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">connect</span></span>(addr: <span class="keyword">impl</span> ToSocketAddrs) -&gt; <span class="built_in">Result</span>&lt;<span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> tcp_reader = TcpStream::connect(addr)?;</span><br><span class="line">        <span class="keyword">let</span> tcp_writer = tcp_reader.try_clone()?;</span><br><span class="line">        <span class="literal">Ok</span>(KvsClient&#123;</span><br><span class="line">            reader: Deserializer::from_reader(BufReader::new(tcp_reader)),</span><br><span class="line">            writer: BufWriter::new(tcp_writer),</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Get the value of a given key from the server.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">get</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">Option</span>&lt;<span class="built_in">String</span>&gt;&gt; &#123;</span><br><span class="line">        serde_json::to_writer(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.writer, &amp;Request::Get &#123; key &#125;)?;</span><br><span class="line">        <span class="keyword">self</span>.writer.flush()?;</span><br><span class="line">        <span class="keyword">let</span> resp = GetResponse::deserialize(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.reader)?;</span><br><span class="line">        <span class="keyword">match</span> resp &#123;</span><br><span class="line">            GetResponse::<span class="literal">Ok</span>(value) =&gt; <span class="literal">Ok</span>(value),</span><br><span class="line">            GetResponse::<span class="literal">Err</span>(msg) =&gt; <span class="literal">Err</span>(KvsError::StringError(msg)),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Set the value of a string key in the server.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>, value: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        serde_json::to_writer(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.writer, &amp;Request::Set &#123; key, value &#125;)?;</span><br><span class="line">        <span class="keyword">self</span>.writer.flush()?;</span><br><span class="line">        <span class="keyword">let</span> resp = SetResponse::deserialize(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.reader)?;</span><br><span class="line">        <span class="keyword">match</span> resp &#123;</span><br><span class="line">            SetResponse::<span class="literal">Ok</span>(_) =&gt; <span class="literal">Ok</span>(()),</span><br><span class="line">            SetResponse::<span class="literal">Err</span>(msg) =&gt; <span class="literal">Err</span>(KvsError::StringError(msg)),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Remove a string key in the server.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">remove</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        serde_json::to_writer(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.writer, &amp;Request::Remove &#123; key &#125;)?;</span><br><span class="line">        <span class="keyword">self</span>.writer.flush()?;</span><br><span class="line">        <span class="keyword">let</span> resp = RemoveResponse::deserialize(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.reader)?;</span><br><span class="line">        <span class="keyword">match</span> resp &#123;</span><br><span class="line">            RemoveResponse::<span class="literal">Ok</span>(_) =&gt; <span class="literal">Ok</span>(()),</span><br><span class="line">            RemoveResponse::<span class="literal">Err</span>(msg) =&gt; <span class="literal">Err</span>(KvsError::StringError(msg)),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 并在<code>kvs-client.rs</code>中使用：</p>
<figure class="highlight rust"><figcaption><span>bin/kvs-client.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> clap::&#123;Parser, Subcommand&#125;;</span><br><span class="line"><span class="keyword">use</span> kvs::&#123;<span class="built_in">Result</span>, KvsClient&#125;;</span><br><span class="line"><span class="keyword">use</span> std::net::SocketAddr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> DEFAULT_LISTENING_ADDRESS: &amp;<span class="built_in">str</span> = <span class="string">&quot;127.0.0.1:4000&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Parser)]</span></span><br><span class="line"><span class="meta">#[clap(name = <span class="meta-string">&quot;kvs&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[clap(author, version, about=<span class="meta-string">&quot;an in-memory key/value store&quot;</span>, long_about=None, args_conflicts_with_subcommands(true))]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Cli</span></span> &#123;</span><br><span class="line">    <span class="meta">#[clap(subcommand)]</span></span><br><span class="line">    command: Commands,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Subcommand)]</span></span><br><span class="line"><span class="meta">#[allow(non_camel_case_types)]</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Commands</span></span> &#123;</span><br><span class="line">    <span class="comment">// Set the value of a string key to a string</span></span><br><span class="line">    <span class="meta">#[clap(arg_required_else_help=true)]</span></span><br><span class="line">    set &#123;</span><br><span class="line">        <span class="comment">// A string key</span></span><br><span class="line">        key: <span class="built_in">String</span>,</span><br><span class="line">        <span class="comment">// The string value of the key</span></span><br><span class="line">        value: <span class="built_in">String</span>,</span><br><span class="line"></span><br><span class="line">        <span class="meta">#[clap(long, required(false), default_value(DEFAULT_LISTENING_ADDRESS), help=<span class="meta-string">&quot;Set the server address as [IP:PORT]&quot;</span>)]</span></span><br><span class="line">        addr: SocketAddr</span><br><span class="line">    &#125;, </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the string value of a given string key</span></span><br><span class="line">    <span class="meta">#[clap(arg_required_else_help=true)]</span></span><br><span class="line">    get &#123;</span><br><span class="line">        <span class="comment">// A string key</span></span><br><span class="line">        key: <span class="built_in">String</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="meta">#[clap(long, required(false), default_value(DEFAULT_LISTENING_ADDRESS), help=<span class="meta-string">&quot;Set the server address as [IP:PORT]&quot;</span>)]</span></span><br><span class="line">        addr: SocketAddr</span><br><span class="line">    &#125;, </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove a given key</span></span><br><span class="line">    <span class="meta">#[clap(arg_required_else_help=true)]</span></span><br><span class="line">    rm &#123;</span><br><span class="line">        <span class="comment">// A string key</span></span><br><span class="line">        key: <span class="built_in">String</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="meta">#[clap(long, required(false), default_value(DEFAULT_LISTENING_ADDRESS), help=<span class="meta-string">&quot;Set the server address as [IP:PORT]&quot;</span>)]</span></span><br><span class="line">        addr: SocketAddr</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> cli= Cli::parse();</span><br><span class="line">    <span class="keyword">match</span> cli.command &#123;</span><br><span class="line">        Commands::get &#123; key, addr &#125; =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> client = KvsClient::connect(addr)?;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(value) = client.get(key.to_string())? &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;Key not found&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        Commands::set &#123; key, value, addr &#125; =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> client = KvsClient::connect(addr)?;</span><br><span class="line">            client.set(key.to_string(), value.to_string())?;</span><br><span class="line">        &#125;</span><br><span class="line">        Commands::rm &#123; key, addr &#125; =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> client = KvsClient::connect(addr)?;</span><br><span class="line">            client.remove(key)?;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="literal">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时一个终端打开<code>cargo run --bin kvs-server</code>，另一个终端运行<code>cargo run --bin kvs-client -- get key</code>，就可以从网络上将“训练课程2”中存入的<code>键: 值</code>取出来了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server</span></span><br><span class="line">(base) ➜  kvs git:(master) ✗ cargo run --bin kvs-server</span><br><span class="line">   Compiling kvs v0.1.0 (/Users/zealot/RustProjects/pingcap-projects/kvs)</span><br><span class="line">    Finished dev [unoptimized + debuginfo] target(s) <span class="keyword">in</span> 1.14s</span><br><span class="line">     Running `target/debug/kvs-server`</span><br><span class="line">[2022-06-03T10:38:45Z INFO  kvs_server] kvs-server 0.1.0</span><br><span class="line">[2022-06-03T10:38:45Z INFO  kvs_server] Storage engine: kvs</span><br><span class="line">[2022-06-03T10:38:45Z INFO  kvs_server] Listening on 127.0.0.1:4000</span><br><span class="line">[2022-06-03T10:38:49Z DEBUG kvs::server] Receive request from 127.0.0.1:55017 Get &#123; key: <span class="string">&quot;键&quot;</span> &#125;</span><br><span class="line">[2022-06-03T10:38:49Z DEBUG kvs::server] Response sent to 127.0.0.1:55017: Ok(Some(<span class="string">&quot;值&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># client</span></span><br><span class="line">(base) ➜  kvs git:(master) ✗ cargo run --bin kvs-client -- get 键</span><br><span class="line">    Finished dev [unoptimized + debuginfo] target(s) <span class="keyword">in</span> 0.08s</span><br><span class="line">     Running `target/debug/kvs-client get <span class="string">&#x27;键&#x27;</span>`</span><br><span class="line">值</span><br></pre></td></tr></table></figure>

<h2 id="第4部分：通过网络处理命令"><a href="#第4部分：通过网络处理命令" class="headerlink" title="第4部分：通过网络处理命令"></a>第4部分：通过网络处理命令</h2><p>在上一个项目中，您定义了数据库接受的命令，并学习了如何使用<code>serde</code>对日志进行序列化和反序列化。</p>
<p>现在是时候通过网络实现键/值存储，以通过前面实现的同步单进程模型远程执行命令。与您在上一个项目中创建日志的文件I/O一样，您将使用<code>Read</code>和<code>Write</code>特征序列化和流式传输命令。</p>
<p>现在您需要设计一个网络协议。有多种方法可以在TCP流上数读写数据，与上一个项目一样，也需要做出许多选择。该协议是基于文本还是二进制？数据如何从内存中的类型格式转换为字节流格式？每个连接传输一个还是多个请求？</p>
<p>请记住，该协议应支持执行成功并取回结果，也支持执行时遇到的错误，现在有两种错误：由您的存储引擎产生的错误，以及由网络通信产生的错误。</p>
<p>协议的所有细节都由您决定。测试套件不关心数据如何从一端到达另一端，只关心结果是否正确。</p>
<p><em>实现您的网络协议。</em></p>
<hr>
<p>前面我们已经一并实现了该协议，需要注意的是，只要进行适当的定义，序列化的所有类型转换都是自动完成的。</p>
<h2 id="第5部分：可插拔存储引擎"><a href="#第5部分：可插拔存储引擎" class="headerlink" title="第5部分：可插拔存储引擎"></a>第5部分：可插拔存储引擎</h2><p>您的数据库目前有一个由您实现的存储引擎<code>KvStore</code>。现在将添加第二个存储引擎。</p>
<p>这样做有多种原因：</p>
<ul>
<li>不同的业务负载需要不同的性能特征。对于特定的业务负载，某些存储引擎可能比其他存储引擎工作得更好；</li>
<li>搭建了一个熟悉的框架来比较不同的后端；</li>
<li>给了我们一个创建和使用trait的理由；</li>
<li>给了我们一个编写比较基准的环境。</li>
</ul>
<p>所以你要从<code>KvStore</code>接口中<em>抽象出</em>一个新的特征：<code>KvsEngine</code>。这是一个典型的重构，将现有代码逐步修改为新的形式。一般在重构时，我们希望将工作最小化分解，以便进行持续构建和修改。</p>
<p>这是您最终需要的API：</p>
<ul>
<li><code>KvsEngine</code>trait具有与<code>KvStore</code>具有相同签名的<code>get</code>、<code>set</code>和<code>remove</code>方法。</li>
<li><code>KvStore</code>实现了<code>KvsEngine</code>，不再有自己的<code>get</code>、<code>set</code>和<code>remove</code>方法。</li>
<li><code>KvsEngine</code>有一个新的实现——<code>SledKvsEngine</code>。稍后您需要使用<code>sled</code>库填充其<code>get</code>和<code>set</code>方法。</li>
</ul>
<p>如果您的测试套件通过编译，则可能已经了编写了这些定义的签名，现在是时候实现定义的内容了。将重构分解为渐进式修改，并确保项目能够持续构建，并通过先前已经通过的测试，然后再继续下一步重构。</p>
<p>作为最后一步，您需要考虑当<code>kvs-server</code>使用一个引擎启动，然后进程被终结，接下来再使用不同的引擎重新启动时会发生什么。这种情况应当产生错误，你需要想清楚如何检测这种情况才能报告错误。测试<code>cli_wrong_engine</code>反映了这种情况。</p>
<hr>
<p>本项目一开始，为了通过测试，我们已经实现了<code>KvsEngine</code>的签名，又在第3部分提前将<code>KvStore</code>的几个方法移动至<code>KvsEngine</code>的实现中。而在本项目需求说明部分，为了实现引擎切换报错，我们已经实现了启动时检测<code>engine</code>文件内容的功能：</p>
<ul>
<li>若未检测到<code>engine</code>文件，则将本次使用的引擎写入<code>engine</code>文件（不指定时默认使用<code>kvs</code>）。</li>
<li>若检测到<code>engine</code>文件，当文件记录引擎与当前指定引擎不一致时，报错；一致时则继续执行。</li>
</ul>
<p>在<code>engine/sled.rs</code>中为<a target="_blank" rel="noopener" href="https://github.com/spacejam/sled"><code>sled</code></a>实现<code>KvsEngine</code>：</p>
<figure class="highlight rust"><figcaption><span>engine/sled.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> sled::&#123;Db, Tree&#125;;</span><br><span class="line"><span class="keyword">use</span> crate::&#123;KvsEngine, <span class="built_in">Result</span>, KvsError&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Wrapper of `sled::Db`</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">SledKvStore</span></span> &#123;</span><br><span class="line">    db: Db,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> SledKvStore &#123;</span><br><span class="line">    <span class="comment">/// Creates a `SledKvsEngine` from `sled::Db`.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(db: Db) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123; db &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> KvsEngine <span class="keyword">for</span> SledKvStore &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">get</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">Option</span>&lt;<span class="built_in">String</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> tree: &amp;Tree = &amp;<span class="keyword">self</span>.db;</span><br><span class="line">        <span class="literal">Ok</span>(</span><br><span class="line">            tree.get(key)?</span><br><span class="line">                .map(|iv| <span class="built_in">AsRef</span>::&lt;[<span class="built_in">u8</span>]&gt;::as_ref(&amp;iv).to_vec())</span><br><span class="line">                .map(<span class="built_in">String</span>::from_utf8)</span><br><span class="line">                .transpose()?</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">set</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>, value: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> tree: &amp;Tree = &amp;<span class="keyword">self</span>.db;</span><br><span class="line">        tree.insert(key, value.into_bytes()).map(|_| ())?;</span><br><span class="line">        tree.flush()?;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">remove</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> tree: &amp;Tree = &amp;<span class="keyword">self</span>.db;</span><br><span class="line">        tree.remove(key)?.ok_or(KvsError::KeyNotFound)?;</span><br><span class="line">        tree.flush()?;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在<code>kvs-server.rs</code>中调用<code>SledKvStore</code>，以补全最后一个<code>//TODO</code>：</p>
<figure class="highlight rust"><figcaption><span>bin/kvs-server.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">match</span> engine &#123;</span><br><span class="line">    Engine::kvs =&gt; run_with_engine(KvStore::open(current_dir()?)?, args.addr),</span><br><span class="line">    Engine::sled =&gt; run_with_engine(SledKvStore::new(sled::open(current_dir()?)?), args.addr), </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<h2 id="第6部分：基准测试"><a href="#第6部分：基准测试" class="headerlink" title="第6部分：基准测试"></a>第6部分：基准测试</h2><p>随着课程的进展，我们将越来越关注数据库的性能，探索不同架构对性能产生的影响。我们希望您不要局限于本文所展示的内容，多尝试自己的优化。</p>
<p>性能比对需要基准测试，目前有很多方法可以对数据库进行基准测试：例如使用<a target="_blank" rel="noopener" href="https://github.com/brianfrankcooper/YCSB">ycsb</a>和<a target="_blank" rel="noopener" href="https://github.com/akopytov/sysbench">sysbench</a>等标准测试套件。Rust内置了一些基准测试工具，我们将从此处入手。</p>
<p>Cargo支持使用<code>cargo bench</code>进行基准测试。基准测试可以使用Rust内置的基准测试工具编写，也可以使用外部工具编写。</p>
<p>为函数添加#[bench]属性即可启用内置基准测试套件。不过这一功能并不在Rust stable channel中提供，仅在<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/stable/unstable-book/library-features/test.html">the unstable book</a>和<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/stable/test/index.html"><code>test</code> crate docs</a>中有简略描述。尽管它在整个Rust生态中已被广泛使用&mdash;这些crates即使使用stable编译，也会用nightly进行基准测试。</p>
<p>尽管该系统实际上已被弃用&mdash;没有更新，且似乎永远不会被提升到stable channel。</p>
<p>不过，Rust也有更好的基准测试工具。本项目将使用<a target="_blank" rel="noopener" href="https://docs.rs/criterion"><code>criterion</code></a>来对比<code>kvs</code>引擎与<code>sled</code>引擎的性能。</p>
<p>这这些基准测试工具的工作原理是定义一个基准测试函数，然后在该函数内循环迭代要执行的基准测试操作。基准测试工具将根据需要进行多次迭代，以获取具有统计意义的操作持续时间。</p>
<p>这是criterion指南中的这个基础示例：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">criterion_benchmark</span></span>(c: &amp;<span class="keyword">mut</span> Criterion) &#123;</span><br><span class="line">    c.bench_function(<span class="string">&quot;fib 20&quot;</span>, |b| &#123;</span><br><span class="line">        b.iter(|| &#123;</span><br><span class="line">            fibonacci(<span class="number">20</span>)</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用<code>bench_function</code>定义基准，调用<code>iter</code>定义为基准需要测试的代码。调用<code>iter</code>之前和之后的代码不计入基准测试时间。</p>
<p>通过创建一个名为<code>benches/engine_benches.rs</code>的文件来准备编写基准测试。同<code>tests/tests.rs</code>一样，cargo会自动找到这个文件并将其编译为基准测试。</p>
<p>首先编写以下基准测试：</p>
<ul>
<li><code>kvs_write</code>&mdash;使用<code>kvs</code>引擎，使用长度为1-100000字节的随机键 和 长度为1-100000字节的随机值 写入100次；</li>
<li><code>sled_write</code>&mdash;使用<code>sled</code>引擎，使用长度为1-100000字节的随机键 和 长度为1-100000字节的随机值 写入100次；</li>
<li><code>kvs_read</code>&mdash;使用<code>kvs</code>引擎，从先前写入的键中读取1000个值，键和值的长度是随机的；</li>
<li><code>sled_read</code>&mdash;使用<code>sled</code>引擎，从先前写入的键中读取1000个值，键和值的长度是随机的；</li>
</ul>
<p>（除了像上面描述的这样编写4个基准测试，您也可以用这2个引擎名作为参数编写参数化的基准测试，参见<a target="_blank" rel="noopener" href="https://bheisler.github.io/criterion.rs/book/user_guide/benchmarking_with_inputs.html">criterion手册</a>）。</p>
<p>对于实现这些基准测试的技术细节，我们至少需要考虑三个因素：</p>
<ul>
<li>哪些代码应该计时（写在基准测试循环内），哪些代码不应该计时（写在基准测试循环之外）？</li>
<li>尽管使用“随机”数字，如何使每次迭代执行相同操作。</li>
<li>在”read”的基准测试中，如何使用之前写入的同一组“随机”键读取值。</li>
</ul>
<p>这些都是相互关联的：用作基准测试环境设置的代码应为非计时代码，此外还需要适当地重用随机数种子以复现测试环境。</p>
<p>在各种情况下，可能返回错误的操作都应该断言（使用<code>assert</code>!）它们没有返回错误；在”read”测试中，”get”操作应该断言找到了该键的值。</p>
<p>随机数可以使用<code>rand</code>crate生成。</p>
<p>编写完基准测试函数，就使用<code>cargo bench</code>运行它们。</p>
<p><em>完成上面的基准测试，对比<code>kvs</code>和<code>sled</code>的性能差距。</em></p>
<p><em>注意：请在没什么负载的主机上运行基准测试。基准测试对其运行​​环境非常敏感，虽然criterion库会尽力修正这些“噪音”，但最好在没有其他活动进程的干净机器上进行基准测试。如果您有一台仅用于开发的备用机器，请使用它。如果没有，AWS或其他云实例可能会产生比本地桌面更一致的结果。</em></p>
<hr>
<p>在<code>Cargo.toml</code>中声明基准测试：</p>
<figure class="highlight toml"><figcaption><span>Cargo.toml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[[bench]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;engine_benches&quot;</span></span><br><span class="line"><span class="attr">harness</span> = <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>在<code>engine_benches.rs</code>中编写基准测试：</p>
<figure class="highlight rust"><figcaption><span>benches/engine_benches.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> criterion::&#123;Criterion, BatchSize, criterion_group, criterion_main&#125;;</span><br><span class="line"><span class="keyword">use</span> kvs::&#123;KvStore, KvsEngine, SledKvStore&#125;;</span><br><span class="line"><span class="keyword">use</span> rand::&#123;rngs::SmallRng, SeedableRng, Rng&#125;;</span><br><span class="line"><span class="keyword">use</span> sled;</span><br><span class="line"><span class="keyword">use</span> tempfile::TempDir;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">set_benches</span></span>(c: &amp;<span class="keyword">mut</span> Criterion) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> group = c.benchmark_group(<span class="string">&quot;set_benches&quot;</span>);</span><br><span class="line">    group.bench_function(<span class="string">&quot;kvs&quot;</span>, |b| &#123;</span><br><span class="line">        b.iter_batched(</span><br><span class="line">            || &#123;</span><br><span class="line">            <span class="keyword">let</span> temp_dir = TempDir::new().unwrap();</span><br><span class="line">            (KvStore::open(temp_dir.path()).unwrap(), temp_dir)</span><br><span class="line">            &#125;, </span><br><span class="line">            |(<span class="keyword">mut</span> store, _temp_dir)| &#123;</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>..(<span class="number">1</span> &lt;&lt; <span class="number">12</span>) &#123;</span><br><span class="line">                    store.set(<span class="built_in">format!</span>(<span class="string">&quot;key-&#123;&#125;&quot;</span>, i), <span class="built_in">format!</span>(<span class="string">&quot;value-&#123;&#125;&quot;</span>, i)).unwrap();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, </span><br><span class="line">            BatchSize::SmallInput</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line">    group.bench_function(<span class="string">&quot;sled&quot;</span>, |b| &#123;</span><br><span class="line">        b.iter_batched(</span><br><span class="line">            || &#123;</span><br><span class="line">            <span class="keyword">let</span> temp_dir = TempDir::new().unwrap();</span><br><span class="line">            (SledKvStore::new(sled::open(&amp;temp_dir).unwrap()), temp_dir)</span><br><span class="line">            &#125;, </span><br><span class="line">            |(<span class="keyword">mut</span> store, _temp_dir)| &#123;</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>..(<span class="number">1</span> &lt;&lt; <span class="number">12</span>) &#123;</span><br><span class="line">                    store.set(<span class="built_in">format!</span>(<span class="string">&quot;key-&#123;&#125;&quot;</span>, i), <span class="built_in">format!</span>(<span class="string">&quot;value-&#123;&#125;&quot;</span>, i)).unwrap();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, </span><br><span class="line">            BatchSize::SmallInput</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">get_benches</span></span>(c: &amp;<span class="keyword">mut</span> Criterion) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> group = c.benchmark_group(<span class="string">&quot;get_benches&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> &amp;<span class="built_in">vec!</span>[<span class="number">8</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">20</span>] &#123;</span><br><span class="line">        group.bench_with_input(<span class="built_in">format!</span>(<span class="string">&quot;kvs_&#123;&#125;&quot;</span>, i), i, |b, i| &#123;</span><br><span class="line">            <span class="keyword">let</span> temp_dir = TempDir::new().unwrap();</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> store = KvStore::open(temp_dir.path()).unwrap();</span><br><span class="line">            <span class="keyword">for</span> key_i <span class="keyword">in</span> <span class="number">1</span>..(<span class="number">1</span> &lt;&lt; i) &#123;</span><br><span class="line">                store.set(<span class="built_in">format!</span>(<span class="string">&quot;key-&#123;&#125;&quot;</span>, key_i), <span class="built_in">format!</span>(<span class="string">&quot;value-&#123;&#125;&quot;</span>, key_i)).unwrap();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> rng = SmallRng::from_seed([<span class="number">0</span>; <span class="number">16</span>]);</span><br><span class="line">            b.iter(|| &#123;</span><br><span class="line">                store.get(<span class="built_in">format!</span>(<span class="string">&quot;key-&#123;&#125;&quot;</span>, rng.gen_range(<span class="number">1</span>, <span class="number">1</span> &lt;&lt; i))).unwrap();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> &amp;<span class="built_in">vec!</span>[<span class="number">8</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">20</span>] &#123;</span><br><span class="line">        group.bench_with_input(<span class="built_in">format!</span>(<span class="string">&quot;sled_&#123;&#125;&quot;</span>, i), i, |b, i| &#123;</span><br><span class="line">            <span class="keyword">let</span> temp_dir = TempDir::new().unwrap();</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> store = SledKvStore::new(sled::open(&amp;temp_dir).unwrap());</span><br><span class="line">            <span class="keyword">for</span> key_i <span class="keyword">in</span> <span class="number">1</span>..(<span class="number">1</span> &lt;&lt; i) &#123;</span><br><span class="line">                store.set(<span class="built_in">format!</span>(<span class="string">&quot;key-&#123;&#125;&quot;</span>, key_i), <span class="built_in">format!</span>(<span class="string">&quot;value-&#123;&#125;&quot;</span>, key_i)).unwrap();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> rng = SmallRng::from_seed([<span class="number">0</span>; <span class="number">16</span>]);</span><br><span class="line">            b.iter(|| &#123;</span><br><span class="line">                store.get(<span class="built_in">format!</span>(<span class="string">&quot;key-&#123;&#125;&quot;</span>, rng.gen_range(<span class="number">1</span>, <span class="number">1</span> &lt;&lt; i))).unwrap();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">criterion_group!(benches, set_benches, get_benches);</span><br><span class="line">criterion_main!(benches);</span><br></pre></td></tr></table></figure>

<p>干得漂亮，朋友。休息一下吧。</p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Rust/">Rust</a></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><div class="social-share"></div><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechatpay.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/06/18/pna-rust-project-4/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">PingCap的Rust训练课程4：并发与并行</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/03/11/pna-rust-project-2/"><span class="level-item">PingCap的Rust训练课程2：日志结构文件I/O</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><script src="https://utteranc.es/client.js" repo="zlotus/comment" issue-term="pathname" label="some-issue-label" theme="github-light" crossorigin="anonymous" async></script></div></div></div><div class="column column-left is-3-tablet is-3-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/opm_sq.png" alt="子实"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">子实</p><p class="is-size-6 is-block">程序员</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>陕西/西安</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">79</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">23</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/zlotus" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/zlotus"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com/qinzishi"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/Zealot_uS"><i class="fab fa-twitter"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.zhihu.com/people/zlotus" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">知乎</span></span><span class="level-right"><span class="level-item tag">www.zhihu.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Diary/"><span class="level-start"><span class="level-item">Diary</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/"><span class="level-start"><span class="level-item">Programming</span></span><span class="level-end"><span class="level-item tag">65</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Shell/"><span class="level-start"><span class="level-item">Shell</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Coroutines/"><span class="tag">Coroutines</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaScript/"><span class="tag">JavaScript</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Javascript/"><span class="tag">Javascript</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">31</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenCV/"><span class="tag">OpenCV</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Operating-System/"><span class="tag">Operating System</span><span class="tag">21</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Paper/"><span class="tag">Paper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">18</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Raspberry-Pi/"><span class="tag">Raspberry Pi</span><span class="tag">20</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Rust/"><span class="tag">Rust</span><span class="tag">29</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Shell/"><span class="tag">Shell</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TensorFlow/"><span class="tag">TensorFlow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Tokio/"><span class="tag">Tokio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ZMQ/"><span class="tag">ZMQ</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ctpn/"><span class="tag">ctpn</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/llama/"><span class="tag">llama</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macOS/"><span class="tag">macOS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/obsidion/"><span class="tag">obsidion</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%A5%E8%AE%B0/"><span class="tag">日记</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E8%B0%88/"><span class="tag">杂谈</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%AE%97%E6%B3%95/"><span class="tag">算法</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BC%96%E7%A8%8B/"><span class="tag">编程</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%84%9A%E6%9C%AC/"><span class="tag">脚本</span><span class="tag">4</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/opm_sq.png" alt="子实" height="28"></a><p class="is-size-7"><span>&copy; 2024 子实</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>