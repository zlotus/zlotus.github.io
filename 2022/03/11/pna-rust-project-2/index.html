<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>PingCap的Rust训练课程2：日志结构文件I/O - 子实</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="子实"><meta name="msapplication-TileImage" content="/img/avatar-o.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="子实"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="PingCap的Rust训练课程2：日志结构文件I&amp;#x2F;O"><meta property="og:type" content="article"><meta property="og:title" content="PingCap的Rust训练课程2：日志结构文件I/O"><meta property="og:url" content="https://zlotus.github.io/2022/03/11/pna-rust-project-2/"><meta property="og:site_name" content="子实"><meta property="og:description" content="PingCap的Rust训练课程2：日志结构文件I&amp;#x2F;O"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://zlotus.github.io/img/og_image.png"><meta property="article:published_time" content="2022-03-11T10:50:00.000Z"><meta property="article:modified_time" content="2022-03-11T10:50:00.000Z"><meta property="article:author" content="子实"><meta property="article:tag" content="Rust"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><meta property="twitter:creator" content="@Zealot_uS"><meta property="twitter:site" content="Zealot_uS"><link rel="publisher" href="+LotusQin"><meta property="fb:admins" content="qinzishi"><meta property="fb:app_id" content="qinzishi"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zlotus.github.io/2022/03/11/pna-rust-project-2/"},"headline":"PingCap的Rust训练课程2：日志结构文件I/O","image":["https://zlotus.github.io/img/og_image.png"],"datePublished":"2022-03-11T10:50:00.000Z","dateModified":"2022-03-11T10:50:00.000Z","author":{"@type":"Person","name":"子实"},"publisher":{"@type":"Organization","name":"子实","logo":{"@type":"ImageObject","url":"https://zlotus.github.io/img/opm_sq.png"}},"description":"PingCap的Rust训练课程2：日志结构文件I&#x2F;O"}</script><link rel="icon" href="/img/avatar-o.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><!--!--><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/opm_sq.png" alt="子实" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/2014/07/09/about-me/">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zlotus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-9-tablet is-9-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-03-11T10:50:00.000Z" title="3/11/2022, 6:50:00 PM">2022-03-11</time>发表</span><span class="level-item"><time dateTime="2022-03-11T10:50:00.000Z" title="3/11/2022, 6:50:00 PM">2022-03-11</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a></span><span class="level-item">1 小时读完 (大约7094个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">PingCap的Rust训练课程2：日志结构文件I/O</h1><div class="content"><article class="message message-immersive is-warning">
<div class="message-body">
<i class="fas fa-exclamation-triangle mr-2"></i>本文内容大多翻译自原文：<a target="_blank" rel="noopener" href="https://github.com/pingcap/talent-plan/tree/master/courses/rust/projects/project-2">PNA Rust Project 2: Log-structured file I/O</a>。
</div>
</article>

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>任务</strong>：创建一个键/值存储程序，能够<em>从命令行访问</em>，支持<em>持久化</em>。</p>
<p><strong>目标</strong>：</p>
<ul>
<li>编写健壮的错误和异常处理</li>
<li>使用<code>serde</code>进行序列化</li>
<li>使用标准文件API将数据作为日志写入磁盘</li>
<li>从磁盘读取键/值数据的状态</li>
<li>将内存中的索引键映射在磁盘的对应值上</li>
<li>定期压缩日志以删除过期数据</li>
</ul>
<p><strong>关键词</strong>：日志结构文件I/O、bitcask、<code>failure</code>crate、<code>Read</code>/<code>Write</code>trait、<code>serde</code>crate。</p>
<p><strong>扩展练习</strong>：尝试使用<code>structopt</code>crate。</p>
<span id="more"></span>

<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>在这个项目中，您将创建一个简单的基于磁盘的键/值存储程序，并可以通过命令行进行修改和查询。它将使用简化版的<a target="_blank" rel="noopener" href="https://github.com/basho/bitcask">bitcask</a>存储算法，该算法在简单和有效之间做了较好的平衡。您的第一个任务是在磁盘上维护先前写入命令的日志（有时称为“<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Write-ahead_logging">预写日志</a>”或“WAL”），在程序启动时，通过对日志求值（译注：即按顺序执行日志）就能够在内存中重建数据库状态。您的第二个任务是继续拓展该程序，将键存储在内存中，将值存储到磁盘的日志中。您的最后一个任务是添加日志压缩功能，以确保日志不会无限增长。在这个项目结束时，您将使用Rust文件API构建一个简单且架构良好的数据库。</p>
<h2 id="专业术语"><a href="#专业术语" class="headerlink" title="专业术语"></a>专业术语</h2><p>下面列出本课程中使用的一些术语，部分参考了<a target="_blank" rel="noopener" href="https://github.com/basho/bitcask">bitcask</a>，不同的数据库会有略微不同的术语：</p>
<ul>
<li><em>命令（command）</em> - 一条对数据库的请求或一条请求的表示。命令来源于命令行或网络。命令有三种表示：内存表示、文本表示以及机器可读的序列化表示。</li>
<li><em>日志（log）</em> - 由多条命令组成的序列，按照最初接收和执行的顺序放置在磁盘上。我们数据库在磁盘上的格式几乎完全由日志组成。这种实现很简单，而且非常高效。</li>
<li><em>日志指针（log pointer）</em> - 日志中的文件偏移量，有时我们将其简称为“文件偏移量”（file offset）。</li>
<li><em>日志压缩（log compaction）</em> - 当向数据库发出写入请求时，新的请求有时会使旧的日志条目无效。例如，写入键/值<code>a = 0</code>，之后再写入<code>a = 1</code>，这就会使”a”的第一条日志失效。压缩 &mdash; 至少在我们的数据库中 &mdash; 是一个从日志中删除过期的命令以减小数据库大小的过程。</li>
<li><em>内存索引/索引（in-memory index/index）</em> - 指向日志指针的键映射。当发出读请求时，会在内存索引中查找相应的日志指针，找到后从磁盘日志中取回该值。我们的键/值存储程序与bitcask类似，整个数据库的索引都存储在内存中。</li>
<li><em>索引文件（index file）</em> - 内存索引的磁盘表示。如果没有该文件，则每次启动数据库时都需要重放日志（重新执行整个日志）以恢复内存索引的状态。</li>
</ul>
<h2 id="项目需求规格"><a href="#项目需求规格" class="headerlink" title="项目需求规格"></a>项目需求规格</h2><p>cargo项目<code>kvs</code>构建了一个名为<code>kvs</code>的命令行键值存储客户端，该客户端又调用了一个名为<code>kvs</code>的库。</p>
<p><code>kvs</code>可执行文件支持以下命令行参数：</p>
<ul>
<li><code>kvs set &lt;KEY&gt; &lt;VALUE&gt;</code><br>将字符串键的值设置为字符串值。打印错误并在失败时返回非零退出码。</li>
<li><code>kvs get &lt;KEY&gt;</code><br>获取给定字符串键的字符串值。打印错误并在失败时返回非零退出码。</li>
<li><code>kvs rm &lt;KEY&gt;</code><br> 删除给定的键。打印错误并在失败时返回非零退出码。</li>
<li><code>kvs -V</code><br>打印版本。</li>
</ul>
<p><code>kvs</code>库包含一个类型，<code>KvStore</code>，它支持以下方法：</p>
<ul>
<li><code>KvStore::set(&amp;mut self, key: String, value: String) -&gt; Result&lt;()&gt;</code><br>将字符串键设置为字符串值。如果值未设置成功，则返回错误。</li>
<li><code>KvStore::get(&amp;mut self, key: String) -&gt; Result&lt;Option&lt;String&gt;&gt;</code><br>获取字符串键的字符串值。如果键不存在，则返回<code>None</code>。如果读取键值未成功，则返回错误。</li>
<li><code>KvStore::remove(&amp;mut self, key: String) -&gt; Result&lt;()&gt;</code><br>删除给定的key。如果key不存在或未成功删除，则返回错误。</li>
<li><code>KvStore::open(path: impl Into&lt;PathBuf&gt;) -&gt; Result&lt;KvStore&gt;</code><br>从给定路径打开KvStore。返回KvStore。</li>
</ul>
<p>在设置键值时，<code>kvs</code>将这条<code>set</code>命令写入位于磁盘的顺序日志中，然后将该命令的日志指针（文件偏移量）存储在内存索引中，即从键映射到日志指针。删除键时，类似地，<code>kvs</code>会在日志中写入<code>rm</code>命令，然后从内存索引中删除该键。当使用<code>get</code>命令检索键的值时，它会搜索内存索引，如果找到，则从日志中加载对应日志指针处的命令，对命令求值（译注：执行命令）并返回结果。</p>
<p>启动时，按时间顺序遍历日志中的命令，即可重建内存索引。</p>
<p>当未压缩日志记录大小达到给定阈值时，<code>kvs</code>会将其压缩到新日志中，删除冗余条目以回收磁盘空间。</p>
<p>请注意，我们的<code>kvs</code>项目既是一个无状态的命令行程序，也是一个包含有状态<code>KvStore</code>类型的库：作为命令行程序使用，<code>KvStore</code>类型将加载索引、执行命令、并退出；作为库使用，它将加载索引，然后执行多条命令，维护索引状态，直到它被删除。</p>
<h2 id="项目设置"><a href="#项目设置" class="headerlink" title="项目设置"></a>项目设置</h2><p>在上一个项目的基础上进行本项目，删除上一个项目的<code>tests</code>目录，将本项目的<code>tests</code>目录复制到该位置。和上一个项目一样，本项目应该包含一个库和一个可执行文件，两者都叫做<code>kvs</code>。</p>
<p><code>Cargo.toml</code>中需要以下开发依赖项：</p>
<figure class="highlight toml"><figcaption><span>Cargo.toml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dev-dependencies]</span></span><br><span class="line"><span class="attr">assert_cmd</span> = <span class="string">&quot;0.11.0&quot;</span></span><br><span class="line"><span class="attr">predicates</span> = <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line"><span class="attr">tempfile</span> = <span class="string">&quot;3.0.7&quot;</span></span><br><span class="line"><span class="attr">walkdir</span> = <span class="string">&quot;2.2.7&quot;</span></span><br></pre></td></tr></table></figure>

<p>与上一个项目一样，先编写空函数或panic来构建测试用例。</p>
<p><em>现在就试试吧。</em></p>
<hr>
<p>我的作业：</p>
<figure class="highlight rust"><figcaption><span>lib.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 若仅让tests能够运行，则需要修改的地方很少</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加`PathBuf`导入</span></span><br><span class="line"><span class="keyword">use</span> std::&#123;collections::HashMap, path::PathBuf&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加Result&lt;T&gt;类型</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">Result</span></span>&lt;T&gt; = std::result::<span class="built_in">Result</span>&lt;T, ()&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改`KvStore`中函数的返回类型</span></span><br><span class="line"><span class="keyword">impl</span> KvStore &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">open</span></span>(path: <span class="keyword">impl</span> <span class="built_in">Into</span>&lt;PathBuf&gt;) -&gt; <span class="built_in">Result</span>&lt;KvStore&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(Self::new())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">get</span></span>(&amp;<span class="keyword">self</span>, key: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">Option</span>&lt;<span class="built_in">String</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.db.get(&amp;key) &#123;</span><br><span class="line">            <span class="literal">Some</span>(value) =&gt; <span class="literal">Ok</span>(<span class="literal">Some</span>(value.to_string())),</span><br><span class="line">            <span class="literal">None</span> =&gt; <span class="literal">Err</span>(())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>, value: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.db.insert(key, value);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">remove</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;()&gt;&#123;</span><br><span class="line">        <span class="keyword">self</span>.db.remove(&amp;key);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>cargo test</code>结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">running 17 tests</span><br><span class="line">test cli_invalid_subcommand ... ok</span><br><span class="line">test cli_get_non_existent_key ... FAILED</span><br><span class="line">test cli_rm_non_existent_key ... FAILED</span><br><span class="line">test cli_get_stored ... FAILED</span><br><span class="line">test cli_no_args ... ok</span><br><span class="line">test get_non_existent_value ... FAILED</span><br><span class="line">test get_stored_value ... FAILED</span><br><span class="line">test compaction ... FAILED</span><br><span class="line">test cli_invalid_get ... ok</span><br><span class="line">test overwrite_value ... FAILED</span><br><span class="line">test remove_non_existent_key ... FAILED</span><br><span class="line">test cli_version ... ok</span><br><span class="line">test remove_key ... FAILED</span><br><span class="line">test cli_invalid_rm ... ok</span><br><span class="line">test cli_set ... FAILED</span><br><span class="line">test cli_rm_stored ... FAILED</span><br><span class="line">test cli_invalid_set ... ok</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="第1部分：异常处理"><a href="#第1部分：异常处理" class="headerlink" title="第1部分：异常处理"></a>第1部分：异常处理</h2><p>在本项目中，代码运行时可能会因为I/O错误而失败。因此，在开始实现数据库之前，我们需要再做一件对Rust项目至关重要的事情：确定错误处理策略。</p>
<p>Rust的错误处理功能强大，但需要大量模板代码才能正确使用。本项目使用<a target="_blank" rel="noopener" href="https://docs.rs/failure/0.1.5/failure/"><code>failure</code></a>crate以获得轻松处理各种错误的工具。</p>
<p><a target="_blank" rel="noopener" href="https://boats.gitlab.io/failure/">异常处理指南</a>描述了<a target="_blank" rel="noopener" href="https://boats.gitlab.io/failure/guidance.html">几种</a>常见的错误处理模式。</p>
<p>在您的实现中，选择其中一种策略，定义您自己的错误类型，或导入<code>failures</code>的<code>Error</code>。您将在所有<code>Result</code>中使用该错误类型，使用<code>?</code>运算符将其他crate中的错误类型转换为您自己定义的错误类型。</p>
<p>接下来，给包含您自定义错误类型的<code>Result</code>起一个类型别名，这样您就不需要在项目中键入<code>Result&lt;T, YourErrorType&gt;</code>了，只需<code>Result&lt;T&gt;</code>即可。这是Rust中常见的模式。</p>
<p>最后，使用<code>use</code>语句将这些类型导入您的可执行文件，并更改<code>main</code>函数签名以返回<code>Result&lt;()&gt;</code>。库中所有可能失败的函数都会将这些<code>Result</code>沿栈一路向下传递到<code>main</code>，然后传递到Rust运行时并打印出错误信息。</p>
<p>运行<code>cargo check</code>查找编译器错误并予以修复。目前可以用<code>panic!()</code>结束<code>main</code>函数以使项目通过编译。</p>
<p><em>在继续之前确定您的异常处理策略</em>。</p>
<p>与之前的项目一样，您需要创建用于占位的数据结构和方法，以使测试能够编译。现在您已经定义了一个错误类型，通过编译应该很简单。可以在任何地方添加panic以使得测试套件能够通过编译（<code>cargo test --no-run</code>）。</p>
<p>注意：Rust中的错误处理实践仍在不断发展。本课程目前使用<a target="_blank" rel="noopener" href="https://docs.rs/failure/0.1.5/failure/"><code>failure</code></a>crate来简化定义错误类型的过程。虽然<code>failure</code>设计良好，但使用它可能<a target="_blank" rel="noopener" href="https://github.com/rust-lang-nursery/rust-cookbook/issues/502#issue-387418261">并不是最佳实践</a>。 Rust专家可能不会继续看好这一实践。本课程也在迭代更新，未来可能不会使用<code>failure</code>。不过起码目前这一实践还不错，也提供了一个了解更多Rust错误处理发展细节的机会。</p>
<hr>
<p>我的作业：</p>
<figure class="highlight rust"><figcaption><span>lib.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">mod</span> error;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> error::&#123;<span class="built_in">Result</span>, KvsError&#125;;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">impl</span> KvStore &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">get</span></span>(&amp;<span class="keyword">self</span>, key: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">Option</span>&lt;<span class="built_in">String</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.db.get(&amp;key) &#123;</span><br><span class="line">            <span class="literal">Some</span>(value) =&gt; <span class="literal">Ok</span>(<span class="literal">Some</span>(value.to_string())),</span><br><span class="line">            <span class="literal">None</span> =&gt; <span class="literal">Err</span>(KvsError::KeyNotFound(key))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新增的自定义错误<code>error</code>模块（其实只定义一个错误就能通过编译）：</p>
<figure class="highlight rust"><figcaption><span>error.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> failure::Fail;</span><br><span class="line"><span class="keyword">use</span> std::io;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// custom error type of kvs</span></span><br><span class="line"><span class="meta">#[derive(Fail, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">KvsError</span></span> &#123;</span><br><span class="line">    <span class="comment">/// Key not found in kvs index</span></span><br><span class="line">    <span class="meta">#[fail(display=<span class="meta-string">&quot;Key `&#123;&#125;` not found&quot;</span>, _0)]</span></span><br><span class="line">    KeyNotFound(<span class="built_in">String</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// simplify `Result&lt;T, KvsError&gt;` to `Result&lt;T&gt;`</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">Result</span></span>&lt;T&gt; = std::result::<span class="built_in">Result</span>&lt;T, KvsError&gt;;</span><br></pre></td></tr></table></figure>

<h2 id="第2部分-日志行为"><a href="#第2部分-日志行为" class="headerlink" title="第2部分 日志行为"></a>第2部分 日志行为</h2><p>现在我们终于要开始实现一个数据库的基础功能并读写磁盘了。您将使用<a target="_blank" rel="noopener" href="https://serde.rs/"><code>serde</code></a>将”set”和”rm”命令序列化为字符串，再使用标准文件I/O API将其写入磁盘。</p>
<p>这是带日志<code>kvs</code>的基本行为：</p>
<ul>
<li>“set”：<ul>
<li>用户调用<code>kvs set mykey myvalue</code></li>
<li><code>kvs</code>创建一个值来表示”set”命令，包含命令的键和值</li>
<li>将该命令序列化为<code>String</code></li>
<li>将序列化后的命令追加到日志文件中</li>
<li>若执行成功，则返回错误码<code>0</code>，静默退出</li>
<li>若执行失败，则打印错误，返回非零错误码并退出</li>
</ul>
</li>
<li>“get”<ul>
<li>用户调用<code>kvs get mykey</code></li>
<li><code>kvs</code>读取整个日志，一次一条命令，将被命令影响的键及文件偏移量录入到内存中的“键-&gt;日志指针”映射中</li>
<li>查找日志指针映射</li>
<li>若查找失败，则打印”Key not found”，并以退出码<code>0</code>退出</li>
<li>若查找成功：<ul>
<li>反序列化命令以获取该键的最新记录值</li>
<li>将值打印到标准输出，并以退出码<code>0</code>退出</li>
</ul>
</li>
</ul>
</li>
<li>“rm”<ul>
<li>用户调用<code>kvs rm mykey</code></li>
<li>与”get”命令相同，<code>kvs</code>读取整个日志以重建内存索引</li>
<li>在映射中查找给定的键</li>
<li>若键不存在，则打印”Key not found”，并以非零错误码退出</li>
<li>若找到该键：<ul>
<li>创建一个值来表示”rm”命令，包含命令的键</li>
<li>将序列化的命令追加到日志中</li>
<li>若成功完成，则以错误码<code>0</code>静默退出</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>日志是一份提交到数据库的事务的记录。通过在启动时“重放”日志中的记录，即可重建数据库先前的状态。</p>
<p>在本次迭代中，您可以将键的值直接存储在内存中（因此在程序初始化和日志重放后就不再需要从读取日志了）。在后面的迭代中，您只需将“日志指针”（文件偏移量）存储在内存中。</p>
<h2 id="第3部分：写日志"><a href="#第3部分：写日志" class="headerlink" title="第3部分：写日志"></a>第3部分：写日志</h2><p>您将从实现”set”命令开始，有很多步骤，大多数步骤都很容易实现。您可以通过运行相应的的<code>cli_*</code>测试用例来验证。</p>
<p><code>serde</code>是一个有有很多选项的大型库，支持多种序列化格式。只需要正确注释您的数据结构即可使用基础的序列化/反序列化功能，然后再调用函数将其写入<code>String</code>或任何实现了<code>Write</code>trait的流。</p>
<p>您需要选择一种序列化格式。考虑您想要的序列化属性 &mdash; 需要优先考虑性能吗？需要以纯文本形式查看日志内容吗？这都是您选择时需要考虑的属性，您应该在代码注释中解释您的选择。</p>
<p>其他需要考虑的因素包括：系统的哪些部分需要使用缓冲、您需要在哪里设置缓冲？缓冲对后续的读操作有什么影响？什么时候打开/关闭文件句柄？每个命令都需要操作句柄吗？还是在<code>KvStore</code>的整个生命周期内都不释放句柄？（译注，可以使用<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/io/struct.BufWriter.html"><code>BufWriter</code></a>提高写效率）</p>
<p>您会用到的部分API可能会调用失败，并返回包含某种错误类型的<code>Result</code>。确保函数返回包含您自定义错误类型的<code>Result</code>，以决定是否使用<code>?</code>传播异常。</p>
<p>实现”rm”命令也类似，但您应该在将命令写入日志前，检查该键是否已经存在。由于我们必须区分两个不同的命令，因此您可以使用枚举类型变量来表示每个命令。而<code>serde</code>可以完美应用在枚举类型上。</p>
<p>您现在可以实现”set”和”rm”命令了，专注于通过<code>set</code>/<code>rm</code>的相关测试用例。此外您也可以继续阅读下一节的”get”命令相关内容。在实现过程中，同时考虑读、写两种操作可能使代码更容易编写。逐项实现或同时实现均可。</p>
<h2 id="第4部分：读日志"><a href="#第4部分：读日志" class="headerlink" title="第4部分：读日志"></a>第4部分：读日志</h2><p>现在该实现”get”命令了。您暂时还不用考虑在索引中存储日志指针的特性，我们将该特性的实现留到下一部分。目前，您只需在启动时读取日志中的每个命令，执行这些指令，以将所有键/值保存在内存中，再从内存中读取这些键值。</p>
<p>此时您需要考虑：应该把日志中的所有记录一次读入内存，再将一次性重放以初始化你的映射类型；还是应该一次读取一条的重放命令并初始化您的映射？应该在反序列化前先将日志读取到缓冲区；还是应该直接反序列化一个文件流？思考您的实现对应的内存使用情况，也要考虑从I/O流中读取数据时与内核交互的情况。（译注，可以使用<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/io/struct.BufReader.html"><code>BufReader</code></a>提高读效率）</p>
<p>请记住，”get”也可能找不到指定键，这种情况需要特别处理。本项目的设定为，API返回<code>None</code>，且命令行客户端打印一条特定的消息并以零退出码退出。</p>
<p>读取日志有一个复杂之处，您可能在编写”set”代码时已经考虑过：如何区分日志文件中的每条记录？也就是说，程序怎么知道一条记录在哪里结束，而下一题记录从哪里开始？这会是一个问题吗？也许<code>serde</code>会直接从I/O流中反序列化一条记录，并在完成后停止读取，将文件光标留在正确的位置以便继续读取后面的记录？也许<code>serde</code>在看到两条记录粘在一起时会报错？也许你需要插入额外的信息来区分每条记录的长度？也许不用？</p>
<p><em>现在实现”get”命令。</em></p>
<p>(译注：此时使用<code>BufReader</code>和<code>BufWriter</code>实现即可，暂不需要记录命令在日志中的位置。虽然此时应新建<code>Command</code>枚举类型，并使用<code>serde_json</code>从日志文件中读取整条命令，但内存中的存储索引的形式暂时仍为<code>BTreeMap&lt;String, String&gt;</code>。同样，写操作也使用<code>serde_json</code>直接写入<code>Command</code>枚举类型。)</p>
<h2 id="第5部分：在索引中存储日志指针"><a href="#第5部分：在索引中存储日志指针" class="headerlink" title="第5部分：在索引中存储日志指针"></a>第5部分：在索引中存储日志指针</h2><p>此时，测试条件中，除了压缩测试外的其他测试都应该能够通过。后续步骤中引入的是一些优化特性，这对于提高性能和减少存储空间是十分必要的。在实现这些特性时，请注意我们在优化什么。</p>
<p>正如我们所描述的，您正在构建的数据库将在内存中维护所有键的索引。该索引从键的字符串映射到日志的指针，而不是映射值本身。</p>
<p>此更改需要我们能够从日志的任意偏移量处读取数据，考虑如何按照此更改修改您的文件句柄管理方式。</p>
<p><em>如果在前面的步骤中，您选择将值的字符串直接存储在内存中，那么现在是时候更新代码，以存放日志指针了，然后实现按需从磁盘加载。</em></p>
<p>（译注：此时需要引入变量记录读写日志文件的位置，并将内存中的存储索引形式修改为<code>BTreeMap&lt;String, CommandPos&#123; pos: u64, len: u64 &#125;&gt;</code>）</p>
<h2 id="第6部分：无状态KvStore-与-有状态KvStore"><a href="#第6部分：无状态KvStore-与-有状态KvStore" class="headerlink" title="第6部分：无状态KvStore 与 有状态KvStore"></a>第6部分：无状态<code>KvStore</code> 与 有状态<code>KvStore</code></h2><p>请记住，我们的项目既是库又是命令行程序。它们的要求略有不同：<code>kvs</code>命令行程序将单个更改提交到磁盘，然后退出（它是无状态的）；<code>KvStore</code>类将更改提交到磁盘，然后驻留在内存中以提供的查询服务（它是有状态的）。</p>
<p>您的<code>KvStore</code>是有状态的还是无状态的？</p>
<p><em>让您的<code>KvStore</code>将索引保留在内存中，这样它就不需要为每次接受<code>get</code>命令时都对日志求值。</em></p>
<h2 id="第7部分：压缩日志"><a href="#第7部分：压缩日志" class="headerlink" title="第7部分：压缩日志"></a>第7部分：压缩日志</h2><p>此时数据库工作正常，但日志无限增长。这适用于某些数据库，但不适用于我们正在构建的数据库 &mdash; 希望尽可能减少磁盘用量。</p>
<p>因此，创建数据库的最后一步是压缩日志。在使用中，随着日志的增长，对于某个键，可能会有多条命令进行设置值或删除键。不过对于该键，只有最新的修改命令才会修改它的值：</p>
<table>
<thead>
<tr>
<th align="center">idx</th>
<th align="left">command</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="left"><del>Command::Set(“key-1”, “value-1a”)</del></td>
</tr>
<tr>
<td align="center">20</td>
<td align="left">Command::Set(“key-2”, “value-2”)</td>
</tr>
<tr>
<td align="center"></td>
<td align="left">…</td>
</tr>
<tr>
<td align="center">100</td>
<td align="left">Command::Set(“key-1”, “value-1b”)</td>
</tr>
</tbody></table>
<p>在上面的例子中，索引<code>0</code>的命令显然是多余的，因此不需要存储它。日志压缩就是重建日志，以删除冗余命令：</p>
<table>
<thead>
<tr>
<th align="center">idx</th>
<th align="left">command</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="left">Command::Set(“key-2”, “value-2”)</td>
</tr>
<tr>
<td align="center"></td>
<td align="left">…</td>
</tr>
<tr>
<td align="center">99</td>
<td align="left">Command::Set(“key-1”, “value-1b”)</td>
</tr>
</tbody></table>
<p>基本算法如下：</p>
<p>您应当自行考虑<em>如何</em>重建日志。同时思考以下问题：朴素的解决方案是什么？需要多少内存？压缩日志所需的最小复制量是多少？压缩可以就地完成吗？如果压缩失败，您如何保持数据完整性？</p>
<p>到目前为止，我们一直再说“日志文件”，但实际上数据库通常会将大量日志存储在不同的文件中。在实现过程中您可能会发现，如果跨文件拆分日志将会更容易的压缩日志。</p>
<p><em>为您的数据库实现日志压缩功能。</em></p>
<p>恭喜！您已经成功实现了一个功能齐全的数据库。</p>
<p>如果您仍然好奇，那么现在可以对比您的键/值数据库与其他同类数据库（如<a target="_blank" rel="noopener" href="https://github.com/spacejam/sled">sled</a>、<a target="_blank" rel="noopener" href="https://github.com/basho/bitcask">bitcask</a>、<a target="_blank" rel="noopener" href="https://github.com/dgraph-io/badger">badger</a>或<a target="_blank" rel="noopener" href="https://rocksdb.org/">RocksDB</a>）的性能。您可以继续研究他们的架构，思考他们的架构与您的架构的异同，以及架构如何影响性能。接下来的几个项目将为您提供优化的机会。</p>
<hr>
<p>目录结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── Cargo.lock</span><br><span class="line">├── Cargo.toml</span><br><span class="line">├── README.md</span><br><span class="line">├── src</span><br><span class="line">│  ├── bin</span><br><span class="line">│  │  └── kvs.rs</span><br><span class="line">│  ├── error.rs</span><br><span class="line">│  ├── kv.rs</span><br><span class="line">│  └── lib.rs</span><br><span class="line">└── tests</span><br><span class="line">   └── tests.rs</span><br></pre></td></tr></table></figure>

<p>主要改动了<code>lib.rs</code>，将功能实现迁移至<code>kv.rs</code>，将错误处理迁移至<code>error.rs</code>。</p>
<figure class="highlight rust"><figcaption><span>lib.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![deny(missing_docs)]</span></span><br><span class="line"><span class="comment">//! A simple key/value store.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> error::&#123;KvsError, <span class="built_in">Result</span>&#125;;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> kv::KvStore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> error;</span><br><span class="line"><span class="keyword">mod</span> kv;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><figcaption><span>kv.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::&#123;BTreeMap, HashMap&#125;;</span><br><span class="line"><span class="keyword">use</span> std::fs::&#123;<span class="keyword">self</span>, File, OpenOptions&#125;;</span><br><span class="line"><span class="keyword">use</span> std::io::&#123;<span class="keyword">self</span>, BufReader, BufWriter, Read, Seek, SeekFrom, Write&#125;;</span><br><span class="line"><span class="keyword">use</span> std::ops::Range;</span><br><span class="line"><span class="keyword">use</span> std::path::&#123;Path, PathBuf&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> serde::&#123;Deserialize, Serialize&#125;;</span><br><span class="line"><span class="keyword">use</span> serde_json::Deserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::&#123;KvsError, <span class="built_in">Result</span>&#125;;</span><br><span class="line"><span class="keyword">use</span> std::ffi::OsStr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> COMPACTION_THRESHOLD: <span class="built_in">u64</span> = <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// The `KvStore` stores string key/value pairs.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Key/value pairs are persisted to disk in log files. Log files are named after</span></span><br><span class="line"><span class="comment">/// monotonically increasing generation numbers with a `log` extension name.</span></span><br><span class="line"><span class="comment">/// A `BTreeMap` in memory stores the keys and the value locations for fast query.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ```rust</span></span><br><span class="line"><span class="comment">/// # use kvs::&#123;KvStore, Result&#125;;</span></span><br><span class="line"><span class="comment">/// # fn try_main() -&gt; Result&lt;()&gt; &#123;</span></span><br><span class="line"><span class="comment">/// use std::env::current_dir;</span></span><br><span class="line"><span class="comment">/// let mut store = KvStore::open(current_dir()?)?;</span></span><br><span class="line"><span class="comment">/// store.set(&quot;key&quot;.to_owned(), &quot;value&quot;.to_owned())?;</span></span><br><span class="line"><span class="comment">/// let val = store.get(&quot;key&quot;.to_owned())?;</span></span><br><span class="line"><span class="comment">/// assert_eq!(val, Some(&quot;value&quot;.to_owned()));</span></span><br><span class="line"><span class="comment">/// # Ok(())</span></span><br><span class="line"><span class="comment">/// # &#125;</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">KvStore</span></span> &#123;</span><br><span class="line">    <span class="comment">// directory for the log and other data.</span></span><br><span class="line">    path: PathBuf,</span><br><span class="line">    <span class="comment">// map generation number to the file reader.</span></span><br><span class="line">    readers: HashMap&lt;<span class="built_in">u64</span>, BufReaderWithPos&lt;File&gt;&gt;,</span><br><span class="line">    <span class="comment">// writer of the current log.</span></span><br><span class="line">    writer: BufWriterWithPos&lt;File&gt;,</span><br><span class="line">    current_gen: <span class="built_in">u64</span>,</span><br><span class="line">    index: BTreeMap&lt;<span class="built_in">String</span>, CommandPos&gt;,</span><br><span class="line">    <span class="comment">// the number of bytes representing &quot;stale&quot; commands that could be</span></span><br><span class="line">    <span class="comment">// deleted during a compaction.</span></span><br><span class="line">    uncompacted: <span class="built_in">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> KvStore &#123;</span><br><span class="line">    <span class="comment">/// Opens a `KvStore` with the given path.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// This will create a new directory if the given one does not exist.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// # Errors</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// It propagates I/O or deserialization errors during the log replay.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">open</span></span>(path: <span class="keyword">impl</span> <span class="built_in">Into</span>&lt;PathBuf&gt;) -&gt; <span class="built_in">Result</span>&lt;KvStore&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> path = path.into();</span><br><span class="line">        fs::create_dir_all(&amp;path)?;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> readers = HashMap::new();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> index = BTreeMap::new();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> gen_list = sorted_gen_list(&amp;path)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> uncompacted = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> &amp;gen <span class="keyword">in</span> &amp;gen_list &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> reader = BufReaderWithPos::new(File::open(log_path(&amp;path, gen))?)?;</span><br><span class="line">            uncompacted += load(gen, &amp;<span class="keyword">mut</span> reader, &amp;<span class="keyword">mut</span> index)?;</span><br><span class="line">            readers.insert(gen, reader);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> current_gen = gen_list.last().unwrap_or(&amp;<span class="number">0</span>) + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">let</span> writer = new_log_file(&amp;path, current_gen, &amp;<span class="keyword">mut</span> readers)?;</span><br><span class="line"></span><br><span class="line">        <span class="literal">Ok</span>(KvStore &#123;</span><br><span class="line">            path,</span><br><span class="line">            readers,</span><br><span class="line">            writer,</span><br><span class="line">            current_gen,</span><br><span class="line">            index,</span><br><span class="line">            uncompacted,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Sets the value of a string key to a string.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// If the key already exists, the previous value will be overwritten.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// # Errors</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// It propagates I/O or serialization errors during writing the log.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>, value: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> cmd = Command::set(key, value);</span><br><span class="line">        <span class="keyword">let</span> pos = <span class="keyword">self</span>.writer.pos;</span><br><span class="line">        serde_json::to_writer(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.writer, &amp;cmd)?;</span><br><span class="line">        <span class="keyword">self</span>.writer.flush()?;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> Command::Set &#123; key, .. &#125; = cmd &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(old_cmd) = <span class="keyword">self</span></span><br><span class="line">                .index</span><br><span class="line">                .insert(key, (<span class="keyword">self</span>.current_gen, pos..<span class="keyword">self</span>.writer.pos).into())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">self</span>.uncompacted += old_cmd.len;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.uncompacted &gt; COMPACTION_THRESHOLD &#123;</span><br><span class="line">            <span class="keyword">self</span>.compact()?;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Gets the string value of a given string key.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Returns `None` if the given key does not exist.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// # Errors</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// It returns `KvsError::UnexpectedCommandType` if the given command type unexpected.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">get</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">Option</span>&lt;<span class="built_in">String</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(cmd_pos) = <span class="keyword">self</span>.index.get(&amp;key) &#123;</span><br><span class="line">            <span class="keyword">let</span> reader = <span class="keyword">self</span></span><br><span class="line">                .readers</span><br><span class="line">                .get_mut(&amp;cmd_pos.gen)</span><br><span class="line">                .expect(<span class="string">&quot;Cannot find log reader&quot;</span>);</span><br><span class="line">            reader.seek(SeekFrom::Start(cmd_pos.pos))?;</span><br><span class="line">            <span class="keyword">let</span> cmd_reader = reader.take(cmd_pos.len);</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> Command::Set &#123; value, .. &#125; = serde_json::from_reader(cmd_reader)? &#123;</span><br><span class="line">                <span class="literal">Ok</span>(<span class="literal">Some</span>(value))</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="literal">Err</span>(KvsError::UnexpectedCommandType)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="literal">Ok</span>(<span class="literal">None</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Removes a given key.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// # Errors</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// It returns `KvsError::KeyNotFound` if the given key is not found.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// It propagates I/O or serialization errors during writing the log.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">remove</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.index.contains_key(&amp;key) &#123;</span><br><span class="line">            <span class="keyword">let</span> cmd = Command::remove(key);</span><br><span class="line">            serde_json::to_writer(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.writer, &amp;cmd)?;</span><br><span class="line">            <span class="keyword">self</span>.writer.flush()?;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> Command::Remove &#123; key &#125; = cmd &#123;</span><br><span class="line">                <span class="keyword">let</span> old_cmd = <span class="keyword">self</span>.index.remove(&amp;key).expect(<span class="string">&quot;key not found&quot;</span>);</span><br><span class="line">                <span class="keyword">self</span>.uncompacted += old_cmd.len;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="literal">Ok</span>(())</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="literal">Err</span>(KvsError::KeyNotFound)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Clears stale entries in the log.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">compact</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="comment">// increase current gen by 2. current_gen + 1 is for the compaction file.</span></span><br><span class="line">        <span class="keyword">let</span> compaction_gen = <span class="keyword">self</span>.current_gen + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">self</span>.current_gen += <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">self</span>.writer = <span class="keyword">self</span>.new_log_file(<span class="keyword">self</span>.current_gen)?;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> compaction_writer = <span class="keyword">self</span>.new_log_file(compaction_gen)?;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> new_pos = <span class="number">0</span>; <span class="comment">// pos in the new log file.</span></span><br><span class="line">        <span class="keyword">for</span> cmd_pos <span class="keyword">in</span> &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.index.values_mut() &#123;</span><br><span class="line">            <span class="keyword">let</span> reader = <span class="keyword">self</span></span><br><span class="line">                .readers</span><br><span class="line">                .get_mut(&amp;cmd_pos.gen)</span><br><span class="line">                .expect(<span class="string">&quot;Cannot find log reader&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> reader.pos != cmd_pos.pos &#123;</span><br><span class="line">                reader.seek(SeekFrom::Start(cmd_pos.pos))?;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> entry_reader = reader.take(cmd_pos.len);</span><br><span class="line">            <span class="keyword">let</span> len = io::copy(&amp;<span class="keyword">mut</span> entry_reader, &amp;<span class="keyword">mut</span> compaction_writer)?;</span><br><span class="line">            *cmd_pos = (compaction_gen, new_pos..new_pos + len).into();</span><br><span class="line">            new_pos += len;</span><br><span class="line">        &#125;</span><br><span class="line">        compaction_writer.flush()?;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// remove stale log files.</span></span><br><span class="line">        <span class="keyword">let</span> stale_gens: <span class="built_in">Vec</span>&lt;_&gt; = <span class="keyword">self</span></span><br><span class="line">            .readers</span><br><span class="line">            .keys()</span><br><span class="line">            .filter(|&amp;&amp;gen| gen &lt; compaction_gen)</span><br><span class="line">            .cloned()</span><br><span class="line">            .collect();</span><br><span class="line">        <span class="keyword">for</span> stale_gen <span class="keyword">in</span> stale_gens &#123;</span><br><span class="line">            <span class="keyword">self</span>.readers.remove(&amp;stale_gen);</span><br><span class="line">            fs::remove_file(log_path(&amp;<span class="keyword">self</span>.path, stale_gen))?;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.uncompacted = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Create a new log file with given generation number and add the reader to the readers map.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Returns the writer to the log.</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new_log_file</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, gen: <span class="built_in">u64</span>) -&gt; <span class="built_in">Result</span>&lt;BufWriterWithPos&lt;File&gt;&gt; &#123;</span><br><span class="line">        new_log_file(&amp;<span class="keyword">self</span>.path, gen, &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.readers)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Create a new log file with given generation number and add the reader to the readers map.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Returns the writer to the log.</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">new_log_file</span></span>(</span><br><span class="line">    path: &amp;Path,</span><br><span class="line">    gen: <span class="built_in">u64</span>,</span><br><span class="line">    readers: &amp;<span class="keyword">mut</span> HashMap&lt;<span class="built_in">u64</span>, BufReaderWithPos&lt;File&gt;&gt;,</span><br><span class="line">) -&gt; <span class="built_in">Result</span>&lt;BufWriterWithPos&lt;File&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> path = log_path(&amp;path, gen);</span><br><span class="line">    <span class="keyword">let</span> writer = BufWriterWithPos::new(</span><br><span class="line">        OpenOptions::new()</span><br><span class="line">            .create(<span class="literal">true</span>)</span><br><span class="line">            .write(<span class="literal">true</span>)</span><br><span class="line">            .append(<span class="literal">true</span>)</span><br><span class="line">            .open(&amp;path)?,</span><br><span class="line">    )?;</span><br><span class="line">    readers.insert(gen, BufReaderWithPos::new(File::open(&amp;path)?)?);</span><br><span class="line">    <span class="literal">Ok</span>(writer)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Returns sorted generation numbers in the given directory.</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">sorted_gen_list</span></span>(path: &amp;Path) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">Vec</span>&lt;<span class="built_in">u64</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> gen_list: <span class="built_in">Vec</span>&lt;<span class="built_in">u64</span>&gt; = fs::read_dir(&amp;path)?</span><br><span class="line">        .flat_map(|res| -&gt; <span class="built_in">Result</span>&lt;_&gt; &#123; <span class="literal">Ok</span>(res?.path()) &#125;)</span><br><span class="line">        .filter(|path| path.is_file() &amp;&amp; path.extension() == <span class="literal">Some</span>(<span class="string">&quot;log&quot;</span>.as_ref()))</span><br><span class="line">        .flat_map(|path| &#123;</span><br><span class="line">            path.file_name()</span><br><span class="line">                .and_then(OsStr::to_str)</span><br><span class="line">                .map(|s| s.trim_end_matches(<span class="string">&quot;.log&quot;</span>))</span><br><span class="line">                .map(<span class="built_in">str</span>::parse::&lt;<span class="built_in">u64</span>&gt;)</span><br><span class="line">        &#125;)</span><br><span class="line">        .flatten()</span><br><span class="line">        .collect();</span><br><span class="line">    gen_list.sort_unstable();</span><br><span class="line">    <span class="literal">Ok</span>(gen_list)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Load the whole log file and store value locations in the index map.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Returns how many bytes can be saved after a compaction.</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">load</span></span>(</span><br><span class="line">    gen: <span class="built_in">u64</span>,</span><br><span class="line">    reader: &amp;<span class="keyword">mut</span> BufReaderWithPos&lt;File&gt;,</span><br><span class="line">    index: &amp;<span class="keyword">mut</span> BTreeMap&lt;<span class="built_in">String</span>, CommandPos&gt;,</span><br><span class="line">) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">u64</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// To make sure we read from the beginning of the file.</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> pos = reader.seek(SeekFrom::Start(<span class="number">0</span>))?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> stream = Deserializer::from_reader(reader).into_iter::&lt;Command&gt;();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> uncompacted = <span class="number">0</span>; <span class="comment">// number of bytes that can be saved after a compaction.</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="literal">Some</span>(cmd) = stream.next() &#123;</span><br><span class="line">        <span class="keyword">let</span> new_pos = stream.byte_offset() <span class="keyword">as</span> <span class="built_in">u64</span>;</span><br><span class="line">        <span class="keyword">match</span> cmd? &#123;</span><br><span class="line">            Command::Set &#123; key, .. &#125; =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(old_cmd) = index.insert(key, (gen, pos..new_pos).into()) &#123;</span><br><span class="line">                    uncompacted += old_cmd.len;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Command::Remove &#123; key &#125; =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(old_cmd) = index.remove(&amp;key) &#123;</span><br><span class="line">                    uncompacted += old_cmd.len;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// the &quot;remove&quot; command itself can be deleted in the next compaction.</span></span><br><span class="line">                <span class="comment">// so we add its length to `uncompacted`.</span></span><br><span class="line">                uncompacted += new_pos - pos;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        pos = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="literal">Ok</span>(uncompacted)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">log_path</span></span>(dir: &amp;Path, gen: <span class="built_in">u64</span>) -&gt; PathBuf &#123;</span><br><span class="line">    dir.join(<span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;.log&quot;</span>, gen))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Struct representing a command.</span></span><br><span class="line"><span class="meta">#[derive(Serialize, Deserialize, Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Command</span></span> &#123;</span><br><span class="line">    Set &#123; key: <span class="built_in">String</span>, value: <span class="built_in">String</span> &#125;,</span><br><span class="line">    Remove &#123; key: <span class="built_in">String</span> &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Command &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">set</span></span>(key: <span class="built_in">String</span>, value: <span class="built_in">String</span>) -&gt; Command &#123;</span><br><span class="line">        Command::Set &#123; key, value &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">remove</span></span>(key: <span class="built_in">String</span>) -&gt; Command &#123;</span><br><span class="line">        Command::Remove &#123; key &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Represents the position and length of a json-serialized command in the log.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CommandPos</span></span> &#123;</span><br><span class="line">    gen: <span class="built_in">u64</span>,</span><br><span class="line">    pos: <span class="built_in">u64</span>,</span><br><span class="line">    len: <span class="built_in">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;(<span class="built_in">u64</span>, Range&lt;<span class="built_in">u64</span>&gt;)&gt; <span class="keyword">for</span> CommandPos &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>((gen, range): (<span class="built_in">u64</span>, Range&lt;<span class="built_in">u64</span>&gt;)) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        CommandPos &#123;</span><br><span class="line">            gen,</span><br><span class="line">            pos: range.start,</span><br><span class="line">            len: range.end - range.start,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BufReaderWithPos</span></span>&lt;R: Read + Seek&gt; &#123;</span><br><span class="line">    reader: BufReader&lt;R&gt;,</span><br><span class="line">    pos: <span class="built_in">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;R: Read + Seek&gt; BufReaderWithPos&lt;R&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(<span class="keyword">mut</span> inner: R) -&gt; <span class="built_in">Result</span>&lt;<span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> pos = inner.seek(SeekFrom::Current(<span class="number">0</span>))?;</span><br><span class="line">        <span class="literal">Ok</span>(BufReaderWithPos &#123;</span><br><span class="line">            reader: BufReader::new(inner),</span><br><span class="line">            pos,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;R: Read + Seek&gt; Read <span class="keyword">for</span> BufReaderWithPos&lt;R&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, buf: &amp;<span class="keyword">mut</span> [<span class="built_in">u8</span>]) -&gt; io::<span class="built_in">Result</span>&lt;<span class="built_in">usize</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> len = <span class="keyword">self</span>.reader.read(buf)?;</span><br><span class="line">        <span class="keyword">self</span>.pos += len <span class="keyword">as</span> <span class="built_in">u64</span>;</span><br><span class="line">        <span class="literal">Ok</span>(len)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;R: Read + Seek&gt; Seek <span class="keyword">for</span> BufReaderWithPos&lt;R&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">seek</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, pos: SeekFrom) -&gt; io::<span class="built_in">Result</span>&lt;<span class="built_in">u64</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.pos = <span class="keyword">self</span>.reader.seek(pos)?;</span><br><span class="line">        <span class="literal">Ok</span>(<span class="keyword">self</span>.pos)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BufWriterWithPos</span></span>&lt;W: Write + Seek&gt; &#123;</span><br><span class="line">    writer: BufWriter&lt;W&gt;,</span><br><span class="line">    pos: <span class="built_in">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;W: Write + Seek&gt; BufWriterWithPos&lt;W&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(<span class="keyword">mut</span> inner: W) -&gt; <span class="built_in">Result</span>&lt;<span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> pos = inner.seek(SeekFrom::Current(<span class="number">0</span>))?;</span><br><span class="line">        <span class="literal">Ok</span>(BufWriterWithPos &#123;</span><br><span class="line">            writer: BufWriter::new(inner),</span><br><span class="line">            pos,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;W: Write + Seek&gt; Write <span class="keyword">for</span> BufWriterWithPos&lt;W&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">write</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, buf: &amp;[<span class="built_in">u8</span>]) -&gt; io::<span class="built_in">Result</span>&lt;<span class="built_in">usize</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> len = <span class="keyword">self</span>.writer.write(buf)?;</span><br><span class="line">        <span class="keyword">self</span>.pos += len <span class="keyword">as</span> <span class="built_in">u64</span>;</span><br><span class="line">        <span class="literal">Ok</span>(len)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">flush</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; io::<span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.writer.flush()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;W: Write + Seek&gt; Seek <span class="keyword">for</span> BufWriterWithPos&lt;W&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">seek</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, pos: SeekFrom) -&gt; io::<span class="built_in">Result</span>&lt;<span class="built_in">u64</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.pos = <span class="keyword">self</span>.writer.seek(pos)?;</span><br><span class="line">        <span class="literal">Ok</span>(<span class="keyword">self</span>.pos)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><figcaption><span>error.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> failure::Fail;</span><br><span class="line"><span class="keyword">use</span> std::io;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Error type for kvs.</span></span><br><span class="line"><span class="meta">#[derive(Fail, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">KvsError</span></span> &#123;</span><br><span class="line">    <span class="comment">/// IO error.</span></span><br><span class="line">    <span class="meta">#[fail(display = <span class="meta-string">&quot;&#123;&#125;&quot;</span>, _0)]</span></span><br><span class="line">    Io(<span class="meta">#[cause]</span> io::Error),</span><br><span class="line">    <span class="comment">/// Serialization or deserialization error.</span></span><br><span class="line">    <span class="meta">#[fail(display = <span class="meta-string">&quot;&#123;&#125;&quot;</span>, _0)]</span></span><br><span class="line">    Serde(<span class="meta">#[cause]</span> serde_json::Error),</span><br><span class="line">    <span class="comment">/// Removing non-existent key error.</span></span><br><span class="line">    <span class="meta">#[fail(display = <span class="meta-string">&quot;Key not found&quot;</span>)]</span></span><br><span class="line">    KeyNotFound,</span><br><span class="line">    <span class="comment">/// Unexpected command type error.</span></span><br><span class="line">    <span class="comment">/// It indicated a corrupted log or a program bug.</span></span><br><span class="line">    <span class="meta">#[fail(display = <span class="meta-string">&quot;Unexpected command type&quot;</span>)]</span></span><br><span class="line">    UnexpectedCommandType,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;io::Error&gt; <span class="keyword">for</span> KvsError &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(err: io::Error) -&gt; KvsError &#123;</span><br><span class="line">        KvsError::Io(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;serde_json::Error&gt; <span class="keyword">for</span> KvsError &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(err: serde_json::Error) -&gt; KvsError &#123;</span><br><span class="line">        KvsError::Serde(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Result type for kvs.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">Result</span></span>&lt;T&gt; = std::result::<span class="built_in">Result</span>&lt;T, KvsError&gt;;</span><br></pre></td></tr></table></figure>

<p>干得漂亮，朋友，休息一下吧。</p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Rust/">Rust</a></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><div class="social-share"></div><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechatpay.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/05/10/pna-rust-project-3/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">PingCap的Rust训练课程3：同步的“客户端-服务端”网络模块</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/02/22/pna-rust-project-1/"><span class="level-item">PingCap的Rust训练课程1：熟悉Rust工具链</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><script src="https://utteranc.es/client.js" repo="zlotus/comment" issue-term="pathname" label="some-issue-label" theme="github-light" crossorigin="anonymous" async></script></div></div></div><div class="column column-left is-3-tablet is-3-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/opm_sq.png" alt="子实"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">子实</p><p class="is-size-6 is-block">程序员</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>陕西/西安</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">79</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">23</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/zlotus" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/zlotus"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com/qinzishi"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/Zealot_uS"><i class="fab fa-twitter"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.zhihu.com/people/zlotus" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">知乎</span></span><span class="level-right"><span class="level-item tag">www.zhihu.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Diary/"><span class="level-start"><span class="level-item">Diary</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/"><span class="level-start"><span class="level-item">Programming</span></span><span class="level-end"><span class="level-item tag">65</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Shell/"><span class="level-start"><span class="level-item">Shell</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Coroutines/"><span class="tag">Coroutines</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaScript/"><span class="tag">JavaScript</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Javascript/"><span class="tag">Javascript</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">31</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenCV/"><span class="tag">OpenCV</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Operating-System/"><span class="tag">Operating System</span><span class="tag">21</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Paper/"><span class="tag">Paper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">18</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Raspberry-Pi/"><span class="tag">Raspberry Pi</span><span class="tag">20</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Rust/"><span class="tag">Rust</span><span class="tag">29</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Shell/"><span class="tag">Shell</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TensorFlow/"><span class="tag">TensorFlow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Tokio/"><span class="tag">Tokio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ZMQ/"><span class="tag">ZMQ</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ctpn/"><span class="tag">ctpn</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/llama/"><span class="tag">llama</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macOS/"><span class="tag">macOS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/obsidion/"><span class="tag">obsidion</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%A5%E8%AE%B0/"><span class="tag">日记</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E8%B0%88/"><span class="tag">杂谈</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%AE%97%E6%B3%95/"><span class="tag">算法</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BC%96%E7%A8%8B/"><span class="tag">编程</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%84%9A%E6%9C%AC/"><span class="tag">脚本</span><span class="tag">4</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/opm_sq.png" alt="子实" height="28"></a><p class="is-size-7"><span>&copy; 2024 子实</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>