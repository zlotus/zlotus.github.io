<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>自然场景中的中文识别尝试 - 子实</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="子实"><meta name="msapplication-TileImage" content="/img/avatar-o.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="子实"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="在树莓派上做自然场景中的中文识别"><meta property="og:type" content="article"><meta property="og:title" content="自然场景中的中文识别尝试"><meta property="og:url" content="https://zlotus.github.io/2019/08/24/rbp3-chinese-text-dection/"><meta property="og:site_name" content="子实"><meta property="og:description" content="在树莓派上做自然场景中的中文识别"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://zlotus.github.io/img/og_image.png"><meta property="article:published_time" content="2019-08-24T13:09:11.000Z"><meta property="article:modified_time" content="2018-08-24T13:09:11.000Z"><meta property="article:author" content="子实"><meta property="article:tag" content="Python"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Raspberry Pi"><meta property="article:tag" content="TensorFlow"><meta property="article:tag" content="ctpn"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><meta property="twitter:creator" content="@Zealot_uS"><meta property="twitter:site" content="Zealot_uS"><link rel="publisher" href="+LotusQin"><meta property="fb:admins" content="qinzishi"><meta property="fb:app_id" content="qinzishi"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zlotus.github.io/2019/08/24/rbp3-chinese-text-dection/"},"headline":"自然场景中的中文识别尝试","image":["https://zlotus.github.io/img/og_image.png"],"datePublished":"2019-08-24T13:09:11.000Z","dateModified":"2018-08-24T13:09:11.000Z","author":{"@type":"Person","name":"子实"},"publisher":{"@type":"Organization","name":"子实","logo":{"@type":"ImageObject","url":"https://zlotus.github.io/img/opm_sq.png"}},"description":"在树莓派上做自然场景中的中文识别"}</script><link rel="icon" href="/img/avatar-o.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><!--!--><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/opm_sq.png" alt="子实" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/2014/07/09/about-me/">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zlotus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-9-tablet is-9-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-08-24T13:09:11.000Z" title="8/24/2019, 9:09:11 PM">2019-08-24</time>发表</span><span class="level-item"><time dateTime="2018-08-24T13:09:11.000Z" title="8/24/2018, 9:09:11 PM">2018-08-24</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a></span><span class="level-item">30 分钟读完 (大约4497个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">自然场景中的中文识别尝试</h1><div class="content"><p>想做个考试作弊系统[捂脸]……</p>
<span id="more"></span>

<h1 id="又想作弊了"><a href="#又想作弊了" class="headerlink" title="又想作弊了"></a>又想作弊了</h1><p>最近想整个通过图像识别自然场景中的中文“试卷” -&gt; 自然语言处理 -&gt; 查找题库 -&gt; 返回结果的小程序。目前考虑的是，图像通过树莓派的摄像头产生，将结果输出到柔性墨水屏上。</p>
<h2 id="1-Connectionist-Text-Proposal-Network"><a href="#1-Connectionist-Text-Proposal-Network" class="headerlink" title="1 Connectionist Text Proposal Network"></a>1 Connectionist Text Proposal Network</h2><p>据说ctpn算法在长文本上也能够保持一个不错的效果，先试试吧</p>
<h3 id="1-1-虚拟环境"><a href="#1-1-虚拟环境" class="headerlink" title="1.1 虚拟环境"></a>1.1 虚拟环境</h3><p>一开始想用<code>pipenv</code>，不过在安装<code>Cython</code>的<code>lock package</code>的时候就挂起不动了，搜了一下估计是跟跟网络和依赖有关系，因此就直接用Python自带的<code>venv</code>做虚拟环境管理了。</p>
<p>虚拟环境主要需要安装tensorflow，所以新建一个<code>tf</code>虚拟空间并激活：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3 -m venv tf</span><br><span class="line"><span class="built_in">cd</span> tf</span><br><span class="line"><span class="built_in">source</span> bin/activate</span><br></pre></td></tr></table></figure>

<p>包依赖有<code>Cython</code>、<code>numpy</code>、<code>opencv</code>。安装<code>numpy</code>之前记得安装<code>sudo apt -y install libatlas-base-dev</code>，不然会报<code>libf77blas.so.3</code>找不到的错误。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pip install numpy</span><br><span class="line"><span class="comment"># 直接pip（在2019-09-18）会安装到1.13.1版本的</span></span><br><span class="line">pip install tensorflow</span><br><span class="line"><span class="comment"># 搜了一个新的1.14.0版本的</span></span><br><span class="line"><span class="comment">#wget https://github.com/lhelontra/tensorflow-on-arm/releases/download/v1.14.0-buster/tensorflow-1.14.0-cp37-none-linux_armv7l.whl</span></span><br><span class="line"><span class="comment"># pip install tensorflow-1.14.0-cp37-none-linux_armv7l.whl</span></span><br><span class="line">proxychains4 git <span class="built_in">clone</span> https://github.com/eragonruan/text-detection-ctpn.git</span><br></pre></td></tr></table></figure>

<p>测试<code>import tensorflow</code>的时候会报一堆<code>Future Warning</code>。</p>
<h3 id="1-2-安装OpenCV"><a href="#1-2-安装OpenCV" class="headerlink" title="1.2 安装OpenCV"></a>1.2 安装OpenCV</h3><p>安装OpenCV很麻烦，单独拉出来写。</p>
<h4 id="1-2-1-准备工作"><a href="#1-2-1-准备工作" class="headerlink" title="1.2.1 准备工作"></a>1.2.1 准备工作</h4><ol>
<li>打开摄像头：<code>sudo raspi-config</code> -&gt; <strong>Enable camera</strong>。</li>
<li>扩展存储卡空间，以防不测：<code>sudo raspi-config</code> -&gt; <strong>Advanced Options</strong> -&gt; <strong>Expand filesystem</strong>。</li>
<li>重启：<code>sudo reboot -h now</code>，检查空间<code>df -h</code>。</li>
<li><em>可选</em>，清理不常用的程序： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get purge wolfram-engine</span><br><span class="line">sudo apt-get purge libreoffice*</span><br><span class="line">sudo apt-get clean</span><br><span class="line">sudo apt autoremove</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="1-2-2-安装OpenCV依赖"><a href="#1-2-2-安装OpenCV依赖" class="headerlink" title="1.2.2 安装OpenCV依赖"></a>1.2.2 安装OpenCV依赖</h4><p>注意，我在使用lite系统的时候，会遇到关于NEON的cmake错误，在桌面版下一切正常。</p>
<p>更新系统：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time sudo apt update &amp;&amp; time sudo apt upgrade &amp;&amp; time sudo apt dist-upgrade</span><br></pre></td></tr></table></figure>
<p>安装<code>cmake</code>等开发工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y build-essential cmake unzip pkg-config</span><br></pre></td></tr></table></figure>
<p>安装图片和视频相关库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y libjpeg-dev libpng-dev libtiff-dev</span><br><span class="line">sudo apt install -y libavcodec-dev libavformat-dev libswscale-dev libv4l-dev</span><br><span class="line">sudo apt install -y libxvidcore-dev libx264-dev</span><br></pre></td></tr></table></figure>
<p><em>可选</em>，安装GUI库GTK以及能减少GTK警告的库[捂脸]（名字中的<code>*</code>号可以匹配到ARM版的库）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y libgtk-3-dev</span><br><span class="line">sudo apt install -y libcanberra-gtk*</span><br></pre></td></tr></table></figure>
<p>为<code>OpenCV</code>安装数值优化库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y libatlas-base-dev gfortran</span><br></pre></td></tr></table></figure>
<p>最后安装Python的头文件库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python3-dev</span><br></pre></td></tr></table></figure>
<h4 id="1-2-3-下载OpenCV"><a href="#1-2-3-下载OpenCV" class="headerlink" title="1.2.3 下载OpenCV"></a>1.2.3 下载OpenCV</h4><p>下载<a target="_blank" rel="noopener" href="https://github.com/opencv/opencv">opencv</a>和附加的模块<a target="_blank" rel="noopener" href="https://github.com/opencv/opencv_contrib">opencv_contrib</a>，这些附加模块和函数可能会被经常用到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#proxychains4 wget -O opencv_4.1.1.zip https://github.com/opencv/opencv/archive/4.1.1.zip</span></span><br><span class="line"><span class="comment">#proxychains4 wget -O opencv_contrib_4.1.1.zip https://github.com/opencv/opencv_contrib/archive/4.1.1.zip</span></span><br><span class="line">proxychains4 wget -O opencv_4.1.0.zip https://github.com/opencv/opencv/archive/4.1.0.zip</span><br><span class="line">proxychains4 wget -O opencv_contrib_4.1.0.zip https://github.com/opencv/opencv_contrib/archive/4.1.0.zip</span><br><span class="line"><span class="comment">#proxychains4 wget -O opencv_4.0.1.zip https://github.com/opencv/opencv/archive/4.0.1.zip</span></span><br><span class="line"><span class="comment">#proxychains4 wget -O opencv_contrib_4.0.1.zip https://github.com/opencv/opencv_contrib/archive/4.0.1.zip</span></span><br><span class="line"><span class="comment">#proxychains4 wget -O opencv_4.0.0.zip https://github.com/opencv/opencv/archive/4.0.0.zip</span></span><br><span class="line"><span class="comment">#proxychains4 wget -O opencv_contrib_4.0.0.zip https://github.com/opencv/opencv_contrib/archive/4.0.0.zip</span></span><br></pre></td></tr></table></figure>
<p>解压：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unzip opencv_4.1.0.zip</span><br><span class="line">unzip opencv_contrib_4.1.0.zip</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：我尝试编译4.1.1版，在编译到49%的时候总会出现：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ 49%] Linking CXX shared library ../../lib/libopencv_imgproc.so</span><br><span class="line">[ 49%] Built target opencv_imgproc</span><br><span class="line">make: *** [Makefile:163: all] Error 2</span><br></pre></td></tr></table></figure>

<p>换4.1.0版就好了，耗时数小时。</p>
<h4 id="1-2-4-CMake及编译"><a href="#1-2-4-CMake及编译" class="headerlink" title="1.2.4 CMake及编译"></a>1.2.4 CMake及编译</h4><p>使用<code>cmake</code>构建编译，再用<code>make</code>进行编译，这一步非常耗时。先新建一个<code>build</code>文件夹：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> opencv-4.1.0</span><br><span class="line">mkdir build</span><br><span class="line"><span class="built_in">cd</span> build</span><br></pre></td></tr></table></figure>
<p>运行<code>cmake</code>，其中：</p>
<ul>
<li><code>OPENCV_ENABLE_NONFREE=ON</code>标识可以让我们在OpenCV 4中使用<strong>SIFT/SURF</strong>等专利算法。</li>
<li><code>OPENCV_GENERATE_PKGCONFIG=ON</code>生成<code>opencv4.pc</code>用于后面darknet的编译。</li>
<li><strong>注意</strong>：保证<code>OPENCV_EXTRA_MODULES_PATH</code>的路径正确，不然会出现类似 <em>sys/videoio.h: No such file or directory</em> 的错误。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cmake -D CMAKE_BUILD_TYPE=RELEASE \</span><br><span class="line">    -D CMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span> \</span><br><span class="line">    -D OPENCV_EXTRA_MODULES_PATH=~/ocr/opcv/opencv_contrib-4.1.0/modules \</span><br><span class="line">    -D ENABLE_NEON=ON \</span><br><span class="line">    -D ENABLE_VFPV3=ON \</span><br><span class="line">    -D BUILD_TESTS=OFF \</span><br><span class="line">    -D OPENCV_ENABLE_NONFREE=ON \</span><br><span class="line">    -D OPENCV_GENERATE_PKGCONFIG=ON \</span><br><span class="line">    -D INSTALL_PYTHON_EXAMPLES=OFF \</span><br><span class="line">    -D BUILD_EXAMPLES=OFF ..</span><br></pre></td></tr></table></figure></li>
</ul>
<p>接下来要为树莓派<strong>增加交换区空间</strong>，以便能够利用全部的四颗核心，否则可能会因为内存耗尽而挂起编译，打开<code>/etc/dphys-swapfile</code>文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/dphys-swapfile</span><br></pre></td></tr></table></figure>
<p>修改<code>CONF_SWAPSIZE</code>标识，我们将交换区从100M增加到2048M：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set size to absolute value, leaving empty (default) then uses computed value</span></span><br><span class="line"><span class="comment">#   you most likely don&#x27;t want this, unless you have an special disk situation</span></span><br><span class="line"><span class="comment"># CONF_SWAPSIZE=100</span></span><br><span class="line">CONF_SWAPSIZE=2048</span><br></pre></td></tr></table></figure>
<p>重启交换服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo /etc/init.d/dphys-swapfile stop</span><br><span class="line">sudo /etc/init.d/dphys-swapfile start</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：增加交换区空间有可能导致存储卡卡损坏，因为基于闪存的存储器的读写次数是有限的。我们这里仅在编译时增加交换区空间。</p>
<p><strong>编译</strong>，用<code>-j4</code>告诉<code>make</code>使用四颗核心，这是最耗时的一步，大约用了4-5小时：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j4</span><br></pre></td></tr></table></figure>

<p>安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo make install</span><br><span class="line">sudo ldconfig</span><br></pre></td></tr></table></figure>

<p><strong>恢复交换区空间</strong>，打开<code>/etc/dphys-swapfile</code>文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/dphys-swapfile</span><br></pre></td></tr></table></figure>
<p>恢复<code>CONF_SWAPSIZE=100</code>，并重启交换服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo /etc/init.d/dphys-swapfile stop</span><br><span class="line">sudo /etc/init.d/dphys-swapfile start</span><br></pre></td></tr></table></figure>

<h4 id="1-2-5-为Python虚拟环境建立OpenCV-4连接"><a href="#1-2-5-为Python虚拟环境建立OpenCV-4连接" class="headerlink" title="1.2.5 为Python虚拟环境建立OpenCV 4连接"></a>1.2.5 为Python虚拟环境建立OpenCV 4连接</h4><p>在我们的<code>tf</code>虚拟环境中建立OpenCV的软链接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/<span class="built_in">local</span>/lib/python3.7/site-packages/cv2/python-3.7/cv2.cpython-37m-arm-linux-gnueabihf.so /home/pi/cn_dect/tf/lib/python3.7/site-packages/cv2.so</span><br></pre></td></tr></table></figure>

<p>软链接的源和目的路径<strong>一定要写正确</strong>，其中源路径可以在安装时<code>sudo make install</code>命令的输出中看到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-- Installing: /usr/<span class="built_in">local</span>/lib/python3.7/site-packages/cv2/__init__.py</span><br><span class="line">-- Installing: /usr/<span class="built_in">local</span>/lib/python3.7/site-packages/cv2/load_config_py2.py</span><br><span class="line">-- Installing: /usr/<span class="built_in">local</span>/lib/python3.7/site-packages/cv2/load_config_py3.py</span><br><span class="line">-- Installing: /usr/<span class="built_in">local</span>/lib/python3.7/site-packages/cv2/config.py</span><br><span class="line">-- Installing: /usr/<span class="built_in">local</span>/lib/python3.7/site-packages/cv2/python-3.7/cv2.cpython-37m-arm-linux-gnueabihf.so</span><br><span class="line">-- Set runtime path of <span class="string">&quot;/usr/local/lib/python3.7/site-packages/cv2/python-3.7/cv2.cpython-37m-arm-linux-gnueabihf.so&quot;</span> to <span class="string">&quot;/usr/local/lib&quot;</span></span><br><span class="line">-- Installing: /usr/<span class="built_in">local</span>/lib/python3.7/site-packages/cv2/config-3.7.py</span><br></pre></td></tr></table></figure>

<h4 id="1-2-6-测试OpenCV"><a href="#1-2-6-测试OpenCV" class="headerlink" title="1.2.6 测试OpenCV"></a>1.2.6 测试OpenCV</h4><p>测试虚拟环境中的OpenCV：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Python 3.7.3 (default, Apr  3 2019, 05:39:12)</span><br><span class="line">[GCC 8.2.0] on linux</span><br><span class="line">Type <span class="string">&quot;help&quot;</span>, <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> or <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import cv2</span><br><span class="line">&gt;&gt;&gt; cv2.__version__</span><br><span class="line"><span class="string">&#x27;4.1.0&#x27;</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>成功。</p>
<h3 id="1-3-测试text-detection-ctpn"><a href="#1-3-测试text-detection-ctpn" class="headerlink" title="1.3 测试text-detection-ctpn"></a>1.3 测试text-detection-ctpn</h3><p>无奈的是ctpn训练好的模型很大，一加载TensorFlow就报错，只好再把swap区改成2048[捂脸]。不知道这么玩下去存储卡能撑多久……</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ./main/demo.py</span><br></pre></td></tr></table></figure>

<p>测试ctpn检测，还是比较慢的，第一张图在树莓派上就用了35秒。我准备再试试<a target="_blank" rel="noopener" href="https://github.com/chineseocr/chineseocr">chineseocr</a>这种端到端杂烩项目。</p>
<h2 id="2-OCR"><a href="#2-OCR" class="headerlink" title="2 OCR"></a>2 OCR</h2><p>大概扫了一眼<a target="_blank" rel="noopener" href="https://github.com/chineseocr/chineseocr">chineseocr</a>这个项目，估计是用yolo3/darknet做的文本检测，再用基于pytorch的crnn做检测到的文本的ocr。</p>
<h3 id="2-1-虚拟环境"><a href="#2-1-虚拟环境" class="headerlink" title="2.1 虚拟环境"></a>2.1 虚拟环境</h3><p>还是用原来的虚拟环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/cn_dect/tf</span><br><span class="line"><span class="built_in">source</span> ./bin/activate</span><br></pre></td></tr></table></figure>

<p>在虚拟环境中安装依赖（由于前面我们在本机上编译了OpenCV，所以不用再装opencv-contrib-python了）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install scipy numpy easydict Cython h5py lmdb mahotas pandas requests bs4 matplotlib lxml pillow web.py keras </span><br></pre></td></tr></table></figure>
<h3 id="2-2-编译-amp-配置darknet"><a href="#2-2-编译-amp-配置darknet" class="headerlink" title="2.2 编译 &amp; 配置darknet"></a>2.2 编译 &amp; 配置darknet</h3><p>下载项目和darknet：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 git <span class="built_in">clone</span> https://github.com/chineseocr/chineseocr.git</span><br><span class="line">proxychains4 git <span class="built_in">clone</span> https://github.com/pjreddie/darknet.git </span><br><span class="line">mv darknet chineseocr/</span><br></pre></td></tr></table></figure>
<p>修改<code>darknet/Makefile</code>：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">GPU</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">CUDNN</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">OPENCV</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">OPENMP</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>直接<code>make</code>时提示<code>PKG_CONFIG_PAT</code>中找不到<code>opencv.pc</code>，手动帮它找到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /usr/<span class="built_in">local</span>/lib/pkgconfig/opencv4.pc /usr/<span class="built_in">local</span>/lib/pkgconfig/opencv.pc</span><br><span class="line"><span class="built_in">export</span> PKG_CONFIG_PAT=/usr/<span class="built_in">local</span>/lib/pkgconfig</span><br></pre></td></tr></table></figure>

<p>编译过程出现<code>./src/image_opencv.cpp:12:1: error: ‘IplImage’ does not name a type</code>的错误，这是由于我们用的新版OpenCV导致的兼容性问题，此时需要<code>pull</code>一个<a target="_blank" rel="noopener" href="https://github.com/pjreddie/darknet/pull/1348">补丁</a>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git fetch origin pull/1348/head:opencv4</span><br><span class="line">git checkout opencv4</span><br><span class="line">make -j4</span><br></pre></td></tr></table></figure>

<p>把<code>darknet/python/darknet.py</code>第48行改成刚编译好的<code>libdarknet.so</code>的路径：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lib = CDLL(<span class="string">&quot;/home/pi/cn_dect/chineseocr/darknet/libdarknet.so&quot;</span>, RTLD_GLOBAL)</span><br></pre></td></tr></table></figure>

<h3 id="2-3-下载OCR模型"><a href="#2-3-下载OCR模型" class="headerlink" title="2.3 下载OCR模型"></a>2.3 下载OCR模型</h3><p>因为是<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1gTW9gwJR6hlwTuyB6nCkzQ">百度网盘上的东西</a>，我用bnd2加了个速。</p>
<p>将下载的所有文件放在<code>models</code>文件夹下。（如果是用<code>python -m http.server 8000</code>做临时中转，<code>wget -r http://192.168.1.100:8000</code>可以递归下载下所有目录和文件）</p>
<h3 id="2-4-安装PyTorch"><a href="#2-4-安装PyTorch" class="headerlink" title="2.4 安装PyTorch"></a>2.4 安装PyTorch</h3><p>安装系统依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y libopenblas-dev libblas-dev m4 cmake cython python3-dev python3-yaml python3-setuptools libatomic-ops-dev</span><br></pre></td></tr></table></figure>

<p>下载并安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir pytorch_install &amp;&amp; <span class="built_in">cd</span> pytorch_install</span><br><span class="line">proxychains4 git <span class="built_in">clone</span> --recursive https://github.com/pytorch/pytorch</span><br><span class="line"><span class="built_in">cd</span> pytorch</span><br><span class="line">git submodule sync</span><br><span class="line">git submodule update --init --recursive</span><br></pre></td></tr></table></figure>

<p>貌似<code>protobuf</code>这个库有个bug，会导致在编译近半时出现：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ 43%] Linking CXX executable ../../../bin/protoc</span><br><span class="line">/usr/bin/ld: ../../../lib/libprotobuf.a(arena.cc.o): <span class="keyword">in</span> <span class="keyword">function</span> `google::protobuf::internal::ArenaImpl::Init()<span class="string">&#x27;:</span></span><br><span class="line"><span class="string">arena.cc:(.text+0x24): undefined reference to `__atomic_fetch_add_8&#x27;</span></span><br></pre></td></tr></table></figure>
<p>需要更新一下<code>protobuf</code>修复bug：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 git submodule update --remote third_party/protobuf</span><br></pre></td></tr></table></figure>
<p>因为我试了好几次了，因此用<code>export BUILD_TEST=0</code>跳过测试以缩短编译时间，设置环境并编译：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> NO_CUDA=1</span><br><span class="line"><span class="built_in">export</span> NO_DISTRIBUTED=1</span><br><span class="line"><span class="built_in">export</span> NO_MKLDNN=1 </span><br><span class="line"><span class="built_in">export</span> NO_NNPACK=1</span><br><span class="line"><span class="built_in">export</span> NO_QNNPACK=1</span><br><span class="line"><span class="built_in">export</span> BUILD_TEST=0</span><br><span class="line"></span><br><span class="line">python3 setup.py build</span><br></pre></td></tr></table></figure>

<p>接下来正式安装，安装前需要注意的是，一定要记得带着上面的<code>export</code>的环境变量安装（因为编译时间太长，有时候编译完了重启就忘了设置环境变量）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 setup.py install</span><br></pre></td></tr></table></figure>

<p>小注意一下：如果安装完成后不切换工作目录直接试就会出现<code>No module named &#39;torch._C&#39;</code>的异常，因为编译目录下就有一个<code>torch</code>目录，切换工作目录再启动Python即可。</p>
<h3 id="2-5-安装CTC模型"><a href="#2-5-安装CTC模型" class="headerlink" title="2.5 安装CTC模型"></a>2.5 安装CTC模型</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip install wget</span><br><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/parlance/ctcdecode.git   </span><br><span class="line"><span class="built_in">cd</span> ctcdecode   </span><br><span class="line">pip install .</span><br></pre></td></tr></table></figure>
<p>其中<code>--recursive</code>指将引用的第三方git repo一并克隆。安装会持续个把小时，可以追几集番了。</p>
<h3 id="2-6-下载语言模型"><a href="#2-6-下载语言模型" class="headerlink" title="2.6 下载语言模型"></a>2.6 下载语言模型</h3><p>不到3个G，挂梯子下载了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> chineseocr/models/</span><br><span class="line">proxychains4 wget https://deepspeech.bj.bcebos.com/zh_lm/zh_giga.no_cna_cmn.prune01244.klm</span><br></pre></td></tr></table></figure>

<h3 id="2-7-运行"><a href="#2-7-运行" class="headerlink" title="2.7 运行"></a>2.7 运行</h3><p>按自己的情况修改<code>config.py</code>文件，运行<code>python app.py 8080</code>即可。在树莓派3B+上的结果是，内存耗尽[捂脸]总共不到1G的内存，连一个CTC模型都读不进去[捂脸]</p>
<p>更新到最新的<code>app</code>分支</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull origin app</span><br></pre></td></tr></table></figure>
<p>这下炸出了一个貌似是bug的问题……这个分支（git版本<code>daabebc93a8b4436a3653f83668429ab99eefaea</code>）跟以前最大的不同就是一开始就在用<code>keras</code>和<code>tensorflow</code>创建yolo3的<code>darknet</code>，结果在<code>text/keras_yolo3.py</code>的第285行<code>boxes  = concatenate(boxes, axis=0)</code>报错：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>boxes  = concatenate(boxes, axis=<span class="number">0</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/home/pi/cn_dect/tf/lib/python3.7/site-packages/tensorflow_core/python/keras/layers/merge.py&quot;</span>, line <span class="number">687</span>, <span class="keyword">in</span> concatenate</span><br><span class="line">    <span class="keyword">return</span> Concatenate(axis=axis, **kwargs)(inputs)</span><br><span class="line">  File <span class="string">&quot;/home/pi/cn_dect/tf/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/base_layer.py&quot;</span>, line <span class="number">630</span>, <span class="keyword">in</span> __call__</span><br><span class="line">    base_layer_utils.create_keras_history(inputs)</span><br><span class="line">  File <span class="string">&quot;/home/pi/cn_dect/tf/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/base_layer_utils.py&quot;</span>, line <span class="number">199</span>, <span class="keyword">in</span> create_keras_history</span><br><span class="line">    _, created_layers = _create_keras_history_helper(tensors, <span class="built_in">set</span>(), [])</span><br><span class="line">  File <span class="string">&quot;/home/pi/cn_dect/tf/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/base_layer_utils.py&quot;</span>, line <span class="number">245</span>, <span class="keyword">in</span> _create_keras_history_helper</span><br><span class="line">    layer_inputs, processed_ops, created_layers)</span><br><span class="line">  File <span class="string">&quot;/home/pi/cn_dect/tf/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/base_layer_utils.py&quot;</span>, line <span class="number">245</span>, <span class="keyword">in</span> _create_keras_history_helper</span><br><span class="line">    layer_inputs, processed_ops, created_layers)</span><br><span class="line">  File <span class="string">&quot;/home/pi/cn_dect/tf/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/base_layer_utils.py&quot;</span>, line <span class="number">245</span>, <span class="keyword">in</span> _create_keras_history_helper</span><br><span class="line">    layer_inputs, processed_ops, created_layers)</span><br><span class="line">  [Previous line repeated <span class="number">2</span> more times]</span><br><span class="line">  File <span class="string">&quot;/home/pi/cn_dect/tf/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/base_layer_utils.py&quot;</span>, line <span class="number">243</span>, <span class="keyword">in</span> _create_keras_history_helper</span><br><span class="line">    constants[i] = backend.function([], op_input)([])</span><br><span class="line">  File <span class="string">&quot;/home/pi/cn_dect/tf/lib/python3.7/site-packages/tensorflow_core/python/keras/backend.py&quot;</span>, line <span class="number">3349</span>, <span class="keyword">in</span> __call__</span><br><span class="line">    run_metadata=self.run_metadata)</span><br><span class="line">  File <span class="string">&quot;/home/pi/cn_dect/tf/lib/python3.7/site-packages/tensorflow_core/python/client/session.py&quot;</span>, line <span class="number">1450</span>, <span class="keyword">in</span> __call__</span><br><span class="line">    run_metadata_ptr)</span><br><span class="line">tensorflow.python.framework.errors_impl.InvalidArgumentError: You must feed a value <span class="keyword">for</span> placeholder tensor <span class="string">&#x27;Placeholder_367&#x27;</span> <span class="keyword">with</span> dtype <span class="built_in">float</span> <span class="keyword">and</span> shape [<span class="number">2</span>]</span><br><span class="line">         [[&#123;&#123;node Placeholder_367&#125;&#125;]]</span><br></pre></td></tr></table></figure>

<p>我目前的环境是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Python 3.7.3 (default, Apr  3 2019, 05:39:12)</span><br><span class="line">[GCC 8.2.0] on linux</span><br><span class="line"><span class="comment"># TensorFlow版本</span></span><br><span class="line">&gt;&gt;&gt; tf.__version__</span><br><span class="line"><span class="string">&#x27;1.13.1&#x27;</span></span><br><span class="line"><span class="comment"># keras版本</span></span><br><span class="line">&gt;&gt;&gt; K.__version__</span><br><span class="line"><span class="string">&#x27;2.2.5&#x27;</span></span><br></pre></td></tr></table></figure>
<p>一步一步的在REPL中调试，只要一<code>concatenate</code>，<code>Placeholder_367</code>就报错，这个Placeholder就是<code>text/keras_detect.py</code>中第23行就初始化了的那个<code>input_shape</code>。不知道为什么，我在我自己的电脑上试了，同样的代码，完全没有问题，咱也不懂不知道，咱也懒得在github上问[捂脸]</p>
<p>其中，环境上的不同在于，电脑用的Python 3.6，TensorFlow 1.14.0，Keras 2.2.4。打算重新写张存储卡用Python 3.6的整套环境在树莓派上试一下，毕竟这张卡上还有波达方向定位的程序呢（用了Python 3.7的协程新特性）。之所以没有用<code>chineseocr</code>项目要求的版本是因为树莓派上安装软件真的不容易[捂脸]</p>
<p>调试代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path.append(<span class="string">r&#x27;~/cn_dect/chineseocr&#x27;</span>)</span><br><span class="line"><span class="comment">#sys.path.append(r&#x27;~/PycharmProjects/chineseocr&#x27;)</span></span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> *</span><br><span class="line">os.environ[<span class="string">&quot;CUDA_VISIBLE_DEVICES&quot;</span>] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">scale,maxScale = IMGSIZE[<span class="number">0</span>],<span class="number">2048</span></span><br><span class="line"><span class="keyword">from</span> text.keras_yolo3 <span class="keyword">import</span> yolo_text,box_layer,K</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">graph = tf.get_default_graph()<span class="comment">##解决web.py 相关报错问题</span></span><br><span class="line"></span><br><span class="line">anchors = [<span class="built_in">float</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> keras_anchors.split(<span class="string">&#x27;,&#x27;</span>)]</span><br><span class="line">anchors = np.array(anchors).reshape(-<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">num_anchors = <span class="built_in">len</span>(anchors)</span><br><span class="line">num_classes = <span class="built_in">len</span>(class_names)</span><br><span class="line">K.clear_session()</span><br><span class="line">tf.reset_default_graph()</span><br><span class="line">textModel = yolo_text(num_classes,anchors)</span><br><span class="line">textModel.load_weights(kerasTextModel)</span><br><span class="line"><span class="comment">#textModel.load_weights(r&#x27;~/PycharmProjects/text.h5&#x27;)</span></span><br><span class="line">sess = K.get_session()</span><br><span class="line">image_shape = K.placeholder(shape=(<span class="number">2</span>, ))<span class="comment">##图像原尺寸:h,w</span></span><br><span class="line">input_shape = K.placeholder(shape=(<span class="number">2</span>, ))<span class="comment">##图像resize尺寸:h,w</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">y1,y2,y3 = [*textModel.output]</span><br><span class="line">out = [y1,y2,y3]</span><br><span class="line"></span><br><span class="line">num_layers = <span class="built_in">len</span>(out)</span><br><span class="line">anchor_mask = [[<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>], [<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>], [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>]]</span><br><span class="line">boxes = []</span><br><span class="line">scores =[]</span><br><span class="line">input_shape = K.cast(input_shape, tf.float32)</span><br><span class="line">image_shape = K.cast(image_shape, tf.float32)</span><br><span class="line"><span class="comment">#from keras.utils import plot_model</span></span><br><span class="line"><span class="comment">#plot_model(textModel, to_file=&#x27;model.png&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">yolo_head</span>(<span class="params">feats, anchors, num_classes, input_shape, calc_loss=<span class="literal">False</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Convert final layer features to bounding box parameters.&quot;&quot;&quot;</span></span><br><span class="line">    num_anchors = <span class="built_in">len</span>(anchors)</span><br><span class="line">    <span class="comment"># Reshape to batch, height, width, num_anchors, box_params.</span></span><br><span class="line">    anchors_tensor = K.reshape(K.constant(anchors), [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, num_anchors, <span class="number">2</span>])</span><br><span class="line">    </span><br><span class="line">    grid_shape = K.shape(feats)[<span class="number">1</span>:<span class="number">3</span>] <span class="comment"># height, width</span></span><br><span class="line">    grid_y =tf.tile(K.reshape(K.arange(<span class="number">0</span>, stop=grid_shape[<span class="number">0</span>]), [-<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]),</span><br><span class="line">        [<span class="number">1</span>, grid_shape[<span class="number">1</span>], <span class="number">1</span>, <span class="number">1</span>])</span><br><span class="line">    grid_x =tf.tile(K.reshape(K.arange(<span class="number">0</span>, stop=grid_shape[<span class="number">1</span>]), [<span class="number">1</span>, -<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]),</span><br><span class="line">        [grid_shape[<span class="number">0</span>], <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>])</span><br><span class="line">    grid = K.concatenate([grid_x, grid_y])</span><br><span class="line">    grid = K.cast(grid, K.dtype(feats))</span><br><span class="line">    </span><br><span class="line">    feats = K.reshape(</span><br><span class="line">        feats, [-<span class="number">1</span>, grid_shape[<span class="number">0</span>], grid_shape[<span class="number">1</span>], num_anchors, num_classes + <span class="number">5</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Adjust preditions to each spatial grid point and anchor size.</span></span><br><span class="line">    box_xy = (K.sigmoid(feats[..., :<span class="number">2</span>]) + grid) / K.cast(grid_shape[::-<span class="number">1</span>], K.dtype(feats))</span><br><span class="line">    box_wh = K.exp(feats[..., <span class="number">2</span>:<span class="number">4</span>]) * anchors_tensor / K.cast(input_shape[::-<span class="number">1</span>], K.dtype(feats))</span><br><span class="line">    box_confidence = K.sigmoid(feats[..., <span class="number">4</span>:<span class="number">5</span>])</span><br><span class="line">    box_class_probs = K.sigmoid(feats[..., <span class="number">5</span>:])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> calc_loss == <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">return</span> grid, feats, box_xy, box_wh</span><br><span class="line">    <span class="keyword">return</span> box_xy, box_wh, box_confidence, box_class_probs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> lay <span class="keyword">in</span> <span class="built_in">range</span>(num_layers):</span><br><span class="line">    box_xy, box_wh, box_confidence, box_class_probs = yolo_head(out[lay],anchors[anchor_mask[lay]], num_classes, input_shape)</span><br><span class="line">    <span class="comment">#box_xy = (box_xy - offset) * scale</span></span><br><span class="line">    <span class="comment">#box_wh = box_wh*scale</span></span><br><span class="line">    </span><br><span class="line">    box_score = box_confidence * box_class_probs</span><br><span class="line">    box_score = K.reshape(box_score, [-<span class="number">1</span>, num_classes])</span><br><span class="line">    </span><br><span class="line">    box_mins  = box_xy - (box_wh / <span class="number">2.</span>)</span><br><span class="line">    box_maxes = box_xy + (box_wh / <span class="number">2.</span>)</span><br><span class="line">    box =  K.concatenate([</span><br><span class="line">                    box_mins[..., <span class="number">0</span>:<span class="number">1</span>],  <span class="comment"># xmin</span></span><br><span class="line">                    box_mins[..., <span class="number">1</span>:<span class="number">2</span>],  <span class="comment"># ymin</span></span><br><span class="line">                    box_maxes[..., <span class="number">0</span>:<span class="number">1</span>], <span class="comment"># xmax</span></span><br><span class="line">                    box_maxes[..., <span class="number">1</span>:<span class="number">2</span>]  <span class="comment"># ymax</span></span><br><span class="line">                ],axis=-<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    box = K.reshape(box, [-<span class="number">1</span>, <span class="number">4</span>])</span><br><span class="line">    </span><br><span class="line">    boxes.append(box)</span><br><span class="line">    </span><br><span class="line">    scores.append(box_score)</span><br><span class="line"></span><br><span class="line">concatenate        = tf.keras.layers.concatenate</span><br><span class="line">boxes  = concatenate(boxes, axis=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h3 id="2-8-更换环境再试一遍"><a href="#2-8-更换环境再试一遍" class="headerlink" title="2.8 更换环境再试一遍"></a>2.8 更换环境再试一遍</h3><p>由于新的buster系统都是自带Python3.7，于是打算用<code>pipenv</code>创建Python3.6版本的环境：</p>
<ol>
<li>首先，pipenv在系统只有3.7版本的时候并不能直接创建3.6，所以我手动<code>sudo apt install python3.6</code>；</li>
<li>结果发现并不是那么回事，这时候再次<code>pipenv --python 3.6</code>会报错，大概是说<code>python3.6</code>的<code>distutils</code>找不到模块；</li>
<li>网上说可能是Linux自带的Python损坏，<code>sudo apt install python3-distutils</code>就好了，我试了一下，3.7确实是好了，3.6依然不行；</li>
<li>我打算用系统级Python多版本切换： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.6 1</span><br><span class="line">sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.7 2</span><br><span class="line">配置版本</span><br><span class="line">sudo update-alternatives --config python3</span><br><span class="line">或切换设置</span><br><span class="line">sudo update-alternatives --<span class="built_in">set</span> python3 /usr/bin/python3.6</span><br></pre></td></tr></table></figure>
 重新设3.6为系统默认Python，再执行<code>apt</code>或者<code>dpkg</code>安装说不定就安装到3.6下面去了，结果发现还是太天真了。<br> 试完了想把系统Python切换到Python3.6上，再运行<code>apt install python3-distutils</code>，结果并不可以。dist这个库安装完成后使用<code>dpkg -L python3-distutils</code>查看发现它已经在<code>/usr/lib/python3.7/distutils</code>文件夹下了，没法再装给Python3.6。被逼无奈只好强行把<code>dpkg</code>列出来的文件拷过去了，反正都是纯Python代码且发布无所谓小版本： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp -r /usr/lib/python3.7/distutils/* /usr/lib/python3.6/distutils/</span><br></pre></td></tr></table></figure></li>
<li>这下终于好了，运行<code>pipenv --python 3.6</code>报环境变量的错，按提示重新配置即可： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LC_ALL=C.UTF-8</span><br><span class="line"><span class="built_in">export</span> LANG=C.UTF-8</span><br></pre></td></tr></table></figure>
 在运行<code>pipenv</code>终于成功安装了Python 3.6的环境。</li>
</ol>
<p>装TensorFlow和Pytorch这两个大家伙，发现piwheel上没有现成的numpy[捂脸]<br>wget <a target="_blank" rel="noopener" href="https://github.com/lhelontra/tensorflow-on-arm/releases/download/v1.14.0-buster/tensorflow-1.14.0-cp37-none-linux_armv7l.whl">https://github.com/lhelontra/tensorflow-on-arm/releases/download/v1.14.0-buster/tensorflow-1.14.0-cp37-none-linux_armv7l.whl</a></p>
<h3 id="2-9-在macOS上再试一遍"><a href="#2-9-在macOS上再试一遍" class="headerlink" title="2.9 在macOS上再试一遍"></a>2.9 在macOS上再试一遍</h3><p>安装Xcode自不必说，然后同意许可，安装Apple Command Line Tools：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo xcodebuild -license</span><br><span class="line">sudo xcode-select --install</span><br></pre></td></tr></table></figure>

<p>接下来我用macports安装系统依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo port install cmake pkgconfig </span><br><span class="line">sudo port install jpeg libpng tiff openexr</span><br><span class="line">sudo port install eigen3 tbb</span><br></pre></td></tr></table></figure>

<p>下载OpenCV源码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 wget -O opencv.zip https://github.com/opencv/opencv/archive/4.1.1.zip</span><br><span class="line">proxychains4 wget -O opencv_contrib.zip https://github.com/opencv/opencv_contrib/archive/4.1.1.zip</span><br><span class="line">unzip opencv.zip</span><br><span class="line">unzip opencv_contrib.zip</span><br><span class="line">mv opencv-4.1.1 opencv</span><br><span class="line">mv opencv_contrib-4.1.1 opencv_contrib</span><br></pre></td></tr></table></figure>

<p>下面关于Python虚拟环境的路径，我都是用<code>conda</code>做的管理，所以跟<code>venv</code>、<code>virtualenv</code>、<code>pipenv</code>有所不同。准备执行<code>cmake</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> opencv</span><br><span class="line">mkdir build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line"></span><br><span class="line">cmake -D CMAKE_BUILD_TYPE=RELEASE \</span><br><span class="line">      -D CMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span> \</span><br><span class="line">      -D OPENCV_EXTRA_MODULES_PATH=~/PycharmProjects/opcv/opencv_contrib/modules \</span><br><span class="line">      -D PYTHON3_LIBRARY=`python -c <span class="string">&#x27;import subprocess; import sys; s = subprocess.check_output(&quot;python3-config --prefix&quot;, shell=True).decode(&quot;utf-8&quot;).strip(); m = subprocess.check_output(&quot;python3-config --abiflags&quot;, shell=True).decode(&quot;utf-8&quot;).strip(); (V, v) = sys.version_info[:2]; print(&quot;&#123;&#125;/lib/libpython&#123;&#125;.&#123;&#125;&#123;&#125;.dylib&quot;.format(s, V, v, m))&#x27;</span>` \</span><br><span class="line">      -D PYTHON3_INCLUDE_DIR=`python -c <span class="string">&#x27;import distutils.sysconfig as s; print(s.get_python_inc())&#x27;</span>` \</span><br><span class="line">      -D PYTHON3_EXECUTABLE=`python -c <span class="string">&#x27;import subprocess; print(subprocess.check_output(&quot;which python&quot;, shell=True).decode(&quot;utf-8&quot;).strip())&#x27;</span>` \</span><br><span class="line">      -D BUILD_opencv_python2=OFF \</span><br><span class="line">      -D BUILD_opencv_python3=ON \</span><br><span class="line">      -D INSTALL_PYTHON_EXAMPLES=ON \</span><br><span class="line">      -D INSTALL_C_EXAMPLES=OFF \</span><br><span class="line">      -D OPENCV_GENERATE_PKGCONFIG=ON \</span><br><span class="line">      -D OPENCV_ENABLE_NONFREE=ON \</span><br><span class="line">      -D BUILD_EXAMPLES=ON \</span><br><span class="line">      -D EIGEN_INCLUDE_PATH=/opt/<span class="built_in">local</span>/include/eigen3 ..</span><br></pre></td></tr></table></figure>

<p>编译并安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j4</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<p>完成安装后注意看安装日志，我们需要的文件位于<code>/usr/local/lib/python3.6/site-packages/cv2/python-3.6/cv2.cpython-36m-darwin.so</code>，为当前环境创造连接即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/<span class="built_in">local</span>/lib/python3.6/site-packages/cv2/python-3.6/cv2.cpython-36m-darwin.so /Users/&lt;user-name&gt;/anaconda3/envs/py36/lib/python3.6/site-packages/cv2.so</span><br></pre></td></tr></table></figure></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Python/">Python</a><a class="link-muted mr-2" rel="tag" href="/tags/Linux/">Linux</a><a class="link-muted mr-2" rel="tag" href="/tags/Raspberry-Pi/">Raspberry Pi</a><a class="link-muted mr-2" rel="tag" href="/tags/TensorFlow/">TensorFlow</a><a class="link-muted mr-2" rel="tag" href="/tags/ctpn/">ctpn</a></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><div class="social-share"></div><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechatpay.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/02/22/py-async-example/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Python中的协程使用举例</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/08/01/rbp3-doa-paper/"><span class="level-item">轻量级的用于开放或闭合麦阵列中的声源定位与追踪方法</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><script src="https://utteranc.es/client.js" repo="zlotus/comment" issue-term="pathname" label="some-issue-label" theme="github-light" crossorigin="anonymous" async></script></div></div></div><div class="column column-left is-3-tablet is-3-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/opm_sq.png" alt="子实"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">子实</p><p class="is-size-6 is-block">程序员</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>陕西/西安</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">79</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">23</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/zlotus" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/zlotus"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com/qinzishi"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/Zealot_uS"><i class="fab fa-twitter"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.zhihu.com/people/zlotus" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">知乎</span></span><span class="level-right"><span class="level-item tag">www.zhihu.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Diary/"><span class="level-start"><span class="level-item">Diary</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/"><span class="level-start"><span class="level-item">Programming</span></span><span class="level-end"><span class="level-item tag">65</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Shell/"><span class="level-start"><span class="level-item">Shell</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Coroutines/"><span class="tag">Coroutines</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaScript/"><span class="tag">JavaScript</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Javascript/"><span class="tag">Javascript</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">31</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenCV/"><span class="tag">OpenCV</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Operating-System/"><span class="tag">Operating System</span><span class="tag">21</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Paper/"><span class="tag">Paper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">18</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Raspberry-Pi/"><span class="tag">Raspberry Pi</span><span class="tag">20</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Rust/"><span class="tag">Rust</span><span class="tag">29</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Shell/"><span class="tag">Shell</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TensorFlow/"><span class="tag">TensorFlow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Tokio/"><span class="tag">Tokio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ZMQ/"><span class="tag">ZMQ</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ctpn/"><span class="tag">ctpn</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/llama/"><span class="tag">llama</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macOS/"><span class="tag">macOS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/obsidion/"><span class="tag">obsidion</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%A5%E8%AE%B0/"><span class="tag">日记</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E8%B0%88/"><span class="tag">杂谈</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%AE%97%E6%B3%95/"><span class="tag">算法</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BC%96%E7%A8%8B/"><span class="tag">编程</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%84%9A%E6%9C%AC/"><span class="tag">脚本</span><span class="tag">4</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/opm_sq.png" alt="子实" height="28"></a><p class="is-size-7"><span>&copy; 2024 子实</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>